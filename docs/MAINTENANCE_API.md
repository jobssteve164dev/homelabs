# ç³»ç»Ÿç»´æŠ¤ API æ–‡æ¡£

## æ¦‚è¿°

ç³»ç»Ÿç»´æŠ¤APIæä¾›äº†ä¸‰ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼šæ¸…ç†ç¼“å­˜ã€æ•°æ®å¤‡ä»½å’Œç³»ç»Ÿé‡å¯ã€‚æ‰€æœ‰æ“ä½œéƒ½éœ€è¦ç®¡ç†å‘˜æƒé™ã€‚

## API ç«¯ç‚¹

**POST** `/api/admin/maintenance`

### è®¤è¯è¦æ±‚

- éœ€è¦ç™»å½•ä¸”å…·æœ‰ `ADMIN` è§’è‰²
- ä½¿ç”¨ NextAuth session éªŒè¯

### è¯·æ±‚æ ¼å¼

```json
{
  "action": "clear-cache" | "backup" | "restart"
}
```

## åŠŸèƒ½è¯¦è§£

### 1. æ¸…ç†ç¼“å­˜ (clear-cache)

æ¸…ç† Next.js æ„å»ºç¼“å­˜ï¼Œé‡Šæ”¾ç£ç›˜ç©ºé—´ã€‚

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```json
{
  "action": "clear-cache"
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "message": "ç¼“å­˜æ¸…ç†æˆåŠŸ",
  "timestamp": "2025-10-19T12:00:00.000Z"
}
```

**æ“ä½œå†…å®¹ï¼š**
- åˆ é™¤ `.next/cache` ç›®å½•
- é‡æ–°åˆ›å»ºç©ºçš„ç¼“å­˜ç›®å½•
- ä¸å½±å“åº”ç”¨è¿è¡Œ

**é€‚ç”¨åœºæ™¯ï¼š**
- æ„å»ºç¼“å­˜æŸå
- ç£ç›˜ç©ºé—´ä¸è¶³
- å®šæœŸç»´æŠ¤

---

### 2. æ•°æ®å¤‡ä»½ (backup)

åˆ›å»ºå®Œæ•´çš„æ•°æ®åº“å¤‡ä»½ã€‚

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```json
{
  "action": "backup"
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "message": "æ•°æ®å¤‡ä»½æˆåŠŸ",
  "backupFile": "backup-2025-10-19T12-00-00-000Z.sql",
  "timestamp": "2025-10-19T12:00:00.000Z"
}
```

**æ“ä½œå†…å®¹ï¼š**
- ä½¿ç”¨ `pg_dump` åˆ›å»º PostgreSQL å¤‡ä»½ï¼ˆä¼˜å…ˆï¼‰
- å¦‚æœ `pg_dump` ä¸å¯ç”¨ï¼Œä½¿ç”¨ Prisma å¯¼å‡º JSON æ ¼å¼
- è‡ªåŠ¨ä¿ç•™æœ€è¿‘ 10 ä¸ªå¤‡ä»½æ–‡ä»¶
- å¤‡ä»½ä¿å­˜åœ¨ `backups/` ç›®å½•

**å¤‡ä»½ç­–ç•¥ï¼š**
- **ä¸»è¦æ–¹å¼**: PostgreSQL äºŒè¿›åˆ¶æ ¼å¼ (`.sql`)
- **å¤‡ç”¨æ–¹å¼**: JSON æ ¼å¼ (`.json`)
- **è‡ªåŠ¨æ¸…ç†**: è¶…è¿‡ 10 ä¸ªå¤‡ä»½æ—¶åˆ é™¤æ—§æ–‡ä»¶
- **å‘½åæ ¼å¼**: `backup-{ISOæ—¶é—´æˆ³}.sql`

**é€‚ç”¨åœºæ™¯ï¼š**
- é‡å¤§æ›´æ–°å‰
- å®šæœŸæ•°æ®ä¿æŠ¤
- ç³»ç»Ÿè¿ç§»å‰

---

### 3. ç³»ç»Ÿé‡å¯ (restart)

é‡å¯åº”ç”¨æœåŠ¡ã€‚

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```json
{
  "action": "restart"
}
```

**å¼€å‘ç¯å¢ƒå“åº”ï¼š**
```json
{
  "success": true,
  "message": "å¼€å‘ç¯å¢ƒï¼šç³»ç»Ÿé‡å¯è¯·æ±‚å·²è®°å½•",
  "note": "åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œè¯·æ‰‹åŠ¨é‡å¯æœåŠ¡å™¨",
  "timestamp": "2025-10-19T12:00:00.000Z"
}
```

**ç”Ÿäº§ç¯å¢ƒå“åº”ï¼š**
```json
{
  "success": true,
  "message": "ç³»ç»Ÿé‡å¯æŒ‡ä»¤å·²å‘é€ï¼ŒæœåŠ¡å°†åœ¨3ç§’åé‡å¯",
  "timestamp": "2025-10-19T12:00:00.000Z"
}
```

**æ“ä½œå†…å®¹ï¼š**
- **å¼€å‘ç¯å¢ƒ**: ä»…è®°å½•æ—¥å¿—ï¼Œéœ€è¦æ‰‹åŠ¨é‡å¯
- **ç”Ÿäº§ç¯å¢ƒ**: 3ç§’åæ‰§è¡Œ `process.exit(0)`ï¼Œç”±è¿›ç¨‹ç®¡ç†å™¨è‡ªåŠ¨é‡å¯

**æ³¨æ„äº‹é¡¹ï¼š**
- âš ï¸ ä¼šå¯¼è‡´æœåŠ¡çŸ­æš‚ä¸­æ–­
- âš ï¸ æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ä¼šæš‚æ—¶æ–­å¼€è¿æ¥
- ğŸ“… å»ºè®®åœ¨ä½å³°æ—¶æ®µæ‰§è¡Œ
- ğŸ”„ ä¾èµ–è¿›ç¨‹ç®¡ç†å™¨ï¼ˆå¦‚ PM2ï¼‰è‡ªåŠ¨é‡å¯

**é€‚ç”¨åœºæ™¯ï¼š**
- åº”ç”¨é…ç½®æ›´æ–°å
- å†…å­˜æ³„æ¼é—®é¢˜
- ç´§æ€¥æ•…éšœæ¢å¤

---

## é”™è¯¯å¤„ç†

### æƒé™é”™è¯¯ (403)
```json
{
  "error": "æƒé™ä¸è¶³"
}
```

### æ— æ•ˆæ“ä½œ (400)
```json
{
  "error": "æ— æ•ˆçš„æ“ä½œç±»å‹"
}
```

### æœåŠ¡å™¨é”™è¯¯ (500)
```json
{
  "error": "æ“ä½œå¤±è´¥",
  "details": "å…·ä½“é”™è¯¯ä¿¡æ¯"
}
```

---

## å®‰å…¨æ³¨æ„äº‹é¡¹

1. **æƒé™æ§åˆ¶**: æ‰€æœ‰æ“ä½œéƒ½éœ€è¦ ADMIN æƒé™
2. **æ“ä½œç¡®è®¤**: å‰ç«¯å¿…é¡»å®ç°äºŒæ¬¡ç¡®è®¤æœºåˆ¶
3. **æ—¥å¿—è®°å½•**: æ‰€æœ‰æ“ä½œéƒ½ä¼šè®°å½•åˆ°æœåŠ¡å™¨æ—¥å¿—
4. **å¤‡ä»½å®‰å…¨**: å¤‡ä»½æ–‡ä»¶åŒ…å«æ•æ„Ÿæ•°æ®ï¼Œå­˜å‚¨ä½ç½®åº”å—ä¿æŠ¤
5. **é‡å¯é£é™©**: ç³»ç»Ÿé‡å¯ä¼šå½±å“æ‰€æœ‰ç”¨æˆ·ï¼Œåº”è°¨æ…ä½¿ç”¨

---

## ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯è°ƒç”¨ç¤ºä¾‹

```typescript
// æ¸…ç†ç¼“å­˜
const clearCache = async () => {
  const response = await fetch('/api/admin/maintenance', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'clear-cache' })
  });
  const data = await response.json();
  console.log(data.message);
};

// å¤‡ä»½æ•°æ®
const backupData = async () => {
  const response = await fetch('/api/admin/maintenance', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'backup' })
  });
  const data = await response.json();
  console.log(`å¤‡ä»½æ–‡ä»¶: ${data.backupFile}`);
};

// ç³»ç»Ÿé‡å¯
const restartSystem = async () => {
  const response = await fetch('/api/admin/maintenance', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'restart' })
  });
  const data = await response.json();
  console.log(data.message);
};
```

---

## ç¯å¢ƒé…ç½®

### æ•°æ®åº“å¤‡ä»½é…ç½®

éœ€è¦ç¡®ä¿ `DATABASE_URL` ç¯å¢ƒå˜é‡å·²æ­£ç¡®é…ç½®ï¼š

```env
DATABASE_URL="postgresql://user:password@host:port/database"
```

### ç”Ÿäº§ç¯å¢ƒè¿›ç¨‹ç®¡ç†

ä½¿ç”¨ PM2 æˆ–ç±»ä¼¼å·¥å…·ç®¡ç†è¿›ç¨‹ï¼Œç¡®ä¿è‡ªåŠ¨é‡å¯åŠŸèƒ½ï¼š

```bash
# PM2 é…ç½®ç¤ºä¾‹
pm2 start npm --name "homelabs" -- start
pm2 startup
pm2 save
```

---

## ç»´æŠ¤å»ºè®®

1. **å®šæœŸå¤‡ä»½**: å»ºè®®æ¯å¤©æ‰§è¡Œä¸€æ¬¡æ•°æ®å¤‡ä»½
2. **æ¸…ç†ç¼“å­˜**: æ„å»ºé—®é¢˜æ—¶é¦–å…ˆå°è¯•æ¸…ç†ç¼“å­˜
3. **è°¨æ…é‡å¯**: é‡å¯å‰ç¡®è®¤æ²¡æœ‰é‡è¦æ“ä½œæ­£åœ¨è¿›è¡Œ
4. **ç›‘æ§æ—¥å¿—**: å…³æ³¨ç»´æŠ¤æ“ä½œçš„æ—¥å¿—è¾“å‡º
5. **å¤‡ä»½ä¿ç•™**: æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´å¤‡ä»½ä¿ç•™æ•°é‡

---

## æ•…éšœæ’æŸ¥

### å¤‡ä»½å¤±è´¥
- æ£€æŸ¥ `DATABASE_URL` é…ç½®
- ç¡®è®¤æ•°æ®åº“è¿æ¥æ­£å¸¸
- éªŒè¯æ–‡ä»¶ç³»ç»Ÿå†™å…¥æƒé™
- æŸ¥çœ‹ `pg_dump` æ˜¯å¦å®‰è£…

### é‡å¯å¤±è´¥
- æ£€æŸ¥è¿›ç¨‹ç®¡ç†å™¨é…ç½®
- éªŒè¯åº”ç”¨è¿›ç¨‹çŠ¶æ€
- æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—

### æƒé™é”™è¯¯
- ç¡®è®¤ç”¨æˆ·å·²ç™»å½•
- éªŒè¯ç”¨æˆ·è§’è‰²ä¸º ADMIN
- æ£€æŸ¥ session çŠ¶æ€

