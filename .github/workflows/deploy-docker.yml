
name: Dockerç¯å¢ƒéƒ¨ç½²

on:
  # ç›‘æ§ changelog.md æ–‡ä»¶å˜æ›´ï¼Œè‡ªåŠ¨è§¦å‘éƒ¨ç½²
  push:
    branches:
      - main
    paths:
      - 'changelog.md'
  
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘æ–¹å¼
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: 'éƒ¨ç½²æ¨¡å¼'
        required: true
        default: 'all'
        type: choice
        options:
          - all          # å…¨éƒ¨éƒ¨ç½²
          - app-only     # ä»…åº”ç”¨
          - check        # ä»…æ£€æŸ¥ç¯å¢ƒ

jobs:
  deploy-docker:
    runs-on: ubuntu-latest
    
    steps:
    - name: è®¾ç½®é»˜è®¤éƒ¨ç½²æ¨¡å¼
      id: set_deploy_mode
      run: |
        # å½“é€šè¿‡pushäº‹ä»¶ï¼ˆchangelogå˜æ›´ï¼‰è§¦å‘æ—¶ï¼Œä½¿ç”¨allæ¨¡å¼
        # å½“æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„æ¨¡å¼
        if [ -z "${{ inputs.deploy_mode }}" ]; then
          echo "DEPLOY_MODE=all" >> $GITHUB_ENV
          echo "ğŸ“ è‡ªåŠ¨è§¦å‘éƒ¨ç½²ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å¼: all"
        else
          echo "DEPLOY_MODE=${{ inputs.deploy_mode }}" >> $GITHUB_ENV
          echo "ğŸ“ æ‰‹åŠ¨è§¦å‘éƒ¨ç½²ï¼Œä½¿ç”¨é€‰æ‹©æ¨¡å¼: ${{ inputs.deploy_mode }}"
        fi
    
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®æœåŠ¡å™¨é…ç½®
      id: server_config
      run: |
        # è·å–éƒ¨ç½²ç¯å¢ƒ
        DEPLOY_ENVIRONMENT="${{ vars.DEPLOY_ENVIRONMENT || secrets.DEPLOY_ENVIRONMENT || 'local' }}"
        echo "DEPLOY_ENVIRONMENT=$DEPLOY_ENVIRONMENT" >> $GITHUB_ENV
        
        # æ ¹æ®ç¯å¢ƒé€‰æ‹©æœåŠ¡å™¨é…ç½®
        if [ "$DEPLOY_ENVIRONMENT" = "production" ]; then
          echo "ğŸ­ ä½¿ç”¨ç”Ÿäº§æœåŠ¡å™¨é…ç½®"
          SERVER_HOST="${{ vars.SERVER_HOST_PROD || secrets.SERVER_HOST_PROD || vars.SERVER_HOST || secrets.SERVER_HOST }}"
          SSH_PORT="${{ vars.SSH_PORT_PROD || secrets.SSH_PORT_PROD || vars.SSH_PORT || secrets.SSH_PORT || '22' }}"
          SSH_USER="${{ vars.SSH_USER_PROD || secrets.SSH_USER_PROD || vars.SSH_USER || secrets.SSH_USER }}"
          DEPLOY_PATH="${{ vars.DEPLOY_PATH_PROD || secrets.DEPLOY_PATH_PROD || vars.DEPLOY_PATH || secrets.DEPLOY_PATH || '/opt/homelabs' }}"
        else
          echo "ğŸ  ä½¿ç”¨æµ‹è¯•æœåŠ¡å™¨é…ç½®ï¼ˆHomelabï¼‰"
          SERVER_HOST="${{ vars.SERVER_HOST || secrets.SERVER_HOST }}"
          SSH_PORT="${{ vars.SSH_PORT || secrets.SSH_PORT || '22' }}"
          SSH_USER="${{ vars.SSH_USER || secrets.SSH_USER }}"
          DEPLOY_PATH="${{ vars.DEPLOY_PATH || secrets.DEPLOY_PATH || '/opt/homelabs' }}"
        fi
        
        # è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå•è¡Œå˜é‡ï¼‰
        echo "SERVER_HOST=$SERVER_HOST" >> $GITHUB_ENV
        echo "SSH_PORT=$SSH_PORT" >> $GITHUB_ENV
        echo "SSH_USER=$SSH_USER" >> $GITHUB_ENV
        echo "DEPLOY_PATH=$DEPLOY_PATH" >> $GITHUB_ENV
        
        echo ""
        echo "ğŸ“‹ æœåŠ¡å™¨é…ç½®:"
        echo "  ç¯å¢ƒ: $DEPLOY_ENVIRONMENT"
        echo "  ä¸»æœº: $SERVER_HOST"
        echo "  ç«¯å£: $SSH_PORT"
        echo "  ç”¨æˆ·: $SSH_USER"
        echo "  è·¯å¾„: $DEPLOY_PATH"
    
    - name: è®¾ç½®SSHå¯†é’¥
      id: set_ssh_key
      run: |
        DEPLOY_ENVIRONMENT="${{ vars.DEPLOY_ENVIRONMENT || secrets.DEPLOY_ENVIRONMENT || 'local' }}"
        if [ "$DEPLOY_ENVIRONMENT" = "production" ]; then
          echo "ä½¿ç”¨ç”Ÿäº§æœåŠ¡å™¨SSHå¯†é’¥"
          SSH_KEY_CONTENT="${{ secrets.SERVER_SSH_KEY_PROD || secrets.SERVER_SSH_KEY }}"
        else
          echo "ä½¿ç”¨æµ‹è¯•æœåŠ¡å™¨SSHå¯†é’¥"
          SSH_KEY_CONTENT="${{ secrets.SERVER_SSH_KEY }}"
        fi
        # ä½¿ç”¨å¤šè¡Œæ ¼å¼è®¾ç½®ç¯å¢ƒå˜é‡
        {
          echo "SSH_KEY_CONTENT<<EOF"
          echo "$SSH_KEY_CONTENT"
          echo "EOF"
        } >> $GITHUB_ENV
    
    - name: é…ç½®SSH Agent
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ env.SSH_KEY_CONTENT }}
        ssh-auth-sock: ${{ github.workspace }}/ssh-auth.sock
    
    - name: æ£€æŸ¥å¹¶å®‰è£…Dockerç¯å¢ƒ
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "æ£€æŸ¥å¹¶å‡†å¤‡Dockerç¯å¢ƒ..."
        echo "==================================="
        echo ""
        
        # æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹
        echo "æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹..."
        OS_TYPE=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          if [ -f /etc/os-release ]; then
            . /etc/os-release
            echo \$ID
          elif [ -f /etc/redhat-release ]; then
            echo 'rhel'
          else
            echo 'unknown'
          fi
        ")
        echo "ğŸ“‹ æ£€æµ‹åˆ°æ“ä½œç³»ç»Ÿ: $OS_TYPE"
        echo ""
        
        # ========================================
        # 1. æ£€æŸ¥å¹¶å®‰è£… Docker
        # ========================================
        echo "-----------------------------------"
        echo "1ï¸âƒ£  æ£€æŸ¥ Docker..."
        echo "-----------------------------------"
        if ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "command -v docker &> /dev/null"; then
          DOCKER_VERSION=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "docker --version" 2>/dev/null || echo "unknown")
          echo "âœ… Dockerå·²å®‰è£…: $DOCKER_VERSION"
        else
          echo "ğŸ“¦ Dockeræœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
          
          if [ "$OS_TYPE" = "ubuntu" ] || [ "$OS_TYPE" = "debian" ]; then
            echo "ä½¿ç”¨aptå®‰è£…Docker..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
              sudo apt-get update
              sudo apt-get install -y ca-certificates curl gnupg lsb-release
              sudo mkdir -p /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              sudo apt-get update
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
              sudo usermod -aG docker $USER
              docker --version
            '
          elif [ "$OS_TYPE" = "centos" ] || [ "$OS_TYPE" = "rhel" ] || [ "$OS_TYPE" = "amzn" ]; then
            echo "ä½¿ç”¨yumå®‰è£…Docker..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
              sudo yum install -y yum-utils
              sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
              sudo yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -aG docker $USER
              docker --version
            '
          else
            echo "âŒ ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: $OS_TYPE"
            echo "è¯·æ‰‹åŠ¨å®‰è£…Docker: https://docs.docker.com/get-docker/"
            exit 1
          fi
          
          echo "âœ… Dockerå®‰è£…å®Œæˆ"
        fi
        
        # ç¡®ä¿DockeræœåŠ¡æ­£åœ¨è¿è¡Œ
        echo "æ£€æŸ¥DockeræœåŠ¡çŠ¶æ€..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          if ! sudo systemctl is-active --quiet docker; then
            echo 'å¯åŠ¨DockeræœåŠ¡...'
            sudo systemctl start docker
            sudo systemctl enable docker
            sleep 3
          fi
          sudo systemctl status docker | head -5
        "
        echo ""
        
        # ========================================
        # 2. æ£€æŸ¥å¹¶å®‰è£… Docker Compose
        # ========================================
        echo "-----------------------------------"
        echo "2ï¸âƒ£  æ£€æŸ¥ Docker Compose..."
        echo "-----------------------------------"
        if ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "command -v docker-compose &> /dev/null || docker compose version &> /dev/null"; then
          if ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "docker compose version &> /dev/null"; then
            COMPOSE_VERSION=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "docker compose version" 2>/dev/null || echo "unknown")
            echo "âœ… Docker Composeå·²å®‰è£…: $COMPOSE_VERSION"
          else
            COMPOSE_VERSION=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "docker-compose --version" 2>/dev/null || echo "unknown")
            echo "âœ… Docker Composeå·²å®‰è£…: $COMPOSE_VERSION"
          fi
        else
          echo "ğŸ“¦ Docker Composeæœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
          
          if [ "$OS_TYPE" = "ubuntu" ] || [ "$OS_TYPE" = "debian" ]; then
            echo "Docker Composeé€šå¸¸å·²åŒ…å«åœ¨docker-compose-pluginä¸­..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
              sudo apt-get update
              sudo apt-get install -y docker-compose-plugin
              docker compose version
            '
          elif [ "$OS_TYPE" = "centos" ] || [ "$OS_TYPE" = "rhel" ] || [ "$OS_TYPE" = "amzn" ]; then
            echo "Docker Composeé€šå¸¸å·²åŒ…å«åœ¨docker-compose-pluginä¸­..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
              sudo yum install -y docker-compose-plugin
              docker compose version
            '
          else
            echo "âš ï¸  è¯·æ‰‹åŠ¨å®‰è£…Docker Compose"
            exit 1
          fi
          
          echo "âœ… Docker Composeå®‰è£…å®Œæˆ"
        fi
        echo ""
        
        # ========================================
        # 3. æ£€æŸ¥å¹¶å®‰è£…jq
        # ========================================
        echo "-----------------------------------"
        echo "3ï¸âƒ£  æ£€æŸ¥å¹¶å®‰è£…jq..."
        echo "-----------------------------------"
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          if ! command -v jq &> /dev/null; then
            echo "ğŸ“¦ jqæœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
            if command -v apt-get &> /dev/null; then
              sudo apt-get update -y && sudo apt-get install -y jq
            elif command -v yum &> /dev/null; then
              sudo yum install -y jq
            else
              echo "âš ï¸ æ— æ³•è‡ªåŠ¨å®‰è£…jqï¼Œè¯·æ‰‹åŠ¨å®‰è£…"
              exit 1
            fi
            echo "âœ… jqå®‰è£…å®Œæˆ"
          else
            echo "âœ… jqå·²å®‰è£…"
          fi
        '
        echo ""
        
        # ========================================
        # 4. æœ€ç»ˆéªŒè¯
        # ========================================
        echo "==================================="
        echo "ğŸ“Š Dockerç¯å¢ƒæœ€ç»ˆéªŒè¯"
        echo "==================================="
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} <<'ENV_VERIFY'
          echo 'âœ… Dockerç‰ˆæœ¬:'
          docker --version
          
          echo 'âœ… Docker Composeç‰ˆæœ¬:'
          docker compose version 2>/dev/null || docker-compose --version
          
          echo 'âœ… DockeræœåŠ¡:'
          sudo systemctl is-active docker && echo 'Dockerè¿è¡Œä¸­' || echo 'Dockeræœªè¿è¡Œ'
          
          echo 'âœ… Dockerç”¨æˆ·ç»„:'
          groups | grep -q docker && echo 'å½“å‰ç”¨æˆ·åœ¨dockerç»„ä¸­' || echo 'âš ï¸ å½“å‰ç”¨æˆ·ä¸åœ¨dockerç»„ä¸­ï¼Œå¯èƒ½éœ€è¦é‡æ–°ç™»å½•'
        ENV_VERIFY
        
        echo ""
        echo "==================================="
        echo "âœ… Dockerç¯å¢ƒå‡†å¤‡å®Œæˆï¼"
        echo "==================================="
    
    # ========================================
    # Nginxè‡ªåŠ¨é…ç½®æ­¥éª¤ï¼ˆDockeræ¨¡å¼ï¼‰
    # ========================================
    
    - name: ğŸ“ ç”ŸæˆDocker Composeé…ç½®æ–‡ä»¶
      if: env.DEPLOY_MODE == 'all'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
        DEPLOY_ENVIRONMENT: ${{ vars.DEPLOY_ENVIRONMENT || secrets.DEPLOY_ENVIRONMENT || 'local' }}
        PRIMARY_DOMAIN: ${{ vars.PRIMARY_DOMAIN || secrets.PRIMARY_DOMAIN || 'localhost' }}
        ADDITIONAL_DOMAINS: ${{ vars.ADDITIONAL_DOMAINS || secrets.ADDITIONAL_DOMAINS || '' }}
        USE_SSL: ${{ vars.USE_SSL || secrets.USE_SSL || 'false' }}
        NGINX_PORT: ${{ vars.NGINX_PORT || secrets.NGINX_PORT || '80' }}
        NGINX_SSL_PORT: ${{ vars.NGINX_SSL_PORT || secrets.NGINX_SSL_PORT || '443' }}
        BEHIND_PROXY: ${{ vars.BEHIND_PROXY || secrets.BEHIND_PROXY || 'false' }}
        PROXY_REAL_IP_FROM: ${{ vars.PROXY_REAL_IP_FROM || secrets.PROXY_REAL_IP_FROM || '192.168.0.0/16' }}
        APP_PORT: ${{ vars.APP_PORT || secrets.APP_PORT || '3000' }}
        POSTGRES_DB: ${{ vars.POSTGRES_DB || secrets.POSTGRES_DB || 'homelabs_portal' }}
        POSTGRES_USER: ${{ vars.POSTGRES_USER || secrets.POSTGRES_USER || 'homelabs' }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        POSTGRES_HOST_PORT: ${{ vars.POSTGRES_HOST_PORT || secrets.POSTGRES_HOST_PORT || '15432' }}
        REDIS_HOST_PORT: ${{ vars.REDIS_HOST_PORT || secrets.REDIS_HOST_PORT || '16379' }}
        NEXTAUTH_URL: ${{ vars.NEXTAUTH_URL || secrets.NEXTAUTH_URL }}
        NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        APP_URL: ${{ vars.APP_URL || secrets.APP_URL }}
        LOG_LEVEL: ${{ vars.LOG_LEVEL || secrets.LOG_LEVEL || 'info' }}
      run: |
        # ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
        chmod +x .github/scripts/generate-docker-config.sh
        
        # è¿è¡Œè„šæœ¬ç”Ÿæˆé…ç½®æ–‡ä»¶
        echo "è¿è¡Œé…ç½®ç”Ÿæˆè„šæœ¬..."
        ./.github/scripts/generate-docker-config.sh .
        
        # éªŒè¯æ–‡ä»¶æ˜¯å¦ç”ŸæˆæˆåŠŸ
        echo "éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶..."
        if [ ! -f "docker-compose-auto.yml" ]; then
          echo "âŒ é”™è¯¯: docker-compose-auto.yml æ–‡ä»¶æœªç”Ÿæˆï¼"
          ls -la . | grep -E "(docker|compose)" || echo "å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
          ls -la .
          exit 1
        fi
        
        if [ ! -f "docker/nginx-auto.conf" ]; then
          echo "âŒ é”™è¯¯: docker/nginx-auto.conf æ–‡ä»¶æœªç”Ÿæˆï¼"
          ls -la docker/ 2>/dev/null || echo "docker ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "âœ… é…ç½®æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
        echo "æ–‡ä»¶åˆ—è¡¨:"
        ls -lh docker-compose-auto.yml docker/nginx-auto.conf
    
    - name: å¤‡ä»½å½“å‰ç‰ˆæœ¬
      if: env.DEPLOY_MODE != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
        echo "==================================="
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          BACKUP_DIR=${{ env.DEPLOY_PATH }}_backup_\$(date +%Y%m%d_%H%M%S)
          
          if [ -d ${{ env.DEPLOY_PATH }} ]; then
            echo 'ğŸ“¦ åˆ›å»ºå¤‡ä»½: '\$BACKUP_DIR
            
            # ä½¿ç”¨sudoåˆ›å»ºå¤‡ä»½ç›®å½•å¹¶è®¾ç½®æƒé™
            echo 'ğŸ” åˆ›å»ºå¤‡ä»½ç›®å½•ï¼ˆéœ€è¦sudoæƒé™ï¼‰...'
            sudo mkdir -p \$BACKUP_DIR
            sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} \$BACKUP_DIR
            
            # ä½¿ç”¨rsyncå¤‡ä»½ï¼ˆæ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼‰
            echo 'ğŸ”„ å¼€å§‹å¤‡ä»½...'
            rsync -aL \
              --exclude 'node_modules' \
              --exclude '.next' \
              --exclude 'logs' \
              --exclude '*.log' \
              --exclude '.git' \
              --exclude 'docker/ssl' \
              ${{ env.DEPLOY_PATH }}/ \$BACKUP_DIR/ || {
              echo 'âŒ å¤‡ä»½å¤±è´¥ï¼'
              sudo rm -rf \$BACKUP_DIR
              exit 1
            }
            
            # éªŒè¯å¤‡ä»½
            if [ -d \$BACKUP_DIR ] && [ \"\$(ls -A \$BACKUP_DIR 2>/dev/null)\" ]; then
              echo 'âœ… å¤‡ä»½éªŒè¯æˆåŠŸ'
              
              # ä¿ç•™æœ€è¿‘3ä¸ªå¤‡ä»½ï¼ˆæ¸…ç†æ—§å¤‡ä»½éœ€è¦sudoï¼‰
              echo 'ğŸ§¹ æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...'
              cd \$(dirname ${{ env.DEPLOY_PATH }})
              OLD_BACKUPS=\$(ls -dt ${{ env.DEPLOY_PATH }}_backup_* 2>/dev/null | tail -n +4)
              if [ -n "\$OLD_BACKUPS" ]; then
                BACKUP_COUNT=\$(echo "\$OLD_BACKUPS" | wc -l)
                echo "\$OLD_BACKUPS" | xargs sudo rm -rf
                echo "   å·²æ¸…ç† \$BACKUP_COUNT ä¸ªæ—§å¤‡ä»½"
              else
                echo "   æ— éœ€æ¸…ç†æ—§å¤‡ä»½"
              fi
              
              # è®°å½•å¤‡ä»½è·¯å¾„
              echo \$BACKUP_DIR > /tmp/homelabs_last_backup
              echo 'âœ… å¤‡ä»½å®Œæˆ'
            else
              echo 'âŒ å¤‡ä»½éªŒè¯å¤±è´¥ï¼'
              exit 1
            fi
          else
            echo 'âš ï¸  é¦–æ¬¡éƒ¨ç½²ï¼Œæ— éœ€å¤‡ä»½'
          fi
        "
    
    - name: åœæ­¢ç°æœ‰æœåŠ¡å¹¶æ¸…ç†
      if: env.DEPLOY_MODE != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "åœæ­¢ç°æœ‰DockeræœåŠ¡å¹¶æ¸…ç†ç¯å¢ƒ..."
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          if [ -d ${{ env.DEPLOY_PATH }} ]; then
            cd ${{ env.DEPLOY_PATH }}
            
            echo '1ï¸âƒ£  åœæ­¢å½“å‰é¡¹ç›®çš„Dockerå®¹å™¨...'
            # åªåœæ­¢å½“å‰é¡¹ç›®çš„å®¹å™¨ï¼ˆå¦‚æœdocker-compose.ymlå­˜åœ¨ï¼‰
            if [ -f docker-compose.yml ]; then
              # ä½¿ç”¨é¡¹ç›®åç§°æ¥ç²¾ç¡®åœæ­¢ï¼Œé¿å…å½±å“å…¶ä»–æœåŠ¡
              # docker-compose é»˜è®¤ä½¿ç”¨ç›®å½•åä½œä¸ºé¡¹ç›®åç§°
              docker compose down 2>/dev/null || docker-compose down 2>/dev/null || true
              echo '   âœ… å½“å‰é¡¹ç›®å®¹å™¨å·²åœæ­¢'
            else
              echo '   â„¹ï¸  æœªæ‰¾åˆ°docker-compose.ymlï¼Œè·³è¿‡å®¹å™¨åœæ­¢'
            fi
            
            echo '2ï¸âƒ£  æ¸…ç†å½“å‰é¡¹ç›®çš„æœªä½¿ç”¨èµ„æº...'
            # åªæ¸…ç†å½“å‰é¡¹ç›®çš„é•œåƒï¼Œä¸å½±å“å…¶ä»–æœåŠ¡
            if [ -f docker-compose.yml ]; then
              # åªåˆ é™¤æ˜ç¡®å±äºå½“å‰é¡¹ç›®çš„æ—§é•œåƒï¼ˆé€šè¿‡é•œåƒåç§°åŒ¹é…ï¼‰
              # æŸ¥æ‰¾ homelabs ç›¸å…³çš„é•œåƒï¼ˆé€šè¿‡åç§°è¿‡æ»¤ï¼Œé¿å…å½±å“å…¶ä»–æœåŠ¡ï¼‰
              HOMELABS_IMAGES=\$(docker images --format '{{.Repository}}:{{.Tag}} {{.ID}}' | grep -E 'homelabs|localhost.*homelabs' | awk '{print \$2}' | sort -u 2>/dev/null || true)
              if [ -n \"\$HOMELABS_IMAGES\" ]; then
                # åªåˆ é™¤æœªè¢«ä»»ä½•å®¹å™¨ä½¿ç”¨çš„é•œåƒ
                for img_id in \$HOMELABS_IMAGES; do
                  # æ£€æŸ¥é•œåƒæ˜¯å¦è¢«ä»»ä½•å®¹å™¨ä½¿ç”¨
                  if ! docker ps -a --filter \"ancestor=\$img_id\" --format '{{.ID}}' | grep -q .; then
                    docker rmi \$img_id 2>/dev/null || true
                  fi
                done
                echo '   âœ… å½“å‰é¡¹ç›®æœªä½¿ç”¨çš„é•œåƒå·²æ¸…ç†'
              else
                echo '   â„¹ï¸  æœªæ‰¾åˆ° homelabs ç›¸å…³é•œåƒ'
              fi
            else
              echo '   â„¹ï¸  æœªæ‰¾åˆ°docker-compose.ymlï¼Œè·³è¿‡é•œåƒæ¸…ç†'
            fi
            
            echo '3ï¸âƒ£  æ¸…ç†ç¯å¢ƒå˜é‡æ–‡ä»¶...'
            rm -f .env .env.* 2>/dev/null || true
            rm -f docker/.env docker/.env.* 2>/dev/null || true
            echo '   âœ… ç¯å¢ƒæ–‡ä»¶å·²æ¸…ç†'
          else
            echo '   â„¹ï¸  éƒ¨ç½²ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸…ç†'
          fi
        "
    
    - name: åˆ›å»ºéƒ¨ç½²ç›®å½•
      if: env.DEPLOY_MODE != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "åˆ›å»ºéƒ¨ç½²ç›®å½•..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          sudo mkdir -p ${{ env.DEPLOY_PATH }}
          sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} ${{ env.DEPLOY_PATH }}
          mkdir -p ${{ env.DEPLOY_PATH }}/docker
          mkdir -p ${{ env.DEPLOY_PATH }}/logs
        "
    
    - name: ä¼ è¾“ä»£ç åˆ°æœåŠ¡å™¨
      if: env.DEPLOY_MODE != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "ä¼ è¾“ä»£ç åˆ°æœåŠ¡å™¨..."
        echo "==================================="
        
        # ä½¿ç”¨rsyncä¼ è¾“ä»£ç ï¼ˆæ·»åŠ SSHä¿æ´»é…ç½®ï¼‰
        rsync -avz --delete \
          -e "ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -o TCPKeepAlive=yes -p ${{ env.SSH_PORT }}" \
          --exclude 'node_modules' \
          --exclude '.git' \
          --exclude '.github' \
          --exclude 'client/.next' \
          --exclude '.playWright-mcp' \
          --exclude 'client/node_modules' \
          --exclude 'client/build' \
          --exclude '.next' \
          --exclude 'logs' \
          --exclude '*.log' \
          --exclude '.DS_Store' \
          --exclude '.env' \
          --exclude '.env*' \
          --exclude 'plan report' \
          --exclude 'progress report' \
          --exclude 'README.md' \
          --exclude 'PROJECT_MEMORY.md' \
          --exclude 'dev.sh' \
          --exclude 'dev.local' \
          ./ ${{ env.SSH_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/
        
        echo "âœ… ä»£ç ä¼ è¾“å®Œæˆ"
        
        # éªŒè¯ä»£ç ä¼ è¾“ç»“æœ
        echo "éªŒè¯ä»£ç ä¼ è¾“..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.DEPLOY_PATH }}
          echo 'ä»£ç ä¼ è¾“éªŒè¯:'
          echo '  ç›®å½•å†…å®¹:'
          ls -la | head -10
          
          echo ''
          echo 'éªŒè¯å…³é”®Dockeræ–‡ä»¶:'
          if [ -f 'docker/Dockerfile' ]; then
            echo '  âœ… docker/Dockerfile å­˜åœ¨'
            # éªŒè¯æ˜¯å¦åŒ…å«Prisma CLIä¿®å¤
            if grep -q 'node_modules/.bin/prisma' docker/Dockerfile; then
              echo '  âœ… Dockerfile åŒ…å« Prisma CLI ä¿®å¤'
            else
              echo '  âš ï¸  è­¦å‘Š: Dockerfile å¯èƒ½ç¼ºå°‘ Prisma CLI ä¿®å¤'
            fi
          else
            echo '  âŒ docker/Dockerfile ä¸å­˜åœ¨ï¼'
            exit 1
          fi
          
          if [ -f 'docker/docker-entrypoint.sh' ]; then
            echo '  âœ… docker/docker-entrypoint.sh å­˜åœ¨'
            # éªŒè¯æ˜¯å¦åŒ…å«ä¼˜åŒ–åçš„Prismaæ£€æµ‹é€»è¾‘
            if grep -q 'node_modules/prisma/build/index.js' docker/docker-entrypoint.sh; then
              echo '  âœ… docker-entrypoint.sh åŒ…å«ä¼˜åŒ–çš„ Prisma æ£€æµ‹é€»è¾‘'
            else
              echo '  âš ï¸  è­¦å‘Š: docker-entrypoint.sh å¯èƒ½ç¼ºå°‘ä¼˜åŒ–'
            fi
          else
            echo '  âŒ docker/docker-entrypoint.sh ä¸å­˜åœ¨ï¼'
            exit 1
          fi
          
          echo 'âœ… ä»£ç ä¼ è¾“éªŒè¯å®Œæˆ'
        "
    
    - name: ğŸš€ éƒ¨ç½²Dockeré…ç½®
      if: env.DEPLOY_MODE == 'all'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "éƒ¨ç½²Dockeré…ç½®..."
        echo "==================================="
        echo "æ³¨æ„: é…ç½®æ–‡ä»¶åœ¨ä»£ç ä¼ è¾“åä¸Šä¼ ï¼Œé¿å…è¢« rsync --delete åˆ é™¤"
        
        # æ£€æŸ¥æœ¬åœ°é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "docker-compose-auto.yml" ]; then
          echo "âŒ é”™è¯¯: docker-compose-auto.yml æ–‡ä»¶ä¸å­˜åœ¨ï¼"
          echo "   é…ç½®æ–‡ä»¶ç”Ÿæˆå¯èƒ½å¤±è´¥"
          exit 1
        fi
        
        if [ ! -f "docker/nginx-auto.conf" ]; then
          echo "âŒ é”™è¯¯: docker/nginx-auto.conf æ–‡ä»¶ä¸å­˜åœ¨ï¼"
          echo "   é…ç½®æ–‡ä»¶ç”Ÿæˆå¯èƒ½å¤±è´¥"
          exit 1
        fi
        
        # ä¸Šä¼ é…ç½®æ–‡ä»¶åˆ°æœåŠ¡å™¨ï¼ˆåœ¨ä»£ç ä¼ è¾“ä¹‹åï¼Œé¿å…è¢«åˆ é™¤ï¼‰
        echo "ä¸Šä¼  docker-compose.yml..."
        if ! scp -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=60 \
            -o ServerAliveCountMax=10 \
            -o TCPKeepAlive=yes \
            -P ${{ env.SSH_PORT }} \
            docker-compose-auto.yml \
            ${{ env.SSH_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/docker-compose.yml; then
          echo "âŒ docker-compose.yml ä¸Šä¼ å¤±è´¥ï¼"
          exit 1
        fi
        
        echo "ä¸Šä¼  nginx.conf..."
        if ! scp -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=60 \
            -o ServerAliveCountMax=10 \
            -o TCPKeepAlive=yes \
            -P ${{ env.SSH_PORT }} \
            docker/nginx-auto.conf \
            ${{ env.SSH_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/docker/nginx.conf; then
          echo "âŒ nginx.conf ä¸Šä¼ å¤±è´¥ï¼"
          exit 1
        fi
        
        echo "âœ… é…ç½®æ–‡ä»¶ä¸Šä¼ å®Œæˆ"
        
        # éªŒè¯æ–‡ä»¶æ˜¯å¦æˆåŠŸä¸Šä¼ 
        echo "éªŒè¯é…ç½®æ–‡ä»¶æ˜¯å¦æˆåŠŸä¸Šä¼ ..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.DEPLOY_PATH }}
          
          if [ ! -f 'docker-compose.yml' ]; then
            echo 'âŒ é”™è¯¯: docker-compose.yml ä¸Šä¼ åéªŒè¯å¤±è´¥ï¼'
            exit 1
          fi
          
          if [ ! -f 'docker/nginx.conf' ]; then
            echo 'âŒ é”™è¯¯: docker/nginx.conf ä¸Šä¼ åéªŒè¯å¤±è´¥ï¼'
            exit 1
          fi
          
          echo 'âœ… é…ç½®æ–‡ä»¶éªŒè¯æˆåŠŸ'
          echo 'æ–‡ä»¶ä¿¡æ¯:'
          ls -lh docker-compose.yml docker/nginx.conf
        "
        
        # éƒ¨ç½²é…ç½®ï¼ˆSSLè¯ä¹¦ç­‰ï¼‰
        ssh -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=60 \
            -o ServerAliveCountMax=10 \
            -o TCPKeepAlive=yes \
            -p ${{ env.SSH_PORT }} \
            ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
          set -e
          
          DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
          DEPLOY_ENVIRONMENT="${{ vars.DEPLOY_ENVIRONMENT || secrets.DEPLOY_ENVIRONMENT || 'local' }}"
          PRIMARY_DOMAIN="${{ vars.PRIMARY_DOMAIN || secrets.PRIMARY_DOMAIN || 'localhost' }}"
          USE_SSL="${{ vars.USE_SSL || secrets.USE_SSL || 'false' }}"
          SSL_EMAIL="${{ vars.SSL_EMAIL || secrets.SSL_EMAIL || '' }}"
          
          cd $DEPLOY_PATH
          
          # å†æ¬¡éªŒè¯æ–‡ä»¶å­˜åœ¨
          if [ ! -f 'docker-compose.yml' ]; then
            echo 'âŒ é”™è¯¯: docker-compose.yml æ–‡ä»¶ä¸å­˜åœ¨ï¼'
            exit 1
          fi
          
          # ç”Ÿäº§ç¯å¢ƒSSLè¯ä¹¦å¤„ç†
          if [ "$DEPLOY_ENVIRONMENT" = "production" ] && [ "$USE_SSL" = "true" ] && [ -n "$SSL_EMAIL" ]; then
            echo "å¤„ç†ç”Ÿäº§ç¯å¢ƒSSLè¯ä¹¦..."
            
            # åˆ›å»ºSSLç›®å½•
            mkdir -p docker/ssl/$PRIMARY_DOMAIN
            
            # æ£€æŸ¥certbotæ˜¯å¦å·²å®‰è£…ï¼ˆåœ¨ä¸»æœºä¸Šï¼‰
            if ! command -v certbot &> /dev/null; then
              echo "å®‰è£…certbot..."
              if command -v apt-get &> /dev/null; then
                sudo apt-get update
                sudo apt-get install -y certbot
              elif command -v yum &> /dev/null; then
                sudo yum install -y certbot
              fi
            fi
            
            # æ£€æŸ¥è¯ä¹¦æ˜¯å¦å­˜åœ¨
            if [ ! -f "docker/ssl/$PRIMARY_DOMAIN/fullchain.pem" ]; then
              echo "ç”³è¯·SSLè¯ä¹¦..."
              # æ³¨æ„ï¼šéœ€è¦å…ˆå¯åŠ¨ä¸´æ—¶nginxå®¹å™¨æˆ–ä½¿ç”¨standaloneæ¨¡å¼
              sudo certbot certonly --standalone -d $PRIMARY_DOMAIN --email $SSL_EMAIL --agree-tos --non-interactive
              
              # å¤åˆ¶è¯ä¹¦åˆ°docker/sslç›®å½•
              sudo cp /etc/letsencrypt/live/$PRIMARY_DOMAIN/fullchain.pem docker/ssl/$PRIMARY_DOMAIN/
              sudo cp /etc/letsencrypt/live/$PRIMARY_DOMAIN/privkey.pem docker/ssl/$PRIMARY_DOMAIN/
              sudo cp /etc/letsencrypt/live/$PRIMARY_DOMAIN/chain.pem docker/ssl/$PRIMARY_DOMAIN/
              sudo chown -R $USER:$USER docker/ssl/
              echo "âœ… SSLè¯ä¹¦ç”³è¯·å®Œæˆ"
            else
              echo "SSLè¯ä¹¦å·²å­˜åœ¨"
            fi
          fi
          
          echo "âœ… Dockeré…ç½®éƒ¨ç½²å®Œæˆ"
        ENDSSH
        
        echo "âœ… Dockeré…ç½®éƒ¨ç½²æˆåŠŸ"
        echo ""
    
    - name: æ„å»ºå¹¶å¯åŠ¨DockeræœåŠ¡
      if: env.DEPLOY_MODE != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      timeout-minutes: 60
      run: |
        echo "==================================="
        echo "æ„å»ºå¹¶å¯åŠ¨DockeræœåŠ¡..."
        echo "==================================="
        
        # SSHä¿æ´»é…ç½®ï¼Œé˜²æ­¢é•¿æ—¶é—´æ„å»ºæ—¶è¿æ¥æ–­å¼€
        ssh -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=60 \
            -o ServerAliveCountMax=10 \
            -o TCPKeepAlive=yes \
            -p ${{ env.SSH_PORT }} \
            ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          set -e
          cd ${{ env.DEPLOY_PATH }}
          
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ç›®å½•å†…å®¹:"
          ls -la | head -20
          
          # æ£€æŸ¥ docker-compose.yml æ˜¯å¦å­˜åœ¨
          if [ ! -f "docker-compose.yml" ]; then
            echo "âŒ é”™è¯¯: docker-compose.yml æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            echo "   å½“å‰ç›®å½•: $(pwd)"
            echo "   ç›®å½•å†…å®¹:"
            ls -la
            echo ""
            echo "   è¯·ç¡®ä¿ä½¿ç”¨ 'all' æ¨¡å¼éƒ¨ç½²ï¼Œæˆ–æ‰‹åŠ¨ä¸Šä¼ é…ç½®æ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ° docker-compose.yml æ–‡ä»¶"
          echo "æ–‡ä»¶ä¿¡æ¯:"
          ls -lh docker-compose.yml
          echo ""
          echo "æ–‡ä»¶å‰10è¡Œå†…å®¹:"
          head -10 docker-compose.yml
          
          # éªŒè¯Dockeræ„å»ºæ‰€éœ€çš„å…³é”®æ–‡ä»¶
          echo ""
          echo "éªŒè¯Dockeræ„å»ºæ–‡ä»¶..."
          if [ ! -f "docker/Dockerfile" ]; then
            echo "âŒ é”™è¯¯: docker/Dockerfile æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            echo "   è¯·ç¡®ä¿ä»£ç ä¼ è¾“æˆåŠŸ"
            exit 1
          fi
          
          if [ ! -f "docker/docker-entrypoint.sh" ]; then
            echo "âŒ é”™è¯¯: docker/docker-entrypoint.sh æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            echo "   è¯·ç¡®ä¿ä»£ç ä¼ è¾“æˆåŠŸ"
            exit 1
          fi
          
          if [ ! -f "client/package.json" ]; then
            echo "âŒ é”™è¯¯: client/package.json æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            echo "   è¯·ç¡®ä¿ä»£ç ä¼ è¾“æˆåŠŸ"
            exit 1
          fi
          
          echo "âœ… æ‰€æœ‰å¿…éœ€çš„Dockeræ„å»ºæ–‡ä»¶éƒ½å­˜åœ¨"
          
          # æ£€æŸ¥Dockeræƒé™å¹¶ç¡®ä¿ç”¨æˆ·æœ‰æƒé™
          echo "æ£€æŸ¥Dockeræƒé™..."
          DOCKER_CMD=""
          
          if ! docker ps &>/dev/null; then
            echo "âš ï¸  å½“å‰ç”¨æˆ·æ— æ³•è®¿é—®Dockerï¼Œå°è¯•ä¿®å¤æƒé™..."
            # ç¡®ä¿ç”¨æˆ·åœ¨dockerç»„ä¸­
            sudo usermod -aG docker $USER 2>/dev/null || true
            
            # å°è¯•ä½¿ç”¨sgä¸´æ—¶åˆ‡æ¢åˆ°dockerç»„
            if command -v sg &>/dev/null && sg docker -c "docker ps" &>/dev/null; then
              echo "ä½¿ç”¨sgåˆ‡æ¢åˆ°dockerç»„æ‰§è¡Œå‘½ä»¤..."
              DOCKER_CMD="sg docker -c"
            else
              # å¦‚æœsgä¸å¯ç”¨æˆ–æ— æ•ˆï¼Œä½¿ç”¨sudo
              echo "ä½¿ç”¨sudoæ‰§è¡ŒDockerå‘½ä»¤..."
              DOCKER_CMD="sudo"
            fi
          else
            echo "âœ… Dockeræƒé™æ­£å¸¸"
          fi
          
          echo "ğŸ”¨ æ„å»ºDockeré•œåƒ..."
          echo "æ³¨æ„: æ„å»ºè¿‡ç¨‹å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…..."
          
          # ä½¿ç”¨nohupå’Œé‡å®šå‘è¾“å‡ºï¼Œç¡®ä¿å³ä½¿SSHæ–­å¼€ä¹Ÿèƒ½ç»§ç»­æ„å»º
          BUILD_LOG="/tmp/docker-build-$(date +%s).log"
          if [ -n "$DOCKER_CMD" ]; then
            if [ "$DOCKER_CMD" = "sg docker -c" ]; then
              if ! sg docker -c "docker compose build --no-cache 2>&1 | tee $BUILD_LOG"; then
                echo "âŒ Dockeré•œåƒæ„å»ºå¤±è´¥ï¼"
                echo "æ„å»ºæ—¥å¿—ï¼ˆæœ€å50è¡Œï¼‰:"
                tail -50 "$BUILD_LOG" 2>/dev/null || echo "æ— æ³•è¯»å–æ„å»ºæ—¥å¿—"
                exit 1
              fi
            else
              if ! sudo docker compose build --no-cache 2>&1 | tee "$BUILD_LOG"; then
                echo "âŒ Dockeré•œåƒæ„å»ºå¤±è´¥ï¼"
                echo "æ„å»ºæ—¥å¿—ï¼ˆæœ€å50è¡Œï¼‰:"
                tail -50 "$BUILD_LOG" 2>/dev/null || echo "æ— æ³•è¯»å–æ„å»ºæ—¥å¿—"
                exit 1
              fi
            fi
          else
            if ! docker compose build --no-cache 2>&1 | tee "$BUILD_LOG"; then
              echo "âŒ Dockeré•œåƒæ„å»ºå¤±è´¥ï¼"
              echo "æ„å»ºæ—¥å¿—ï¼ˆæœ€å50è¡Œï¼‰:"
              tail -50 "$BUILD_LOG" 2>/dev/null || echo "æ— æ³•è¯»å–æ„å»ºæ—¥å¿—"
              exit 1
            fi
          fi
          
          echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ"
          
          # éªŒè¯æ„å»ºçš„é•œåƒä¸­Prisma CLIæ˜¯å¦å¯ç”¨ï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰
          echo ""
          echo "éªŒè¯æ„å»ºçš„é•œåƒ..."
          APP_IMAGE=\$(docker compose config | grep -A 5 "app:" | grep "image:" | awk '{print \$2}' || docker images --format "{{.Repository}}:{{.Tag}}" | grep homelabs | head -1)
          if [ -n "\$APP_IMAGE" ]; then
            echo "åº”ç”¨é•œåƒ: \$APP_IMAGE"
            # æ£€æŸ¥é•œåƒä¸­æ˜¯å¦åŒ…å«Prismaç›¸å…³æ–‡ä»¶
            if docker run --rm \$APP_IMAGE test -f node_modules/prisma/build/index.js 2>/dev/null; then
              echo "  âœ… Prisma CLI å…¥å£æ–‡ä»¶å­˜åœ¨"
            else
              echo "  âš ï¸  è­¦å‘Š: Prisma CLI å…¥å£æ–‡ä»¶å¯èƒ½ä¸å­˜åœ¨"
            fi
          fi
          
          echo "ğŸš€ å¯åŠ¨DockeræœåŠ¡..."
          if [ -n "$DOCKER_CMD" ]; then
            if [ "$DOCKER_CMD" = "sg docker -c" ]; then
              if ! sg docker -c "docker compose up -d"; then
                echo "âŒ DockeræœåŠ¡å¯åŠ¨å¤±è´¥ï¼"
                exit 1
              fi
            else
              if ! sudo docker compose up -d; then
                echo "âŒ DockeræœåŠ¡å¯åŠ¨å¤±è´¥ï¼"
                exit 1
              fi
            fi
          else
            if ! docker compose up -d; then
              echo "âŒ DockeræœåŠ¡å¯åŠ¨å¤±è´¥ï¼"
              exit 1
            fi
          fi
          
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 10
          
          echo "ğŸ“Š æŸ¥çœ‹æœåŠ¡çŠ¶æ€..."
          if [ -n "$DOCKER_CMD" ]; then
            if [ "$DOCKER_CMD" = "sg docker -c" ]; then
              sg docker -c "docker compose ps"
            else
              sudo docker compose ps
            fi
          else
            docker compose ps
          fi
          
          # éªŒè¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
          # ä½¿ç”¨docker compose psç›´æ¥ç»Ÿè®¡ï¼Œé¿å…jqè¯­æ³•é—®é¢˜
          # ä½¿ç”¨ç›¸åŒçš„DOCKER_CMDå‰ç¼€
          if [ -n "$DOCKER_CMD" ]; then
            if [ "$DOCKER_CMD" = "sg docker -c" ]; then
              RUNNING_COUNT=$(sg docker -c "docker compose ps --filter 'status=running' --format '{{.Name}}'" | grep -v "^$" | wc -l || echo "0")
              TOTAL_COUNT=$(sg docker -c "docker compose ps --format '{{.Name}}'" | grep -v "^$" | wc -l || echo "0")
            else
              RUNNING_COUNT=$(sudo docker compose ps --filter "status=running" --format "{{.Name}}" | grep -v "^$" | wc -l || echo "0")
              TOTAL_COUNT=$(sudo docker compose ps --format "{{.Name}}" | grep -v "^$" | wc -l || echo "0")
            fi
          else
            RUNNING_COUNT=$(docker compose ps --filter "status=running" --format "{{.Name}}" | grep -v "^$" | wc -l || echo "0")
            TOTAL_COUNT=$(docker compose ps --format "{{.Name}}" | grep -v "^$" | wc -l || echo "0")
          fi
          
          if [ "$TOTAL_COUNT" -eq "0" ]; then
            echo "âŒ é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å®¹å™¨ï¼"
            echo "æŸ¥çœ‹ docker-compose.yml é…ç½®:"
            cat docker-compose.yml | head -20
            exit 1
          fi
          
          echo "å®¹å™¨çŠ¶æ€: è¿è¡Œä¸­ $RUNNING_COUNT / æ€»è®¡ $TOTAL_COUNT"
          
          if [ "$RUNNING_COUNT" -eq "0" ]; then
            echo "âŒ é”™è¯¯: æ‰€æœ‰å®¹å™¨éƒ½æœªè¿è¡Œï¼"
            echo "æŸ¥çœ‹å®¹å™¨çŠ¶æ€:"
            if [ -n "$DOCKER_CMD" ]; then
              if [ "$DOCKER_CMD" = "sg docker -c" ]; then
                sg docker -c "docker compose ps"
                echo ""
                echo "æŸ¥çœ‹å®¹å™¨æ—¥å¿—:"
                sg docker -c "docker compose logs --tail=30"
              else
                sudo docker compose ps
                echo ""
                echo "æŸ¥çœ‹å®¹å™¨æ—¥å¿—:"
                sudo docker compose logs --tail=30
              fi
            else
              docker compose ps
              echo ""
              echo "æŸ¥çœ‹å®¹å™¨æ—¥å¿—:"
              docker compose logs --tail=30
            fi
            exit 1
          fi
          
          if [ "$RUNNING_COUNT" -lt "$TOTAL_COUNT" ]; then
            echo "âš ï¸  è­¦å‘Š: éƒ¨åˆ†å®¹å™¨æœªè¿è¡Œ ($RUNNING_COUNT/$TOTAL_COUNT)"
            echo "æŸ¥çœ‹æœªè¿è¡Œçš„å®¹å™¨:"
            if [ -n "$DOCKER_CMD" ]; then
              if [ "$DOCKER_CMD" = "sg docker -c" ]; then
                sg docker -c "docker compose ps --filter 'status=exited' --filter 'status=dead'"
                echo ""
                echo "æŸ¥çœ‹é”™è¯¯æ—¥å¿—:"
                sg docker -c "docker compose logs --tail=30"
              else
                sudo docker compose ps --filter "status=exited" --filter "status=dead"
                echo ""
                echo "æŸ¥çœ‹é”™è¯¯æ—¥å¿—:"
                sudo docker compose logs --tail=30
              fi
            else
              docker compose ps --filter "status=exited" --filter "status=dead"
              echo ""
              echo "æŸ¥çœ‹é”™è¯¯æ—¥å¿—:"
              docker compose logs --tail=30
            fi
            exit 1
          fi
          
          echo "âœ… DockeræœåŠ¡å¯åŠ¨å®Œæˆ (æ‰€æœ‰ $TOTAL_COUNT ä¸ªå®¹å™¨éƒ½åœ¨è¿è¡Œ)"
        '
    
    - name: éªŒè¯éƒ¨ç½²
      if: env.DEPLOY_MODE != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "éªŒè¯éƒ¨ç½²..."
        echo "==================================="
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 15
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          # æ£€æŸ¥Dockeræƒé™
          DOCKER_CMD=\"\"
          if ! docker ps &>/dev/null; then
            if command -v sg &>/dev/null && sg docker -c \"docker ps\" &>/dev/null; then
              DOCKER_CMD=\"sg docker -c\"
            else
              DOCKER_CMD=\"sudo\"
            fi
          fi
          
          echo '1. Dockerå®¹å™¨çŠ¶æ€:'
          if [ -n \"\$DOCKER_CMD\" ]; then
            if [ \"\$DOCKER_CMD\" = \"sg docker -c\" ]; then
              sg docker -c \"docker compose ps\"
            else
              sudo docker compose ps
            fi
          else
            docker compose ps
          fi
          
          echo ''
          echo '2. æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€:'
          if [ -n \"\$DOCKER_CMD\" ]; then
            if [ \"\$DOCKER_CMD\" = \"sg docker -c\" ]; then
              sg docker -c \"docker compose ps --format 'table {{.Name}}\t{{.Status}}\t{{.Health}}'\" || echo 'å¥åº·æ£€æŸ¥ä¿¡æ¯ä¸å¯ç”¨'
            else
              sudo docker compose ps --format \"table {{.Name}}\t{{.Status}}\t{{.Health}}\" || echo 'å¥åº·æ£€æŸ¥ä¿¡æ¯ä¸å¯ç”¨'
            fi
          else
            docker compose ps --format \"table {{.Name}}\t{{.Status}}\t{{.Health}}\" || echo 'å¥åº·æ£€æŸ¥ä¿¡æ¯ä¸å¯ç”¨'
          fi
          
          echo ''
          echo '3. æ£€æŸ¥åº”ç”¨ç«¯å£:'
          sudo ss -tlnp | grep :${{ vars.APP_PORT || secrets.APP_PORT || '3000' }} || echo 'åº”ç”¨ç«¯å£æœªç›‘å¬'
          
          echo ''
          echo '4. æ£€æŸ¥Nginxç«¯å£:'
          sudo ss -tlnp | grep :${{ vars.NGINX_PORT || secrets.NGINX_PORT || '80' }} || echo 'Nginxç«¯å£æœªç›‘å¬'
          
          echo ''
          echo '5. æµ‹è¯•åº”ç”¨è®¿é—®:'
          if curl -f -s http://localhost:${{ vars.APP_PORT || secrets.APP_PORT || '3000' }}/api/health > /dev/null 2>&1; then
            echo 'âœ… åº”ç”¨å“åº”æ­£å¸¸'
          else
            echo 'âš ï¸  åº”ç”¨æœªå“åº”'
          fi
          
          echo ''
          echo '6. æµ‹è¯•Nginxè®¿é—®:'
          if curl -f -s http://localhost:${{ vars.NGINX_PORT || secrets.NGINX_PORT || '80' }}/health > /dev/null 2>&1; then
            echo 'âœ… Nginxå“åº”æ­£å¸¸'
          else
            echo 'âš ï¸  Nginxæœªå“åº”'
          fi
          
          echo ''
          echo '7. éªŒè¯Prisma CLIå¯ç”¨æ€§:'
          if [ -n \"\$DOCKER_CMD\" ]; then
            if [ \"\$DOCKER_CMD\" = \"sg docker -c\" ]; then
              PRISMA_CHECK=\$(sg docker -c \"docker compose exec -T app sh -c 'test -f node_modules/prisma/build/index.js && echo OK || echo FAIL'\" 2>/dev/null || echo \"FAIL\")
            else
              PRISMA_CHECK=\$(sudo docker compose exec -T app sh -c 'test -f node_modules/prisma/build/index.js && echo OK || echo FAIL' 2>/dev/null || echo \"FAIL\")
            fi
          else
            PRISMA_CHECK=\$(docker compose exec -T app sh -c 'test -f node_modules/prisma/build/index.js && echo OK || echo FAIL' 2>/dev/null || echo \"FAIL\")
          fi
          if [ \"\$PRISMA_CHECK\" = \"OK\" ]; then
            echo '  âœ… Prisma CLI æ–‡ä»¶å­˜åœ¨'
          else
            echo '  âš ï¸  è­¦å‘Š: Prisma CLI æ–‡ä»¶å¯èƒ½ä¸å­˜åœ¨'
          fi
          
          echo ''
          echo '8. æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼ˆæœ€è¿‘10è¡Œï¼‰:'
          echo '--- Appæ—¥å¿— ---'
          if [ -n \"\$DOCKER_CMD\" ]; then
            if [ \"\$DOCKER_CMD\" = \"sg docker -c\" ]; then
              sg docker -c \"docker compose logs --tail=10 app\" || true
            else
              sudo docker compose logs --tail=10 app || true
            fi
          else
            docker compose logs --tail=10 app || true
          fi
          echo '--- Nginxæ—¥å¿— ---'
          if [ -n \"\$DOCKER_CMD\" ]; then
            if [ \"\$DOCKER_CMD\" = \"sg docker -c\" ]; then
              sg docker -c \"docker compose logs --tail=10 nginx\" || true
            else
              sudo docker compose logs --tail=10 nginx || true
            fi
          else
            docker compose logs --tail=10 nginx || true
          fi
          
          echo ''
          echo '9. æ£€æŸ¥æ•°æ®åº“åˆå§‹åŒ–çŠ¶æ€:'
          if [ -n \"\$DOCKER_CMD\" ]; then
            if [ \"\$DOCKER_CMD\" = \"sg docker -c\" ]; then
              sg docker -c \"docker compose logs app\" | grep -E '(Prisma|æ•°æ®åº“|database)' | tail -5 || echo 'æœªæ‰¾åˆ°ç›¸å…³æ—¥å¿—'
            else
              sudo docker compose logs app | grep -E '(Prisma|æ•°æ®åº“|database)' | tail -5 || echo 'æœªæ‰¾åˆ°ç›¸å…³æ—¥å¿—'
            fi
          else
            docker compose logs app | grep -E '(Prisma|æ•°æ®åº“|database)' | tail -5 || echo 'æœªæ‰¾åˆ°ç›¸å…³æ—¥å¿—'
          fi
        "
        
        echo ""
        echo "==================================="
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        echo "==================================="
        echo "è®¿é—®åœ°å€: http://${{ env.SERVER_HOST }}"
        echo ""
        echo "ğŸ“Š æŸ¥çœ‹æ—¥å¿—:"
        echo "  åº”ç”¨æ—¥å¿—: docker compose logs -f app"
        echo "  Nginxæ—¥å¿—: docker compose logs -f nginx"
        echo "  æ•°æ®åº“æ—¥å¿—: docker compose logs -f postgres"
        echo "  æ‰€æœ‰æ—¥å¿—: docker compose logs -f"
        echo ""
        echo "ğŸ“– å¸¸ç”¨å‘½ä»¤:"
        echo "  æŸ¥çœ‹çŠ¶æ€: docker compose ps"
        echo "  åœæ­¢æœåŠ¡: docker compose down"
        echo "  é‡å¯æœåŠ¡: docker compose restart"
        echo "  æŸ¥çœ‹æ—¥å¿—: docker compose logs -f [service]"
    
    - name: æ¸…ç†å’Œå›æ»šï¼ˆå¤±è´¥æ—¶ï¼‰
      if: ${{ failure() && env.DEPLOY_MODE != 'check' }}
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "âš ï¸  éƒ¨ç½²å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š..."
        echo "==================================="
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          # åœæ­¢å¤±è´¥çš„æœåŠ¡
          cd ${{ env.DEPLOY_PATH }}
          docker compose down 2>/dev/null || true
          
          # æ£€æŸ¥å¤‡ä»½å¹¶å›æ»š
          if [ -f /tmp/homelabs_last_backup ]; then
            BACKUP_DIR=$(cat /tmp/homelabs_last_backup)
            
            if [ -d "$BACKUP_DIR" ]; then
              echo "å‘ç°å¤‡ä»½: $BACKUP_DIR"
              echo "æ­£åœ¨å›æ»š..."
              
              # ä½¿ç”¨sudoè¿›è¡Œå›æ»šæ“ä½œ
              sudo rm -rf ${{ env.DEPLOY_PATH }}
              sudo mv $BACKUP_DIR ${{ env.DEPLOY_PATH }}
              sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} ${{ env.DEPLOY_PATH }}
              
              # å°è¯•é‡å¯æ—§ç‰ˆæœ¬
              cd ${{ env.DEPLOY_PATH }}
              docker compose up -d 2>/dev/null || true
              
              echo "âœ… å·²å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬"
            fi
          fi
        '

