name: æœ¬åœ°ç¯å¢ƒéƒ¨ç½²ï¼ˆéDockerï¼‰

on:
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: 'éƒ¨ç½²æ¨¡å¼'
        required: true
        default: 'all'
        type: choice
        options:
          - all          # å…¨éƒ¨éƒ¨ç½²
          - app-only     # ä»…åº”ç”¨
          - check        # ä»…æ£€æŸ¥ç¯å¢ƒ

jobs:
  deploy-local:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®SSHå¯†é’¥
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
        ssh-auth-sock: ${{ github.workspace }}/ssh-auth.sock
    
    - name: è®¾ç½®æœåŠ¡å™¨é…ç½®
      id: server_config
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "SERVER_HOST=${{ vars.SERVER_HOST || secrets.SERVER_HOST }}" >> $GITHUB_ENV
        echo "SSH_PORT=${{ vars.SSH_PORT || secrets.SSH_PORT || '22' }}" >> $GITHUB_ENV
        echo "SSH_USER=${{ vars.SSH_USER || secrets.SSH_USER }}" >> $GITHUB_ENV
        echo "DEPLOY_PATH=${{ vars.DEPLOY_PATH || secrets.DEPLOY_PATH || '/opt/homelabs' }}" >> $GITHUB_ENV
    
    - name: æ£€æŸ¥å¹¶å®‰è£…æœåŠ¡å™¨ç¯å¢ƒ
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "æ£€æŸ¥å¹¶å‡†å¤‡æœåŠ¡å™¨ç¯å¢ƒ..."
        echo "==================================="
        echo ""
        
        # æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹
        echo "æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹..."
        OS_TYPE=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          if [ -f /etc/os-release ]; then
            . /etc/os-release
            echo \$ID
          elif [ -f /etc/redhat-release ]; then
            echo 'rhel'
          else
            echo 'unknown'
          fi
        ")
        echo "ğŸ“‹ æ£€æµ‹åˆ°æ“ä½œç³»ç»Ÿ: $OS_TYPE"
        echo ""
        
        # ========================================
        # 1. æ£€æŸ¥å¹¶å®‰è£… Node.js
        # ========================================
        echo "-----------------------------------"
        echo "1ï¸âƒ£  æ£€æŸ¥ Node.js..."
        echo "-----------------------------------"
        if ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "command -v node &> /dev/null"; then
          NODE_VERSION=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "node --version" 2>/dev/null || echo "v0.0.0")
          NODE_MAJOR=$(echo $NODE_VERSION | cut -d'v' -f2 | cut -d'.' -f1)
          echo "âœ… Node.jså·²å®‰è£…: $NODE_VERSION"
          
          if [ "$NODE_MAJOR" -lt 18 ]; then
            echo "âš ï¸  Node.jsç‰ˆæœ¬è¿‡ä½ (éœ€è¦ >= 18)ï¼Œå°†é‡æ–°å®‰è£…..."
            
            if [ "$OS_TYPE" = "amzn" ]; then
              echo "ä½¿ç”¨NodeSourceä»“åº“å‡çº§åˆ°Node.js 20 (Amazon Linux 2)..."
              ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
                'sudo yum remove -y nodejs npm nodesource-release 2>/dev/null || true && \
                sudo rm -rf /etc/yum.repos.d/nodesource*.repo && \
                sudo yum clean all && \
                curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash - && \
                sudo yum install -y nodejs && \
                node --version && \
                npm --version'
            else
              echo "ä½¿ç”¨NodeSourceä»“åº“å‡çº§åˆ°Node.js 20..."
              ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
                'curl -fsSL https://deb.nodesource.com/setup_20.x | sudo bash - && \
                sudo apt-get remove -y nodejs npm 2>/dev/null || true && \
                sudo apt-get install -y nodejs && \
                node --version && \
                npm --version'
            fi
            
            echo "âœ… Node.jså‡çº§å®Œæˆ"
          fi
        else
          echo "ğŸ“¦ Node.jsæœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
          
          if [ "$OS_TYPE" = "amzn" ]; then
            echo "æ£€æµ‹åˆ°Amazon Linux 2ï¼Œå®‰è£…Node.js 20..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
              'sudo rm -rf /etc/yum.repos.d/nodesource*.repo && \
              sudo yum clean all && \
              curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash - && \
              sudo yum install -y nodejs && \
              node --version && \
              npm --version'
          else
            echo "æ£€æµ‹åˆ°Ubuntu/Debianï¼Œå®‰è£…Node.js 20..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
              'curl -fsSL https://deb.nodesource.com/setup_20.x | sudo bash - && \
              sudo apt-get install -y nodejs && \
              node --version && \
              npm --version'
          fi
          
          echo "âœ… Node.jså®‰è£…å®Œæˆ"
        fi
        echo ""
        
        # ========================================
        # 2. æ£€æŸ¥å¹¶å®‰è£… PM2
        # ========================================
        echo "-----------------------------------"
        echo "2ï¸âƒ£  æ£€æŸ¥ PM2..."
        echo "-----------------------------------"
        if ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "command -v pm2 &> /dev/null"; then
          PM2_VERSION=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "pm2 --version")
          echo "âœ… PM2å·²å®‰è£…: $PM2_VERSION"
        else
          echo "ğŸ“¦ PM2æœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
            'sudo npm install -g pm2 && pm2 --version'
          echo "âœ… PM2å®‰è£…å®Œæˆ"
        fi
        echo ""
        
        # ========================================
        # 3. æ£€æŸ¥å¹¶å®‰è£… PostgreSQL
        # ========================================
        echo "-----------------------------------"
        echo "3ï¸âƒ£  æ£€æŸ¥ PostgreSQL..."
        echo "-----------------------------------"
        if ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "command -v psql &> /dev/null"; then
          PG_VERSION=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "psql --version | head -1")
          echo "âœ… PostgreSQLå·²å®‰è£…: $PG_VERSION"
        else
          echo "ğŸ“¦ PostgreSQLæœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
          
          if [ "$OS_TYPE" = "amzn" ]; then
            echo "æ£€æµ‹åˆ°Amazon Linuxç³»ç»Ÿï¼Œä½¿ç”¨yumå®‰è£…..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
              'sudo amazon-linux-extras install postgresql15 -y && \
              sudo yum install -y postgresql-server postgresql-contrib && \
              sudo postgresql-setup initdb && \
              sudo systemctl start postgresql && \
              sudo systemctl enable postgresql && \
              psql --version'
          elif [ "$OS_TYPE" = "ubuntu" ] || [ "$OS_TYPE" = "debian" ]; then
            echo "æ£€æµ‹åˆ°Ubuntu/Debianç³»ç»Ÿï¼Œä½¿ç”¨aptå®‰è£…..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
              sudo apt-get update
              sudo apt-get install -y postgresql postgresql-contrib
              sudo systemctl start postgresql
              sudo systemctl enable postgresql
              psql --version
            '
          else
            echo "âš ï¸  æœªè¯†åˆ«çš„æ“ä½œç³»ç»Ÿç±»å‹: $OS_TYPE"
            echo "è¯·æ‰‹åŠ¨å®‰è£…PostgreSQL: https://www.postgresql.org/download/"
            exit 1
          fi
          
          echo "âœ… PostgreSQLå®‰è£…å®Œæˆ"
        fi
        
        # ç¡®ä¿PostgreSQLæœåŠ¡æ­£åœ¨è¿è¡Œ
        echo "æ£€æŸ¥PostgreSQLæœåŠ¡çŠ¶æ€..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          if ! sudo systemctl is-active --quiet postgresql; then
            echo 'å¯åŠ¨PostgreSQLæœåŠ¡...'
            sudo systemctl start postgresql
            sudo systemctl enable postgresql
            sleep 3
          fi
          sudo systemctl status postgresql | head -5
        "
        echo ""
        
        # ========================================
        # 3.1 åˆ›å»ºæˆ–æ›´æ–°PostgreSQLæ•°æ®åº“å’Œç”¨æˆ·
        # ========================================
        echo "-----------------------------------"
        echo "3.1ï¸âƒ£  åˆ›å»ºæˆ–æ›´æ–°PostgreSQLæ•°æ®åº“å’Œç”¨æˆ·..."
        echo "-----------------------------------"
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          DB_NAME="${{ vars.POSTGRES_DB || secrets.POSTGRES_DB || 'homelabs_portal' }}"
          DB_USER="${{ vars.POSTGRES_USER || secrets.POSTGRES_USER || 'homelabs' }}"
          DB_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"
          
          echo "é…ç½®æ•°æ®åº“: $DB_NAME"
          echo "é…ç½®ç”¨æˆ·: $DB_USER"
          
          # åˆ‡æ¢åˆ°/tmpç›®å½•é¿å…æƒé™è­¦å‘Š
          cd /tmp
          
          # åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·
          sudo -u postgres psql -c "
            DO \$\$
            BEGIN
              IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '"'"'$DB_USER'"'"') THEN
                CREATE USER $DB_USER WITH PASSWORD '"'"'$DB_PASSWORD'"'"';
                RAISE NOTICE '"'"'ç”¨æˆ· % å·²åˆ›å»º'"'"', '"'"'$DB_USER'"'"';
              ELSE
                ALTER USER $DB_USER WITH PASSWORD '"'"'$DB_PASSWORD'"'"';
                RAISE NOTICE '"'"'ç”¨æˆ· % å¯†ç å·²æ›´æ–°'"'"', '"'"'$DB_USER'"'"';
              END IF;
            END
            \$\$;
          " || echo "è­¦å‘Š: ç”¨æˆ·é…ç½®å¯èƒ½å¤±è´¥"
          
          # åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname = '"'"'$DB_NAME'"'"'" | grep -q 1 || \
            sudo -u postgres psql -c "CREATE DATABASE $DB_NAME OWNER $DB_USER"
          
          # æˆäºˆæƒé™
          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER"
          sudo -u postgres psql -c "ALTER USER $DB_USER CREATEDB"
          
          echo "âœ… PostgreSQLæ•°æ®åº“å’Œç”¨æˆ·é…ç½®å®Œæˆ"
        '
        
        echo ""
        
        # ========================================
        # 4. æ£€æŸ¥å¹¶å®‰è£…jq
        # ========================================
        echo "-----------------------------------"
        echo "4ï¸âƒ£  æ£€æŸ¥å¹¶å®‰è£…jq..."
        echo "-----------------------------------"
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          if ! command -v jq &> /dev/null; then
            echo "ğŸ“¦ jqæœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
            if command -v apt-get &> /dev/null; then
              sudo apt-get update -y && sudo apt-get install -y jq
            elif command -v yum &> /dev/null; then
              sudo yum install -y jq
            else
              echo "âš ï¸ æ— æ³•è‡ªåŠ¨å®‰è£…jqï¼Œè¯·æ‰‹åŠ¨å®‰è£…"
              exit 1
            fi
            echo "âœ… jqå®‰è£…å®Œæˆ"
          else
            echo "âœ… jqå·²å®‰è£…"
          fi
        '
        echo ""
        
        # ========================================
        # 5. æœ€ç»ˆéªŒè¯
        # ========================================
        echo "==================================="
        echo "ğŸ“Š ç¯å¢ƒæœ€ç»ˆéªŒè¯"
        echo "==================================="
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} <<'ENV_VERIFY'
          echo 'âœ… Node.jsç‰ˆæœ¬:'
          node --version
          
          echo 'âœ… npmç‰ˆæœ¬:'
          npm --version
          
          echo 'âœ… PM2ç‰ˆæœ¬:'
          pm2 --version
          
          echo 'âœ… PostgreSQLæœåŠ¡:'
          sudo systemctl is-active postgresql && echo 'PostgreSQLè¿è¡Œä¸­' || echo 'PostgreSQLæœªè¿è¡Œ'
          
          echo 'âœ… PostgreSQLç‰ˆæœ¬:'
          psql --version
        ENV_VERIFY
        
        echo ""
        echo "==================================="
        echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆï¼"
        echo "==================================="
    
    # ========================================
    # Nginxè‡ªåŠ¨é…ç½®æ­¥éª¤
    # ========================================
    
    - name: ğŸ”§ æ£€æŸ¥å¹¶å®‰è£…Nginx
      if: inputs.deploy_mode == 'all'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "æ£€æŸ¥å¹¶å®‰è£…Nginx..."
        echo "==================================="
        
        if ! ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "command -v nginx &> /dev/null"; then
          echo "ğŸ“¦ Nginxæœªå®‰è£…ï¼Œå¼€å§‹å®‰è£…..."
          
          OS_TYPE=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
            if [ -f /etc/os-release ]; then
              . /etc/os-release
              echo \$ID
            else
              echo 'unknown'
            fi
          ")
          
          if [ "$OS_TYPE" = "ubuntu" ] || [ "$OS_TYPE" = "debian" ]; then
            echo "ä½¿ç”¨aptå®‰è£…Nginx..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
              "sudo apt update && sudo apt install -y nginx"
          elif [ "$OS_TYPE" = "centos" ] || [ "$OS_TYPE" = "rhel" ] || [ "$OS_TYPE" = "amzn" ]; then
            echo "ä½¿ç”¨yumå®‰è£…Nginx..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
              "sudo yum install -y epel-release && sudo yum install -y nginx"
          else
            echo "âŒ ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: $OS_TYPE"
            echo "è¯·æ‰‹åŠ¨å®‰è£…Nginx"
            exit 1
          fi
          
          # å¯åŠ¨Nginx
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
            "sudo systemctl start nginx && sudo systemctl enable nginx"
          
          echo "âœ… Nginxå®‰è£…å®Œæˆ"
        else
          echo "âœ… Nginxå·²å®‰è£…"
          NGINX_VERSION=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "nginx -v 2>&1")
          echo "   ç‰ˆæœ¬: $NGINX_VERSION"
        fi
        
        echo ""
    
    - name: ğŸ“ ç”ŸæˆNginxé…ç½®æ–‡ä»¶
      if: inputs.deploy_mode == 'all'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "ç”ŸæˆNginxé…ç½®æ–‡ä»¶..."
        echo "==================================="
        
        # è·å–éƒ¨ç½²ç¯å¢ƒé…ç½®
        DEPLOY_ENVIRONMENT="${{ vars.DEPLOY_ENVIRONMENT || secrets.DEPLOY_ENVIRONMENT || 'local' }}"
        PRIMARY_DOMAIN="${{ vars.PRIMARY_DOMAIN || secrets.PRIMARY_DOMAIN || 'localhost' }}"
        ADDITIONAL_DOMAINS="${{ vars.ADDITIONAL_DOMAINS || secrets.ADDITIONAL_DOMAINS || '' }}"
        USE_SSL="${{ vars.USE_SSL || secrets.USE_SSL || 'false' }}"
        SSL_EMAIL="${{ vars.SSL_EMAIL || secrets.SSL_EMAIL || '' }}"
        NGINX_PORT="${{ vars.NGINX_PORT || secrets.NGINX_PORT || '80' }}"
        BEHIND_PROXY="${{ vars.BEHIND_PROXY || secrets.BEHIND_PROXY || 'false' }}"
        PROXY_IP="${{ vars.PROXY_REAL_IP_FROM || secrets.PROXY_REAL_IP_FROM || '192.168.0.0/16' }}"
        APP_PORT="${{ vars.APP_PORT || secrets.APP_PORT || '3000' }}"
        DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
        
        echo "é…ç½®å‚æ•°:"
        echo "  éƒ¨ç½²ç¯å¢ƒ: $DEPLOY_ENVIRONMENT"
        echo "  ä¸»åŸŸå: $PRIMARY_DOMAIN"
        echo "  å¤‡ç”¨åŸŸå: $ADDITIONAL_DOMAINS"
        echo "  SSLå¯ç”¨: $USE_SSL"
        echo "  Nginxç«¯å£: $NGINX_PORT"
        echo "  åº”ç”¨ç«¯å£: $APP_PORT"
        echo "  åå‘ä»£ç†: $BEHIND_PROXY"
        echo ""
        
        # ç”ŸæˆNginxé…ç½®
        echo "# HOMELABS Portal Nginxé…ç½®" > nginx-auto.conf
        echo "# è‡ªåŠ¨ç”Ÿæˆ - è¯·å‹¿æ‰‹åŠ¨ç¼–è¾‘" >> nginx-auto.conf
        echo "" >> nginx-auto.conf
        
        # æ„å»ºserver_name
        SERVER_NAMES="$PRIMARY_DOMAIN"
        if [ -n "$ADDITIONAL_DOMAINS" ]; then
          SERVER_NAMES="$SERVER_NAMES $ADDITIONAL_DOMAINS"
        fi
        
        echo "server {" >> nginx-auto.conf
        
        # æ ¹æ®ç¯å¢ƒå’ŒSSLè®¾ç½®å†³å®šç›‘å¬ç«¯å£
        if [ "$DEPLOY_ENVIRONMENT" = "production" ] && [ "$USE_SSL" = "true" ]; then
          echo "    # HTTPé‡å®šå‘åˆ°HTTPS" >> nginx-auto.conf
          echo "    listen 80;" >> nginx-auto.conf
          echo "    listen [::]:80;" >> nginx-auto.conf
          echo "    server_name $SERVER_NAMES;" >> nginx-auto.conf
          echo "    return 301 https://\$server_name\$request_uri;" >> nginx-auto.conf
          echo "}" >> nginx-auto.conf
          echo "" >> nginx-auto.conf
          echo "server {" >> nginx-auto.conf
          echo "    # HTTPSé…ç½®" >> nginx-auto.conf
          echo "    listen 443 ssl http2;" >> nginx-auto.conf
          echo "    listen [::]:443 ssl http2;" >> nginx-auto.conf
          echo "    server_name $SERVER_NAMES;" >> nginx-auto.conf
          echo "" >> nginx-auto.conf
          echo "    # SSLè¯ä¹¦é…ç½®" >> nginx-auto.conf
          echo "    ssl_certificate /etc/letsencrypt/live/$PRIMARY_DOMAIN/fullchain.pem;" >> nginx-auto.conf
          echo "    ssl_certificate_key /etc/letsencrypt/live/$PRIMARY_DOMAIN/privkey.pem;" >> nginx-auto.conf
          echo "    ssl_trusted_certificate /etc/letsencrypt/live/$PRIMARY_DOMAIN/chain.pem;" >> nginx-auto.conf
          echo "" >> nginx-auto.conf
          echo "    # SSLå®‰å…¨é…ç½®" >> nginx-auto.conf
          echo "    ssl_protocols TLSv1.2 TLSv1.3;" >> nginx-auto.conf
          echo "    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;" >> nginx-auto.conf
          echo "    ssl_prefer_server_ciphers on;" >> nginx-auto.conf
          echo "    ssl_session_cache shared:SSL:10m;" >> nginx-auto.conf
          echo "    ssl_session_timeout 10m;" >> nginx-auto.conf
          echo "" >> nginx-auto.conf
          echo "    # å®‰å…¨å¤´" >> nginx-auto.conf
          echo "    add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains\" always;" >> nginx-auto.conf
          echo "    add_header X-Frame-Options SAMEORIGIN always;" >> nginx-auto.conf
          echo "    add_header X-Content-Type-Options nosniff always;" >> nginx-auto.conf
        else
          echo "    # HTTPé…ç½®" >> nginx-auto.conf
          echo "    listen ${NGINX_PORT};" >> nginx-auto.conf
          echo "    listen [::]:${NGINX_PORT};" >> nginx-auto.conf
          echo "    server_name $SERVER_NAMES;" >> nginx-auto.conf
        fi
        
        echo "" >> nginx-auto.conf
        
        # æ·»åŠ åå‘ä»£ç†çœŸå®IPå¤„ç†ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if [ "$BEHIND_PROXY" = "true" ]; then
          echo "    # åå‘ä»£ç†çœŸå®IPå¤„ç†" >> nginx-auto.conf
          echo "    set_real_ip_from ${PROXY_IP};" >> nginx-auto.conf
          echo "    real_ip_header X-Forwarded-For;" >> nginx-auto.conf
          echo "    real_ip_recursive on;" >> nginx-auto.conf
          echo "" >> nginx-auto.conf
        fi
        
        # Next.jsåº”ç”¨ä»£ç†é…ç½®
        echo "    # Next.jsåº”ç”¨ä»£ç†" >> nginx-auto.conf
        echo "    location / {" >> nginx-auto.conf
        echo "        proxy_pass http://localhost:${APP_PORT};" >> nginx-auto.conf
        echo "        proxy_http_version 1.1;" >> nginx-auto.conf
        echo "        proxy_set_header Upgrade \$http_upgrade;" >> nginx-auto.conf
        echo "        proxy_set_header Connection 'upgrade';" >> nginx-auto.conf
        echo "        proxy_set_header Host \$host;" >> nginx-auto.conf
        echo "        proxy_set_header X-Real-IP \$remote_addr;" >> nginx-auto.conf
        echo "        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;" >> nginx-auto.conf
        echo "        proxy_set_header X-Forwarded-Proto \$scheme;" >> nginx-auto.conf
        echo "        proxy_cache_bypass \$http_upgrade;" >> nginx-auto.conf
        echo "        proxy_buffering off;" >> nginx-auto.conf
        echo "        proxy_read_timeout 86400;" >> nginx-auto.conf
        echo "    }" >> nginx-auto.conf
        echo "" >> nginx-auto.conf
        
        # é™æ€èµ„æºä¼˜åŒ–
        echo "    # é™æ€èµ„æºä¼˜åŒ–" >> nginx-auto.conf
        echo "    location /_next/static/ {" >> nginx-auto.conf
        echo "        proxy_pass http://localhost:${APP_PORT};" >> nginx-auto.conf
        echo "        expires 1y;" >> nginx-auto.conf
        echo "        add_header Cache-Control \"public, immutable\";" >> nginx-auto.conf
        echo "    }" >> nginx-auto.conf
        echo "" >> nginx-auto.conf
        
        # å›¾ç‰‡ä¼˜åŒ–
        echo "    location ~* \\.(jpg|jpeg|png|gif|ico|svg|webp)\$ {" >> nginx-auto.conf
        echo "        proxy_pass http://localhost:${APP_PORT};" >> nginx-auto.conf
        echo "        expires 30d;" >> nginx-auto.conf
        echo "        add_header Cache-Control \"public, immutable\";" >> nginx-auto.conf
        echo "    }" >> nginx-auto.conf
        echo "" >> nginx-auto.conf
        
        # æ—¥å¿—é…ç½®
        echo "    # æ—¥å¿—é…ç½®" >> nginx-auto.conf
        echo "    access_log ${DEPLOY_PATH}/logs/nginx-access.log;" >> nginx-auto.conf
        echo "    error_log ${DEPLOY_PATH}/logs/nginx-error.log warn;" >> nginx-auto.conf
        echo "}" >> nginx-auto.conf
        
        echo "âœ… Nginxé…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
        echo ""
    
    - name: ğŸš€ éƒ¨ç½²Nginxé…ç½®
      if: inputs.deploy_mode == 'all'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "éƒ¨ç½²Nginxé…ç½®..."
        echo "==================================="
        
        # ç¡®ä¿éƒ¨ç½²ç›®å½•å­˜åœ¨
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          sudo mkdir -p ${{ env.DEPLOY_PATH }}
          sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} ${{ env.DEPLOY_PATH }}
          mkdir -p ${{ env.DEPLOY_PATH }}/logs
        "
        
        # ä¸Šä¼ é…ç½®æ–‡ä»¶åˆ°æœåŠ¡å™¨
        scp -o StrictHostKeyChecking=no -P ${{ env.SSH_PORT }} nginx-auto.conf \
          ${{ env.SSH_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/nginx-auto.conf
        
        # éƒ¨ç½²åˆ°Nginxç›®å½•
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
          set -e
          
          DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
          DEPLOY_ENVIRONMENT="${{ vars.DEPLOY_ENVIRONMENT || secrets.DEPLOY_ENVIRONMENT || 'local' }}"
          PRIMARY_DOMAIN="${{ vars.PRIMARY_DOMAIN || secrets.PRIMARY_DOMAIN || 'localhost' }}"
          USE_SSL="${{ vars.USE_SSL || secrets.USE_SSL || 'false' }}"
          SSL_EMAIL="${{ vars.SSL_EMAIL || secrets.SSL_EMAIL || '' }}"
          
          # å¤‡ä»½ç°æœ‰é…ç½®
          if [ -f /etc/nginx/sites-available/homelabs ]; then
            echo "å¤‡ä»½ç°æœ‰Nginxé…ç½®..."
            sudo cp /etc/nginx/sites-available/homelabs /etc/nginx/sites-available/homelabs.backup.$(date +%Y%m%d%H%M%S)
          fi
          
          # å¤åˆ¶æ–°é…ç½®
          echo "éƒ¨ç½²æ–°Nginxé…ç½®..."
          sudo cp $DEPLOY_PATH/nginx-auto.conf /etc/nginx/sites-available/homelabs
          
          # åˆ›å»ºç¬¦å·é“¾æ¥
          sudo ln -sf /etc/nginx/sites-available/homelabs /etc/nginx/sites-enabled/homelabs
          
          # åˆ é™¤é»˜è®¤ç«™ç‚¹ï¼ˆé¿å…å†²çªï¼‰
          if [ -f /etc/nginx/sites-enabled/default ]; then
            echo "åˆ é™¤é»˜è®¤Nginxç«™ç‚¹..."
            sudo rm -f /etc/nginx/sites-enabled/default
          fi
          
          # ç”Ÿäº§ç¯å¢ƒSSLè¯ä¹¦å¤„ç†
          if [ "$DEPLOY_ENVIRONMENT" = "production" ] && [ "$USE_SSL" = "true" ] && [ -n "$SSL_EMAIL" ]; then
            echo "å¤„ç†ç”Ÿäº§ç¯å¢ƒSSLè¯ä¹¦..."
            
            # æ£€æŸ¥certbotæ˜¯å¦å·²å®‰è£…
            if ! command -v certbot &> /dev/null; then
              echo "å®‰è£…certbot..."
              if command -v apt-get &> /dev/null; then
                sudo apt-get update
                sudo apt-get install -y certbot python3-certbot-nginx
              elif command -v yum &> /dev/null; then
                sudo yum install -y certbot python3-certbot-nginx
              fi
            fi
            
            # æ£€æŸ¥è¯ä¹¦æ˜¯å¦å­˜åœ¨
            if [ ! -f "/etc/letsencrypt/live/$PRIMARY_DOMAIN/fullchain.pem" ]; then
              echo "ç”³è¯·SSLè¯ä¹¦..."
              sudo certbot --nginx -d $PRIMARY_DOMAIN --email $SSL_EMAIL --agree-tos --non-interactive --redirect
              echo "âœ… SSLè¯ä¹¦ç”³è¯·å®Œæˆ"
            else
              echo "SSLè¯ä¹¦å·²å­˜åœ¨"
            fi
          fi
          
          # æµ‹è¯•é…ç½®
          echo "æµ‹è¯•Nginxé…ç½®..."
          sudo nginx -t
          
          # é‡è½½Nginx
          echo "é‡è½½NginxæœåŠ¡..."
          if sudo systemctl is-active --quiet nginx; then
            sudo systemctl reload nginx
          else
            sudo systemctl start nginx
          fi
          
          sudo systemctl enable nginx
          echo "âœ… Nginxé…ç½®éƒ¨ç½²å®Œæˆ"
        ENDSSH
        
        echo "âœ… Nginxéƒ¨ç½²æˆåŠŸ"
        echo ""
    
    - name: å¤‡ä»½å½“å‰ç‰ˆæœ¬
      if: inputs.deploy_mode != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
        echo "==================================="
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          BACKUP_DIR=${{ env.DEPLOY_PATH }}_backup_\$(date +%Y%m%d_%H%M%S)
          
          if [ -d ${{ env.DEPLOY_PATH }} ]; then
            echo 'ğŸ“¦ åˆ›å»ºå¤‡ä»½: '\$BACKUP_DIR
            
            # ä½¿ç”¨sudoåˆ›å»ºå¤‡ä»½ç›®å½•å¹¶è®¾ç½®æƒé™
            echo 'ğŸ” åˆ›å»ºå¤‡ä»½ç›®å½•ï¼ˆéœ€è¦sudoæƒé™ï¼‰...'
            sudo mkdir -p \$BACKUP_DIR
            sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} \$BACKUP_DIR
            
            # ä½¿ç”¨rsyncå¤‡ä»½ï¼ˆæ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼‰
            echo 'ğŸ”„ å¼€å§‹å¤‡ä»½...'
            rsync -aL \
              --exclude 'node_modules' \
              --exclude '.next' \
              --exclude 'logs' \
              --exclude '*.log' \
              --exclude '.git' \
              ${{ env.DEPLOY_PATH }}/ \$BACKUP_DIR/ || {
              echo 'âŒ å¤‡ä»½å¤±è´¥ï¼'
              sudo rm -rf \$BACKUP_DIR
              exit 1
            }
            
            # éªŒè¯å¤‡ä»½
            if [ -d \$BACKUP_DIR ] && [ \"\$(ls -A \$BACKUP_DIR 2>/dev/null)\" ]; then
              echo 'âœ… å¤‡ä»½éªŒè¯æˆåŠŸ'
              
              # ä¿ç•™æœ€è¿‘3ä¸ªå¤‡ä»½ï¼ˆæ¸…ç†æ—§å¤‡ä»½éœ€è¦sudoï¼‰
              echo 'ğŸ§¹ æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...'
              cd \$(dirname ${{ env.DEPLOY_PATH }})
              OLD_BACKUPS=\$(ls -dt ${{ env.DEPLOY_PATH }}_backup_* 2>/dev/null | tail -n +4)
              if [ -n "\$OLD_BACKUPS" ]; then
                BACKUP_COUNT=\$(echo "\$OLD_BACKUPS" | wc -l)
                echo "\$OLD_BACKUPS" | xargs sudo rm -rf
                echo "   å·²æ¸…ç† \$BACKUP_COUNT ä¸ªæ—§å¤‡ä»½"
              else
                echo "   æ— éœ€æ¸…ç†æ—§å¤‡ä»½"
              fi
              
              # è®°å½•å¤‡ä»½è·¯å¾„
              echo \$BACKUP_DIR > /tmp/homelabs_last_backup
              echo 'âœ… å¤‡ä»½å®Œæˆ'
            else
              echo 'âŒ å¤‡ä»½éªŒè¯å¤±è´¥ï¼'
              exit 1
            fi
          else
            echo 'âš ï¸  é¦–æ¬¡éƒ¨ç½²ï¼Œæ— éœ€å¤‡ä»½'
          fi
        "
    
    - name: åœæ­¢ç°æœ‰æœåŠ¡å¹¶æ¸…ç†
      if: inputs.deploy_mode != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "åœæ­¢ç°æœ‰æœåŠ¡å¹¶æ¸…ç†ç¯å¢ƒ..."
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          if [ -d ${{ env.DEPLOY_PATH }} ]; then
            cd ${{ env.DEPLOY_PATH }}
            
            echo '1ï¸âƒ£  åœæ­¢æ‰€æœ‰PM2è¿›ç¨‹...'
            pm2 stop all 2>/dev/null || true
            pm2 delete all 2>/dev/null || true
            pm2 kill 2>/dev/null || true
            
            echo '2ï¸âƒ£  æ¸…ç†PM2æŒä¹…åŒ–é…ç½®...'
            rm -f ~/.pm2/dump.pm2
            rm -rf ~/.pm2/logs/*
            rm -rf ~/.pm2/pids/*
            echo '   âœ… PM2é…ç½®å·²æ¸…ç†'
            
            echo '3ï¸âƒ£  æ¸…ç†ç¯å¢ƒå˜é‡æ–‡ä»¶...'
            rm -f .env .env.* 2>/dev/null || true
            rm -f client/.env client/.env.* 2>/dev/null || true
            echo '   âœ… ç¯å¢ƒæ–‡ä»¶å·²æ¸…ç†'
          fi
        "
    
    - name: åˆ›å»ºéƒ¨ç½²ç›®å½•
      if: inputs.deploy_mode != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "åˆ›å»ºéƒ¨ç½²ç›®å½•..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          sudo mkdir -p ${{ env.DEPLOY_PATH }}
          sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} ${{ env.DEPLOY_PATH }}
          mkdir -p ${{ env.DEPLOY_PATH }}/logs
        "
    
    - name: ä¼ è¾“ä»£ç åˆ°æœåŠ¡å™¨
      if: inputs.deploy_mode != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "ä¼ è¾“ä»£ç åˆ°æœåŠ¡å™¨..."
        echo "==================================="
        
        # ä½¿ç”¨rsyncä¼ è¾“ä»£ç 
        rsync -avz --delete \
          -e "ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }}" \
          --exclude 'node_modules' \
          --exclude '.git' \
          --exclude '.github' \
          --exclude '.next' \
          --exclude 'logs' \
          --exclude '*.log' \
          --exclude '.DS_Store' \
          --exclude '.env' \
          --exclude '.env*' \
          --exclude 'plan report' \
          --exclude 'progress report' \
          --exclude 'README.md' \
          --exclude 'PROJECT_MEMORY.md' \
          --exclude 'dev.sh' \
          --exclude 'dev.local' \
          ./ ${{ env.SSH_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/
        
        echo "âœ… ä»£ç ä¼ è¾“å®Œæˆ"
    
    - name: åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
      if: inputs.deploy_mode != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶..."
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.DEPLOY_PATH }}/client
          
          echo \"# =================== ç¯å¢ƒé…ç½® ===================\" > .env
          echo \"NODE_ENV=production\" >> .env
          echo \"\" >> .env
          
          echo \"# =================== æ•°æ®åº“é…ç½® ===================\" >> .env
          echo \"DATABASE_URL=postgresql://${{ vars.POSTGRES_USER || secrets.POSTGRES_USER || 'homelabs' }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/${{ vars.POSTGRES_DB || secrets.POSTGRES_DB || 'homelabs_portal' }}?schema=public\" >> .env
          echo \"\" >> .env
          
          echo \"# =================== NextAuthé…ç½® ===================\" >> .env
          echo \"NEXTAUTH_URL=${{ vars.NEXTAUTH_URL || secrets.NEXTAUTH_URL }}\" >> .env
          echo \"NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}\" >> .env
          echo \"\" >> .env
          
          echo \"# =================== åº”ç”¨é…ç½® ===================\" >> .env
          echo \"APP_URL=${{ vars.APP_URL || secrets.APP_URL }}\" >> .env
          echo \"PORT=${{ vars.APP_PORT || secrets.APP_PORT || '3000' }}\" >> .env
          echo \"\" >> .env
          
          echo \"# =================== æ—¥å¿—é…ç½® ===================\" >> .env
          echo \"LOG_LEVEL=${{ vars.LOG_LEVEL || secrets.LOG_LEVEL || 'info' }}\" >> .env
          
          echo \"âœ… ç¯å¢ƒé…ç½®æ–‡ä»¶å·²åˆ›å»º: ${{ env.DEPLOY_PATH }}/client/.env\"
        "
    
    - name: å®‰è£…ä¾èµ–å¹¶æ„å»º
      if: inputs.deploy_mode != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      timeout-minutes: 30
      run: |
        echo "==================================="
        echo "å®‰è£…ä¾èµ–å¹¶æ„å»ºåº”ç”¨..."
        echo "==================================="
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          cd ${{ env.DEPLOY_PATH }}/client
          
          echo "ğŸ“¥ å®‰è£…ä¾èµ–..."
          npm install --production=false
          
          echo "ğŸ”„ ç”ŸæˆPrismaå®¢æˆ·ç«¯..."
          npx prisma generate
          
          echo "ğŸ—„ï¸  è¿è¡Œæ•°æ®åº“è¿ç§»..."
          npx prisma db push --skip-generate
          
          echo "ğŸ”¨ æ„å»ºNext.jsåº”ç”¨..."
          npm run build
          
          echo "âœ… æ„å»ºå®Œæˆ"
        '
    
    - name: å¯åŠ¨åº”ç”¨æœåŠ¡
      if: inputs.deploy_mode != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "å¯åŠ¨åº”ç”¨æœåŠ¡..."
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.DEPLOY_PATH }}/client
          
          # ä½¿ç”¨PM2å¯åŠ¨Next.jsç”Ÿäº§æœåŠ¡å™¨
          # æ—¥å¿—ç”±Winstonç»Ÿä¸€ç®¡ç†ï¼ŒPM2åªè´Ÿè´£è¿›ç¨‹ç®¡ç†å’Œç›‘æ§
          # æ˜¾å¼ä¼ é€’PORTç¯å¢ƒå˜é‡
          PORT=${{ vars.APP_PORT || secrets.APP_PORT || '3000' }} pm2 start npm --name homelabs-portal \
            --log ${{ env.DEPLOY_PATH }}/logs/pm2-combined.log \
            --error ${{ env.DEPLOY_PATH }}/logs/pm2-error.log \
            --time \
            --merge-logs \
            -- start
          
          pm2 save
          pm2 startup || echo 'âš ï¸  pm2 startupéœ€è¦æ‰‹åŠ¨é…ç½®sudoæƒé™'
          
          echo 'âœ… åº”ç”¨æœåŠ¡å·²å¯åŠ¨'
          echo ''
          echo 'ğŸ“Š æ—¥å¿—ä½ç½®:'
          echo '   åº”ç”¨æ—¥å¿—: ${{ env.DEPLOY_PATH }}/logs/combined-*.log (Winstonç»Ÿä¸€æ—¥å¿—)'
          echo '   é”™è¯¯æ—¥å¿—: ${{ env.DEPLOY_PATH }}/logs/error-*.log'
          echo '   PM2ç›‘æ§: ${{ env.DEPLOY_PATH }}/logs/pm2-*.log (ä»…PM2å…ƒæ•°æ®)'
          echo '   Nginxè®¿é—®: ${{ env.DEPLOY_PATH }}/logs/nginx-access.log'
          echo ''
          echo 'ğŸ“– æŸ¥çœ‹æ—¥å¿—:'
          echo '   å®æ—¶ç›‘æ§: tail -f ${{ env.DEPLOY_PATH }}/logs/combined-*.log'
          echo '   é”™è¯¯è¿½è¸ª: tail -f ${{ env.DEPLOY_PATH }}/logs/error-*.log'
          echo '   PM2çŠ¶æ€: pm2 logs homelabs-portal'
        "
    
    - name: éªŒè¯éƒ¨ç½²
      if: inputs.deploy_mode != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "éªŒè¯éƒ¨ç½²..."
        echo "==================================="
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 10
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          echo '1. PM2æœåŠ¡çŠ¶æ€:'
          pm2 status
          
          echo ''
          echo '2. æ£€æŸ¥åº”ç”¨ç«¯å£:'
          sudo ss -tlnp | grep :3000 || echo 'åº”ç”¨ç«¯å£3000æœªç›‘å¬'
          
          echo ''
          echo '3. æ£€æŸ¥PostgreSQL:'
          sudo systemctl status postgresql | head -5
          
          echo ''
          echo '4. æµ‹è¯•åº”ç”¨è®¿é—®:'
          if curl -f -s http://localhost:3000 > /dev/null 2>&1; then
            echo 'âœ… åº”ç”¨å“åº”æ­£å¸¸'
          else
            echo 'âš ï¸  åº”ç”¨æœªå“åº”'
          fi
        "
        
        echo ""
        echo "==================================="
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        echo "==================================="
        echo "è®¿é—®åœ°å€: http://${{ env.SERVER_HOST }}"
        echo ""
        echo "ğŸ“Š æŸ¥çœ‹æ—¥å¿— (æ‰€æœ‰æ—¥å¿—å·²ç»Ÿä¸€åˆ° ${{ env.DEPLOY_PATH }}/logs/):"
        echo "  åº”ç”¨æ—¥å¿—: tail -f ${{ env.DEPLOY_PATH }}/logs/combined-*.log"
        echo "  é”™è¯¯æ—¥å¿—: tail -f ${{ env.DEPLOY_PATH }}/logs/error-*.log"
        echo "  Nginxè®¿é—®: tail -f ${{ env.DEPLOY_PATH }}/logs/nginx-access.log"
        echo "  PM2ç›‘æ§: pm2 logs homelabs-portal"
    
    - name: æ¸…ç†å’Œå›æ»šï¼ˆå¤±è´¥æ—¶ï¼‰
      if: ${{ failure() && inputs.deploy_mode != 'check' }}
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "âš ï¸  éƒ¨ç½²å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š..."
        echo "==================================="
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          # åœæ­¢å¤±è´¥çš„æœåŠ¡
          pm2 stop all 2>/dev/null || true
          pm2 delete all 2>/dev/null || true
          
          # æ£€æŸ¥å¤‡ä»½å¹¶å›æ»š
          if [ -f /tmp/homelabs_last_backup ]; then
            BACKUP_DIR=$(cat /tmp/homelabs_last_backup)
            
            if [ -d "$BACKUP_DIR" ]; then
              echo "å‘ç°å¤‡ä»½: $BACKUP_DIR"
              echo "æ­£åœ¨å›æ»š..."
              
              # ä½¿ç”¨sudoè¿›è¡Œå›æ»šæ“ä½œ
              sudo rm -rf ${{ env.DEPLOY_PATH }}
              sudo mv $BACKUP_DIR ${{ env.DEPLOY_PATH }}
              sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} ${{ env.DEPLOY_PATH }}
              
              # å°è¯•é‡å¯æ—§ç‰ˆæœ¬
              cd ${{ env.DEPLOY_PATH }}/client
              pm2 start npm --name homelabs-portal -- start 2>/dev/null || true
              pm2 save
              
              echo "âœ… å·²å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬"
            fi
          fi
        '

