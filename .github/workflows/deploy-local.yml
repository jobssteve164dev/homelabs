
name: æœ¬åœ°ç¯å¢ƒéƒ¨ç½²ï¼ˆéDockerï¼‰

on:
  # ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼Œå·²å…³é—­è‡ªåŠ¨è§¦å‘æœºåˆ¶
  # å¦‚éœ€è‡ªåŠ¨è§¦å‘ï¼Œè¯·å–æ¶ˆæ³¨é‡Šä»¥ä¸‹é…ç½®ï¼š
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'changelog.md'
  
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: 'éƒ¨ç½²æ¨¡å¼'
        required: true
        default: 'all'
        type: choice
        options:
          - all          # å…¨éƒ¨éƒ¨ç½²
          - app-only     # ä»…åº”ç”¨
          - check        # ä»…æ£€æŸ¥ç¯å¢ƒ

jobs:
  deploy-local:
    runs-on: ubuntu-latest
    
    steps:
    - name: è®¾ç½®éƒ¨ç½²æ¨¡å¼
      id: set_deploy_mode
      run: |
        # æ‰‹åŠ¨è§¦å‘ï¼Œä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„æ¨¡å¼
        echo "DEPLOY_MODE=${{ inputs.deploy_mode }}" >> $GITHUB_ENV
        echo "ğŸ“ éƒ¨ç½²æ¨¡å¼: ${{ inputs.deploy_mode }}"
    
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®æœåŠ¡å™¨é…ç½®
      id: server_config
      run: |
        # è·å–éƒ¨ç½²ç¯å¢ƒ
        DEPLOY_ENVIRONMENT="${{ vars.DEPLOY_ENVIRONMENT || secrets.DEPLOY_ENVIRONMENT || 'local' }}"
        echo "DEPLOY_ENVIRONMENT=$DEPLOY_ENVIRONMENT" >> $GITHUB_ENV
        
        # æ ¹æ®ç¯å¢ƒé€‰æ‹©æœåŠ¡å™¨é…ç½®
        if [ "$DEPLOY_ENVIRONMENT" = "production" ]; then
          echo "ğŸ­ ä½¿ç”¨ç”Ÿäº§æœåŠ¡å™¨é…ç½®"
          SERVER_HOST="${{ vars.SERVER_HOST_PROD || secrets.SERVER_HOST_PROD || vars.SERVER_HOST || secrets.SERVER_HOST }}"
          SSH_PORT="${{ vars.SSH_PORT_PROD || secrets.SSH_PORT_PROD || vars.SSH_PORT || secrets.SSH_PORT || '22' }}"
          SSH_USER="${{ vars.SSH_USER_PROD || secrets.SSH_USER_PROD || vars.SSH_USER || secrets.SSH_USER }}"
          DEPLOY_PATH="${{ vars.DEPLOY_PATH_PROD || secrets.DEPLOY_PATH_PROD || vars.DEPLOY_PATH || secrets.DEPLOY_PATH || '/opt/homelabs' }}"
        else
          echo "ğŸ  ä½¿ç”¨æµ‹è¯•æœåŠ¡å™¨é…ç½®ï¼ˆHomelabï¼‰"
          SERVER_HOST="${{ vars.SERVER_HOST || secrets.SERVER_HOST }}"
          SSH_PORT="${{ vars.SSH_PORT || secrets.SSH_PORT || '22' }}"
          SSH_USER="${{ vars.SSH_USER || secrets.SSH_USER }}"
          DEPLOY_PATH="${{ vars.DEPLOY_PATH || secrets.DEPLOY_PATH || '/opt/homelabs' }}"
        fi
        
        # è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå•è¡Œå˜é‡ï¼‰
        echo "SERVER_HOST=$SERVER_HOST" >> $GITHUB_ENV
        echo "SSH_PORT=$SSH_PORT" >> $GITHUB_ENV
        echo "SSH_USER=$SSH_USER" >> $GITHUB_ENV
        echo "DEPLOY_PATH=$DEPLOY_PATH" >> $GITHUB_ENV
        
        echo ""
        echo "ğŸ“‹ æœåŠ¡å™¨é…ç½®:"
        echo "  ç¯å¢ƒ: $DEPLOY_ENVIRONMENT"
        echo "  ä¸»æœº: $SERVER_HOST"
        echo "  ç«¯å£: $SSH_PORT"
        echo "  ç”¨æˆ·: $SSH_USER"
        echo "  è·¯å¾„: $DEPLOY_PATH"
    
    - name: è®¾ç½®SSHå¯†é’¥
      id: set_ssh_key
      run: |
        DEPLOY_ENVIRONMENT="${{ vars.DEPLOY_ENVIRONMENT || secrets.DEPLOY_ENVIRONMENT || 'local' }}"
        if [ "$DEPLOY_ENVIRONMENT" = "production" ]; then
          echo "ä½¿ç”¨ç”Ÿäº§æœåŠ¡å™¨SSHå¯†é’¥"
          SSH_KEY_CONTENT="${{ secrets.SERVER_SSH_KEY_PROD || secrets.SERVER_SSH_KEY }}"
        else
          echo "ä½¿ç”¨æµ‹è¯•æœåŠ¡å™¨SSHå¯†é’¥"
          SSH_KEY_CONTENT="${{ secrets.SERVER_SSH_KEY }}"
        fi
        # ä½¿ç”¨å¤šè¡Œæ ¼å¼è®¾ç½®ç¯å¢ƒå˜é‡
        {
          echo "SSH_KEY_CONTENT<<EOF"
          echo "$SSH_KEY_CONTENT"
          echo "EOF"
        } >> $GITHUB_ENV
    
    - name: é…ç½®SSH Agent
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ env.SSH_KEY_CONTENT }}
        ssh-auth-sock: ${{ github.workspace }}/ssh-auth.sock
    
    - name: æ£€æŸ¥å¹¶å®‰è£…æœåŠ¡å™¨ç¯å¢ƒ
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "æ£€æŸ¥å¹¶å‡†å¤‡æœåŠ¡å™¨ç¯å¢ƒ..."
        echo "==================================="
        echo ""
        
        # æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹
        echo "æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹..."
        OS_TYPE=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          if [ -f /etc/os-release ]; then
            . /etc/os-release
            echo \$ID
          elif [ -f /etc/redhat-release ]; then
            echo 'rhel'
          else
            echo 'unknown'
          fi
        ")
        echo "ğŸ“‹ æ£€æµ‹åˆ°æ“ä½œç³»ç»Ÿ: $OS_TYPE"
        echo ""
        
        # ========================================
        # 1. æ£€æŸ¥å¹¶å®‰è£… Node.js
        # ========================================
        echo "-----------------------------------"
        echo "1ï¸âƒ£  æ£€æŸ¥ Node.js..."
        echo "-----------------------------------"
        if ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "command -v node &> /dev/null"; then
          NODE_VERSION=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "node --version" 2>/dev/null || echo "v0.0.0")
          NODE_MAJOR=$(echo $NODE_VERSION | cut -d'v' -f2 | cut -d'.' -f1)
          echo "âœ… Node.jså·²å®‰è£…: $NODE_VERSION"
          
          if [ "$NODE_MAJOR" -lt 18 ]; then
            echo "âš ï¸  Node.jsç‰ˆæœ¬è¿‡ä½ (éœ€è¦ >= 18)ï¼Œå°†é‡æ–°å®‰è£…..."
            
            if [ "$OS_TYPE" = "amzn" ]; then
              echo "ä½¿ç”¨NodeSourceä»“åº“å‡çº§åˆ°Node.js 20 (Amazon Linux 2)..."
              ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
                'sudo yum remove -y nodejs npm nodesource-release 2>/dev/null || true && \
                sudo rm -rf /etc/yum.repos.d/nodesource*.repo && \
                sudo yum clean all && \
                curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash - && \
                sudo yum install -y nodejs && \
                node --version && \
                npm --version'
            else
              echo "ä½¿ç”¨NodeSourceä»“åº“å‡çº§åˆ°Node.js 20..."
              ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
                'curl -fsSL https://deb.nodesource.com/setup_20.x | sudo bash - && \
                sudo apt-get remove -y nodejs npm 2>/dev/null || true && \
                sudo apt-get install -y nodejs && \
                node --version && \
                npm --version'
            fi
            
            echo "âœ… Node.jså‡çº§å®Œæˆ"
          fi
        else
          echo "ğŸ“¦ Node.jsæœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
          
          if [ "$OS_TYPE" = "amzn" ]; then
            echo "æ£€æµ‹åˆ°Amazon Linux 2ï¼Œå®‰è£…Node.js 20..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
              'sudo rm -rf /etc/yum.repos.d/nodesource*.repo && \
              sudo yum clean all && \
              curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash - && \
              sudo yum install -y nodejs && \
              node --version && \
              npm --version'
          else
            echo "æ£€æµ‹åˆ°Ubuntu/Debianï¼Œå®‰è£…Node.js 20..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
              'curl -fsSL https://deb.nodesource.com/setup_20.x | sudo bash - && \
              sudo apt-get install -y nodejs && \
              node --version && \
              npm --version'
          fi
          
          echo "âœ… Node.jså®‰è£…å®Œæˆ"
        fi
        echo ""
        
        # ========================================
        # 2. æ£€æŸ¥å¹¶å®‰è£… PM2
        # ========================================
        echo "-----------------------------------"
        echo "2ï¸âƒ£  æ£€æŸ¥ PM2..."
        echo "-----------------------------------"
        if ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "command -v pm2 &> /dev/null"; then
          PM2_VERSION=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "pm2 --version")
          echo "âœ… PM2å·²å®‰è£…: $PM2_VERSION"
        else
          echo "ğŸ“¦ PM2æœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
            'sudo npm install -g pm2 && pm2 --version'
          echo "âœ… PM2å®‰è£…å®Œæˆ"
        fi
        echo ""
        
        # ========================================
        # 3. æ£€æŸ¥å¹¶å®‰è£… PostgreSQL
        # ========================================
        echo "-----------------------------------"
        echo "3ï¸âƒ£  æ£€æŸ¥ PostgreSQL..."
        echo "-----------------------------------"
        if ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "command -v psql &> /dev/null"; then
          PG_VERSION=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "psql --version | head -1")
          echo "âœ… PostgreSQLå·²å®‰è£…: $PG_VERSION"
        else
          echo "ğŸ“¦ PostgreSQLæœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
          
          if [ "$OS_TYPE" = "amzn" ]; then
            echo "æ£€æµ‹åˆ°Amazon Linuxç³»ç»Ÿï¼Œä½¿ç”¨yumå®‰è£…..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
              'sudo amazon-linux-extras install postgresql15 -y && \
              sudo yum install -y postgresql-server postgresql-contrib && \
              sudo postgresql-setup initdb && \
              sudo systemctl start postgresql && \
              sudo systemctl enable postgresql && \
              psql --version'
          elif [ "$OS_TYPE" = "ubuntu" ] || [ "$OS_TYPE" = "debian" ]; then
            echo "æ£€æµ‹åˆ°Ubuntu/Debianç³»ç»Ÿï¼Œä½¿ç”¨aptå®‰è£…..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
              sudo apt-get update
              sudo apt-get install -y postgresql postgresql-contrib
              sudo systemctl start postgresql
              sudo systemctl enable postgresql
              psql --version
            '
          else
            echo "âš ï¸  æœªè¯†åˆ«çš„æ“ä½œç³»ç»Ÿç±»å‹: $OS_TYPE"
            echo "è¯·æ‰‹åŠ¨å®‰è£…PostgreSQL: https://www.postgresql.org/download/"
            exit 1
          fi
          
          echo "âœ… PostgreSQLå®‰è£…å®Œæˆ"
        fi
        
        # ç¡®ä¿PostgreSQLæœåŠ¡æ­£åœ¨è¿è¡Œ
        echo "æ£€æŸ¥PostgreSQLæœåŠ¡çŠ¶æ€..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          if ! sudo systemctl is-active --quiet postgresql; then
            echo 'å¯åŠ¨PostgreSQLæœåŠ¡...'
            sudo systemctl start postgresql
            sudo systemctl enable postgresql
            sleep 3
          fi
          sudo systemctl status postgresql | head -5
        "
        echo ""
        
        # ========================================
        # 3.1 åˆ›å»ºæˆ–æ›´æ–°PostgreSQLæ•°æ®åº“å’Œç”¨æˆ·
        # ========================================
        echo "-----------------------------------"
        echo "3.1ï¸âƒ£  åˆ›å»ºæˆ–æ›´æ–°PostgreSQLæ•°æ®åº“å’Œç”¨æˆ·..."
        echo "-----------------------------------"
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          DB_NAME="${{ vars.POSTGRES_DB || secrets.POSTGRES_DB || 'homelabs_portal' }}"
          DB_USER="${{ vars.POSTGRES_USER || secrets.POSTGRES_USER || 'homelabs' }}"
          DB_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}"
          
          echo "é…ç½®æ•°æ®åº“: $DB_NAME"
          echo "é…ç½®ç”¨æˆ·: $DB_USER"
          
          # åˆ‡æ¢åˆ°/tmpç›®å½•é¿å…æƒé™è­¦å‘Š
          cd /tmp
          
          # åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·
          sudo -u postgres psql -c "
            DO \$\$
            BEGIN
              IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '"'"'$DB_USER'"'"') THEN
                CREATE USER $DB_USER WITH PASSWORD '"'"'$DB_PASSWORD'"'"';
                RAISE NOTICE '"'"'ç”¨æˆ· % å·²åˆ›å»º'"'"', '"'"'$DB_USER'"'"';
              ELSE
                ALTER USER $DB_USER WITH PASSWORD '"'"'$DB_PASSWORD'"'"';
                RAISE NOTICE '"'"'ç”¨æˆ· % å¯†ç å·²æ›´æ–°'"'"', '"'"'$DB_USER'"'"';
              END IF;
            END
            \$\$;
          " || echo "è­¦å‘Š: ç”¨æˆ·é…ç½®å¯èƒ½å¤±è´¥"
          
          # åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname = '"'"'$DB_NAME'"'"'" | grep -q 1 || \
            sudo -u postgres psql -c "CREATE DATABASE $DB_NAME OWNER $DB_USER"
          
          # æˆäºˆæƒé™
          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER"
          sudo -u postgres psql -c "ALTER USER $DB_USER CREATEDB"
          
          echo "âœ… PostgreSQLæ•°æ®åº“å’Œç”¨æˆ·é…ç½®å®Œæˆ"
        '
        
        echo ""
        
        # ========================================
        # 4. æ£€æŸ¥å¹¶å®‰è£…jq
        # ========================================
        echo "-----------------------------------"
        echo "4ï¸âƒ£  æ£€æŸ¥å¹¶å®‰è£…jq..."
        echo "-----------------------------------"
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          if ! command -v jq &> /dev/null; then
            echo "ğŸ“¦ jqæœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
            if command -v apt-get &> /dev/null; then
              sudo apt-get update -y && sudo apt-get install -y jq
            elif command -v yum &> /dev/null; then
              sudo yum install -y jq
            else
              echo "âš ï¸ æ— æ³•è‡ªåŠ¨å®‰è£…jqï¼Œè¯·æ‰‹åŠ¨å®‰è£…"
              exit 1
            fi
            echo "âœ… jqå®‰è£…å®Œæˆ"
          else
            echo "âœ… jqå·²å®‰è£…"
          fi
        '
        echo ""
        
        # ========================================
        # 5. æœ€ç»ˆéªŒè¯
        # ========================================
        echo "==================================="
        echo "ğŸ“Š ç¯å¢ƒæœ€ç»ˆéªŒè¯"
        echo "==================================="
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} <<'ENV_VERIFY'
          echo 'âœ… Node.jsç‰ˆæœ¬:'
          node --version
          
          echo 'âœ… npmç‰ˆæœ¬:'
          npm --version
          
          echo 'âœ… PM2ç‰ˆæœ¬:'
          pm2 --version
          
          echo 'âœ… PostgreSQLæœåŠ¡:'
          sudo systemctl is-active postgresql && echo 'PostgreSQLè¿è¡Œä¸­' || echo 'PostgreSQLæœªè¿è¡Œ'
          
          echo 'âœ… PostgreSQLç‰ˆæœ¬:'
          psql --version
        ENV_VERIFY
        
        echo ""
        echo "==================================="
        echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆï¼"
        echo "==================================="
    
    # ========================================
    # Nginxè‡ªåŠ¨é…ç½®æ­¥éª¤
    # ========================================
    
    - name: ğŸ”§ æ£€æŸ¥å¹¶å®‰è£…Nginx
      if: env.DEPLOY_MODE == 'all'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "æ£€æŸ¥å¹¶å®‰è£…Nginx..."
        echo "==================================="
        
        if ! ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "command -v nginx &> /dev/null"; then
          echo "ğŸ“¦ Nginxæœªå®‰è£…ï¼Œå¼€å§‹å®‰è£…..."
          
          OS_TYPE=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
            if [ -f /etc/os-release ]; then
              . /etc/os-release
              echo \$ID
            else
              echo 'unknown'
            fi
          ")
          
          if [ "$OS_TYPE" = "ubuntu" ] || [ "$OS_TYPE" = "debian" ]; then
            echo "ä½¿ç”¨aptå®‰è£…Nginx..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
              "sudo apt update && sudo apt install -y nginx"
          elif [ "$OS_TYPE" = "centos" ] || [ "$OS_TYPE" = "rhel" ] || [ "$OS_TYPE" = "amzn" ]; then
            echo "ä½¿ç”¨yumå®‰è£…Nginx..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
              "sudo yum install -y epel-release && sudo yum install -y nginx"
          else
            echo "âŒ ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: $OS_TYPE"
            echo "è¯·æ‰‹åŠ¨å®‰è£…Nginx"
            exit 1
          fi
          
          # å¯åŠ¨Nginx
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
            "sudo systemctl start nginx && sudo systemctl enable nginx"
          
          echo "âœ… Nginxå®‰è£…å®Œæˆ"
        else
          echo "âœ… Nginxå·²å®‰è£…"
          NGINX_VERSION=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "nginx -v 2>&1")
          echo "   ç‰ˆæœ¬: $NGINX_VERSION"
        fi
        
        echo ""
    
    - name: ğŸ“ ç”ŸæˆNginxé…ç½®æ–‡ä»¶
      if: env.DEPLOY_MODE == 'all'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
        DEPLOY_ENVIRONMENT: ${{ vars.DEPLOY_ENVIRONMENT || secrets.DEPLOY_ENVIRONMENT || 'local' }}
        PRIMARY_DOMAIN: ${{ vars.PRIMARY_DOMAIN || secrets.PRIMARY_DOMAIN || 'localhost' }}
        ADDITIONAL_DOMAINS: ${{ vars.ADDITIONAL_DOMAINS || secrets.ADDITIONAL_DOMAINS || '' }}
        USE_SSL: ${{ vars.USE_SSL || secrets.USE_SSL || 'false' }}
        NGINX_PORT: ${{ vars.NGINX_PORT || secrets.NGINX_PORT || '80' }}
        BEHIND_PROXY: ${{ vars.BEHIND_PROXY || secrets.BEHIND_PROXY || 'false' }}
        PROXY_REAL_IP_FROM: ${{ vars.PROXY_REAL_IP_FROM || secrets.PROXY_REAL_IP_FROM || '192.168.0.0/16' }}
        APP_PORT: ${{ vars.APP_PORT || secrets.APP_PORT || '3000' }}
        DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
      run: |
        # ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
        chmod +x .github/scripts/generate-nginx-config.sh
        
        # è¿è¡Œè„šæœ¬ç”Ÿæˆé…ç½®æ–‡ä»¶
        ./.github/scripts/generate-nginx-config.sh nginx-auto.conf
    
    - name: ğŸš€ éƒ¨ç½²Nginxé…ç½®
      if: env.DEPLOY_MODE == 'all'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "éƒ¨ç½²Nginxé…ç½®..."
        echo "==================================="
        
        # ç¡®ä¿éƒ¨ç½²ç›®å½•å­˜åœ¨
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          sudo mkdir -p ${{ env.DEPLOY_PATH }}
          sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} ${{ env.DEPLOY_PATH }}
          mkdir -p ${{ env.DEPLOY_PATH }}/logs
        "
        
        # ä¸Šä¼ é…ç½®æ–‡ä»¶åˆ°æœåŠ¡å™¨
        scp -o StrictHostKeyChecking=no -P ${{ env.SSH_PORT }} nginx-auto.conf \
          ${{ env.SSH_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/nginx-auto.conf
        
        # éƒ¨ç½²åˆ°Nginxç›®å½•
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
          set -e
          
          DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
          DEPLOY_ENVIRONMENT="${{ vars.DEPLOY_ENVIRONMENT || secrets.DEPLOY_ENVIRONMENT || 'local' }}"
          PRIMARY_DOMAIN="${{ vars.PRIMARY_DOMAIN || secrets.PRIMARY_DOMAIN || 'localhost' }}"
          USE_SSL="${{ vars.USE_SSL || secrets.USE_SSL || 'false' }}"
          SSL_EMAIL="${{ vars.SSL_EMAIL || secrets.SSL_EMAIL || '' }}"
          
          # å¤‡ä»½ç°æœ‰é…ç½®
          if [ -f /etc/nginx/sites-available/homelabs ]; then
            echo "å¤‡ä»½ç°æœ‰Nginxé…ç½®..."
            sudo cp /etc/nginx/sites-available/homelabs /etc/nginx/sites-available/homelabs.backup.$(date +%Y%m%d%H%M%S)
          fi
          
          # å¤åˆ¶æ–°é…ç½®
          echo "éƒ¨ç½²æ–°Nginxé…ç½®..."
          sudo cp $DEPLOY_PATH/nginx-auto.conf /etc/nginx/sites-available/homelabs
          
          # åˆ›å»ºç¬¦å·é“¾æ¥
          sudo ln -sf /etc/nginx/sites-available/homelabs /etc/nginx/sites-enabled/homelabs
          
          # åˆ é™¤é»˜è®¤ç«™ç‚¹ï¼ˆé¿å…å†²çªï¼‰
          if [ -f /etc/nginx/sites-enabled/default ]; then
            echo "åˆ é™¤é»˜è®¤Nginxç«™ç‚¹..."
            sudo rm -f /etc/nginx/sites-enabled/default
          fi
          
          # ç”Ÿäº§ç¯å¢ƒSSLè¯ä¹¦å¤„ç†
          if [ "$DEPLOY_ENVIRONMENT" = "production" ] && [ "$USE_SSL" = "true" ] && [ -n "$SSL_EMAIL" ]; then
            echo "å¤„ç†ç”Ÿäº§ç¯å¢ƒSSLè¯ä¹¦..."
            
            # æ£€æŸ¥certbotæ˜¯å¦å·²å®‰è£…
            if ! command -v certbot &> /dev/null; then
              echo "å®‰è£…certbot..."
              if command -v apt-get &> /dev/null; then
                sudo apt-get update
                sudo apt-get install -y certbot python3-certbot-nginx
              elif command -v yum &> /dev/null; then
                sudo yum install -y certbot python3-certbot-nginx
              fi
            fi
            
            # æ£€æŸ¥è¯ä¹¦æ˜¯å¦å­˜åœ¨
            if [ ! -f "/etc/letsencrypt/live/$PRIMARY_DOMAIN/fullchain.pem" ]; then
              echo "ç”³è¯·SSLè¯ä¹¦..."
              sudo certbot --nginx -d $PRIMARY_DOMAIN --email $SSL_EMAIL --agree-tos --non-interactive --redirect
              echo "âœ… SSLè¯ä¹¦ç”³è¯·å®Œæˆ"
            else
              echo "SSLè¯ä¹¦å·²å­˜åœ¨"
            fi
          fi
          
          # ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨ä¸”Nginxæœ‰æƒé™
          echo "åˆ›å»ºæ—¥å¿—ç›®å½•..."
          sudo mkdir -p $DEPLOY_PATH/logs
          sudo chown -R www-data:www-data $DEPLOY_PATH/logs 2>/dev/null || sudo chown -R nginx:nginx $DEPLOY_PATH/logs 2>/dev/null || true
          sudo chmod 755 $DEPLOY_PATH/logs
          
          # éªŒè¯é…ç½®æ–‡ä»¶ä¸­çš„æ—¥å¿—è·¯å¾„
          echo "éªŒè¯é…ç½®æ–‡ä»¶ä¸­çš„æ—¥å¿—è·¯å¾„..."
          grep -E "(access_log|error_log)" /etc/nginx/sites-available/homelabs || true
          
          # æµ‹è¯•é…ç½®
          echo "æµ‹è¯•Nginxé…ç½®..."
          if ! sudo nginx -t; then
            echo "âŒ Nginxé…ç½®æµ‹è¯•å¤±è´¥ï¼"
            echo "æŸ¥çœ‹é…ç½®é”™è¯¯:"
            sudo nginx -t 2>&1
            echo ""
            echo "æŸ¥çœ‹é…ç½®æ–‡ä»¶å†…å®¹:"
            cat /etc/nginx/sites-available/homelabs | tail -20
            exit 1
          fi
          
          # é‡è½½Nginx
          echo "é‡è½½NginxæœåŠ¡..."
          if sudo systemctl is-active --quiet nginx; then
            sudo systemctl reload nginx
          else
            sudo systemctl start nginx
          fi
          
          sudo systemctl enable nginx
          echo "âœ… Nginxé…ç½®éƒ¨ç½²å®Œæˆ"
        ENDSSH
        
        echo "âœ… Nginxéƒ¨ç½²æˆåŠŸ"
        echo ""
    
    - name: å¤‡ä»½å½“å‰ç‰ˆæœ¬
      if: env.DEPLOY_MODE != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
        echo "==================================="
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          BACKUP_DIR=${{ env.DEPLOY_PATH }}_backup_\$(date +%Y%m%d_%H%M%S)
          
          if [ -d ${{ env.DEPLOY_PATH }} ]; then
            echo 'ğŸ“¦ åˆ›å»ºå¤‡ä»½: '\$BACKUP_DIR
            
            # ä½¿ç”¨sudoåˆ›å»ºå¤‡ä»½ç›®å½•å¹¶è®¾ç½®æƒé™
            echo 'ğŸ” åˆ›å»ºå¤‡ä»½ç›®å½•ï¼ˆéœ€è¦sudoæƒé™ï¼‰...'
            sudo mkdir -p \$BACKUP_DIR
            sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} \$BACKUP_DIR
            
            # ä½¿ç”¨rsyncå¤‡ä»½ï¼ˆæ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼‰
            echo 'ğŸ”„ å¼€å§‹å¤‡ä»½...'
            rsync -aL \
              --exclude 'node_modules' \
              --exclude '.next' \
              --exclude 'logs' \
              --exclude '*.log' \
              --exclude '.git' \
              ${{ env.DEPLOY_PATH }}/ \$BACKUP_DIR/ || {
              echo 'âŒ å¤‡ä»½å¤±è´¥ï¼'
              sudo rm -rf \$BACKUP_DIR
              exit 1
            }
            
            # éªŒè¯å¤‡ä»½
            if [ -d \$BACKUP_DIR ] && [ \"\$(ls -A \$BACKUP_DIR 2>/dev/null)\" ]; then
              echo 'âœ… å¤‡ä»½éªŒè¯æˆåŠŸ'
              
              # ä¿ç•™æœ€è¿‘3ä¸ªå¤‡ä»½ï¼ˆæ¸…ç†æ—§å¤‡ä»½éœ€è¦sudoï¼‰
              echo 'ğŸ§¹ æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªï¼‰...'
              cd \$(dirname ${{ env.DEPLOY_PATH }})
              OLD_BACKUPS=\$(ls -dt ${{ env.DEPLOY_PATH }}_backup_* 2>/dev/null | tail -n +4)
              if [ -n "\$OLD_BACKUPS" ]; then
                BACKUP_COUNT=\$(echo "\$OLD_BACKUPS" | wc -l)
                echo "\$OLD_BACKUPS" | xargs sudo rm -rf
                echo "   å·²æ¸…ç† \$BACKUP_COUNT ä¸ªæ—§å¤‡ä»½"
              else
                echo "   æ— éœ€æ¸…ç†æ—§å¤‡ä»½"
              fi
              
              # è®°å½•å¤‡ä»½è·¯å¾„
              echo \$BACKUP_DIR > /tmp/homelabs_last_backup
              echo 'âœ… å¤‡ä»½å®Œæˆ'
            else
              echo 'âŒ å¤‡ä»½éªŒè¯å¤±è´¥ï¼'
              exit 1
            fi
          else
            echo 'âš ï¸  é¦–æ¬¡éƒ¨ç½²ï¼Œæ— éœ€å¤‡ä»½'
          fi
        "
    
    - name: åœæ­¢ç°æœ‰æœåŠ¡å¹¶æ¸…ç†
      if: env.DEPLOY_MODE != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "åœæ­¢ç°æœ‰æœåŠ¡å¹¶æ¸…ç†ç¯å¢ƒ..."
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          if [ -d ${{ env.DEPLOY_PATH }} ]; then
            cd ${{ env.DEPLOY_PATH }}
            
            echo '1ï¸âƒ£  åœæ­¢æ‰€æœ‰PM2è¿›ç¨‹...'
            pm2 stop all 2>/dev/null || true
            pm2 delete all 2>/dev/null || true
            pm2 kill 2>/dev/null || true
            
            echo '2ï¸âƒ£  æ¸…ç†PM2æŒä¹…åŒ–é…ç½®...'
            rm -f ~/.pm2/dump.pm2
            rm -rf ~/.pm2/logs/*
            rm -rf ~/.pm2/pids/*
            echo '   âœ… PM2é…ç½®å·²æ¸…ç†'
            
            echo '3ï¸âƒ£  æ¸…ç†ç¯å¢ƒå˜é‡æ–‡ä»¶...'
            rm -f .env .env.* 2>/dev/null || true
            rm -f client/.env client/.env.* 2>/dev/null || true
            echo '   âœ… ç¯å¢ƒæ–‡ä»¶å·²æ¸…ç†'
          fi
        "
    
    - name: åˆ›å»ºéƒ¨ç½²ç›®å½•
      if: env.DEPLOY_MODE != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "åˆ›å»ºéƒ¨ç½²ç›®å½•..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          sudo mkdir -p ${{ env.DEPLOY_PATH }}
          sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} ${{ env.DEPLOY_PATH }}
          mkdir -p ${{ env.DEPLOY_PATH }}/logs
        "
    
    - name: ä¼ è¾“ä»£ç åˆ°æœåŠ¡å™¨
      if: env.DEPLOY_MODE != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "ä¼ è¾“ä»£ç åˆ°æœåŠ¡å™¨..."
        echo "==================================="
        
        # ä½¿ç”¨rsyncä¼ è¾“ä»£ç 
        rsync -avz --delete \
          -e "ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }}" \
          --exclude 'node_modules' \
          --exclude '.git' \
          --exclude '.github' \
          --exclude 'client/.next' \
          --exclude '.playWright-mcp' \
          --exclude 'client/node_modules' \
          --exclude 'client/build' \
          --exclude '.next' \
          --exclude 'logs' \
          --exclude '*.log' \
          --exclude '.DS_Store' \
          --exclude '.env' \
          --exclude '.env*' \
          --exclude 'plan report' \
          --exclude 'progress report' \
          --exclude 'README.md' \
          --exclude 'PROJECT_MEMORY.md' \
          --exclude 'dev.sh' \
          --exclude 'dev.local' \
          ./ ${{ env.SSH_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/
        
        echo "âœ… ä»£ç ä¼ è¾“å®Œæˆ"
    
    - name: åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
      if: env.DEPLOY_MODE != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶..."
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.DEPLOY_PATH }}/client
          
          # åˆ›å»º.envæ–‡ä»¶ä¾›Next.jsè¯»å–
          echo '# =================== ç¯å¢ƒé…ç½® ===================' > .env
          echo 'NODE_ENV=production' >> .env
          echo '' >> .env
          
          echo '# =================== æ•°æ®åº“é…ç½® ===================' >> .env
          echo 'DATABASE_URL=postgresql://${{ vars.POSTGRES_USER || secrets.POSTGRES_USER || 'homelabs' }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/${{ vars.POSTGRES_DB || secrets.POSTGRES_DB || 'homelabs_portal' }}?schema=public' >> .env
          echo '' >> .env
          
          echo '# =================== NextAuthé…ç½® ===================' >> .env
          echo 'NEXTAUTH_URL=${{ vars.NEXTAUTH_URL || secrets.NEXTAUTH_URL }}' >> .env
          echo 'NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}' >> .env
          echo '' >> .env
          
          echo '# =================== åº”ç”¨é…ç½® ===================' >> .env
          echo 'APP_URL=${{ vars.APP_URL || secrets.APP_URL }}' >> .env
          echo 'PORT=${{ vars.APP_PORT || secrets.APP_PORT || '3000' }}' >> .env
          echo '' >> .env
          
          echo '# =================== æ—¥å¿—é…ç½® ===================' >> .env
          echo 'LOG_LEVEL=${{ vars.LOG_LEVEL || secrets.LOG_LEVEL || 'info' }}' >> .env
          
          echo 'âœ… ç¯å¢ƒé…ç½®æ–‡ä»¶å·²åˆ›å»º: ${{ env.DEPLOY_PATH }}/client/.env'
        "
    
    - name: å®‰è£…ä¾èµ–å¹¶æ„å»º
      if: env.DEPLOY_MODE != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      timeout-minutes: 30
      run: |
        echo "==================================="
        echo "å®‰è£…ä¾èµ–å¹¶æ„å»ºåº”ç”¨..."
        echo "==================================="
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          cd ${{ env.DEPLOY_PATH }}/client
          
          echo "ğŸ“¥ å®‰è£…ä¾èµ–..."
          npm install --production=false
          
          echo "ğŸ”„ ç”ŸæˆPrismaå®¢æˆ·ç«¯..."
          npx prisma generate
          
          echo "ğŸ—„ï¸  è¿è¡Œæ•°æ®åº“è¿ç§»..."
          npx prisma db push --skip-generate
          
          echo "ğŸ”¨ æ„å»ºNext.jsåº”ç”¨..."
          npm run build
          
          echo "âœ… æ„å»ºå®Œæˆ"
        '
    
    - name: å¯åŠ¨åº”ç”¨æœåŠ¡
      if: env.DEPLOY_MODE != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "å¯åŠ¨åº”ç”¨æœåŠ¡..."
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.DEPLOY_PATH }}/client
          
          # è®¾ç½®PORTç¯å¢ƒå˜é‡ä¾›PM2è¯»å–
          # PM2çš„ecosystem.config.jsä¼šä»process.env.PORTè¯»å–å¹¶ä¼ é€’ç»™Next.js
          export PORT=${{ vars.APP_PORT || secrets.APP_PORT || '3001' }}
          
          # ä½¿ç”¨PM2 ecosystemé…ç½®å¯åŠ¨åº”ç”¨
          pm2 start ecosystem.config.js \
            --log ${{ env.DEPLOY_PATH }}/logs/pm2-combined.log \
            --error ${{ env.DEPLOY_PATH }}/logs/pm2-error.log
          
          pm2 save
          pm2 startup || echo 'âš ï¸  pm2 startupéœ€è¦æ‰‹åŠ¨é…ç½®sudoæƒé™'
          
          echo 'âœ… åº”ç”¨æœåŠ¡å·²å¯åŠ¨'
          echo ''
          echo 'ğŸ“Š æ—¥å¿—ä½ç½®:'
          echo '   åº”ç”¨æ—¥å¿—: ${{ env.DEPLOY_PATH }}/logs/combined-*.log (Winstonç»Ÿä¸€æ—¥å¿—)'
          echo '   é”™è¯¯æ—¥å¿—: ${{ env.DEPLOY_PATH }}/logs/error-*.log'
          echo '   PM2ç›‘æ§: ${{ env.DEPLOY_PATH }}/logs/pm2-*.log (ä»…PM2å…ƒæ•°æ®)'
          echo '   Nginxè®¿é—®: ${{ env.DEPLOY_PATH }}/logs/nginx-access.log'
          echo ''
          echo 'ğŸ“– æŸ¥çœ‹æ—¥å¿—:'
          echo '   å®æ—¶ç›‘æ§: tail -f ${{ env.DEPLOY_PATH }}/logs/combined-*.log'
          echo '   é”™è¯¯è¿½è¸ª: tail -f ${{ env.DEPLOY_PATH }}/logs/error-*.log'
          echo '   PM2çŠ¶æ€: pm2 logs homelabs-portal'
        "
    
    - name: éªŒè¯éƒ¨ç½²
      if: env.DEPLOY_MODE != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "éªŒè¯éƒ¨ç½²..."
        echo "==================================="
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 10
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          echo '1. PM2æœåŠ¡çŠ¶æ€:'
          pm2 status
          
          echo ''
          echo '2. æ£€æŸ¥åº”ç”¨ç«¯å£:'
          sudo ss -tlnp | grep :3000 || echo 'åº”ç”¨ç«¯å£3000æœªç›‘å¬'
          
          echo ''
          echo '3. æ£€æŸ¥PostgreSQL:'
          sudo systemctl status postgresql | head -5
          
          echo ''
          echo '4. æµ‹è¯•åº”ç”¨è®¿é—®:'
          if curl -f -s http://localhost:3000 > /dev/null 2>&1; then
            echo 'âœ… åº”ç”¨å“åº”æ­£å¸¸'
          else
            echo 'âš ï¸  åº”ç”¨æœªå“åº”'
          fi
        "
        
        echo ""
        echo "==================================="
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        echo "==================================="
        echo "è®¿é—®åœ°å€: http://${{ env.SERVER_HOST }}"
        echo ""
        echo "ğŸ“Š æŸ¥çœ‹æ—¥å¿— (æ‰€æœ‰æ—¥å¿—å·²ç»Ÿä¸€åˆ° ${{ env.DEPLOY_PATH }}/logs/):"
        echo "  åº”ç”¨æ—¥å¿—: tail -f ${{ env.DEPLOY_PATH }}/logs/combined-*.log"
        echo "  é”™è¯¯æ—¥å¿—: tail -f ${{ env.DEPLOY_PATH }}/logs/error-*.log"
        echo "  Nginxè®¿é—®: tail -f ${{ env.DEPLOY_PATH }}/logs/nginx-access.log"
        echo "  PM2ç›‘æ§: pm2 logs homelabs-portal"
    
    - name: æ¸…ç†å’Œå›æ»šï¼ˆå¤±è´¥æ—¶ï¼‰
      if: ${{ failure() && env.DEPLOY_MODE != 'check' }}
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "âš ï¸  éƒ¨ç½²å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š..."
        echo "==================================="
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          # åœæ­¢å¤±è´¥çš„æœåŠ¡
          pm2 stop all 2>/dev/null || true
          pm2 delete all 2>/dev/null || true
          
          # æ£€æŸ¥å¤‡ä»½å¹¶å›æ»š
          if [ -f /tmp/homelabs_last_backup ]; then
            BACKUP_DIR=$(cat /tmp/homelabs_last_backup)
            
            if [ -d "$BACKUP_DIR" ]; then
              echo "å‘ç°å¤‡ä»½: $BACKUP_DIR"
              echo "æ­£åœ¨å›æ»š..."
              
              # ä½¿ç”¨sudoè¿›è¡Œå›æ»šæ“ä½œ
              sudo rm -rf ${{ env.DEPLOY_PATH }}
              sudo mv $BACKUP_DIR ${{ env.DEPLOY_PATH }}
              sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} ${{ env.DEPLOY_PATH }}
              
              # å°è¯•é‡å¯æ—§ç‰ˆæœ¬
              cd ${{ env.DEPLOY_PATH }}/client
              pm2 start npm --name homelabs-portal -- start 2>/dev/null || true
              pm2 save
              
              echo "âœ… å·²å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬"
            fi
          fi
        '