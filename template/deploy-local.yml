name: æœ¬åœ°ç¯å¢ƒéƒ¨ç½²ï¼ˆéDockerï¼‰

on:
  workflow_dispatch:
    inputs:
      deploy_mode:
        description: 'éƒ¨ç½²æ¨¡å¼'
        required: true
        default: 'all'
        type: choice
        options:
          - all          # å…¨éƒ¨éƒ¨ç½²
          - frontend     # ä»…å‰ç«¯
          - backend      # ä»…åç«¯
          - check        # ä»…æ£€æŸ¥ç¯å¢ƒ

jobs:
  deploy-local:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: è®¾ç½®SSHå¯†é’¥
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
        ssh-auth-sock: ${{ github.workspace }}/ssh-auth.sock
    
    - name: è®¾ç½®æœåŠ¡å™¨é…ç½®
      id: server_config
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "SERVER_HOST=${{ vars.SERVER_HOST || secrets.SERVER_HOST }}" >> $GITHUB_ENV
        echo "SSH_PORT=${{ vars.SSH_PORT || secrets.SSH_PORT || '22' }}" >> $GITHUB_ENV
        echo "SSH_USER=${{ vars.SSH_USER || secrets.SSH_USER }}" >> $GITHUB_ENV
        echo "DEPLOY_PATH=${{ vars.DEPLOY_PATH || secrets.DEPLOY_PATH || '/opt/pmp' }}" >> $GITHUB_ENV
    
    - name: æ£€æŸ¥å¹¶å®‰è£…æœåŠ¡å™¨ç¯å¢ƒ
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "æ£€æŸ¥å¹¶å‡†å¤‡æœåŠ¡å™¨ç¯å¢ƒ..."
        echo "==================================="
        echo ""
        
        # æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹
        echo "æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹..."
        OS_TYPE=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          if [ -f /etc/os-release ]; then
            . /etc/os-release
            echo \$ID
          elif [ -f /etc/redhat-release ]; then
            echo 'rhel'
          else
            echo 'unknown'
          fi
        ")
        echo "ğŸ“‹ æ£€æµ‹åˆ°æ“ä½œç³»ç»Ÿ: $OS_TYPE"
        echo ""
        
          # ========================================
          # 1. æ£€æŸ¥å¹¶å®‰è£… Node.js
          # ========================================
          echo "-----------------------------------"
          echo "1ï¸âƒ£  æ£€æŸ¥ Node.js..."
          echo "-----------------------------------"
          if ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "command -v node &> /dev/null"; then
            NODE_VERSION=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "node --version" 2>/dev/null || echo "v0.0.0")
            NODE_MAJOR=$(echo $NODE_VERSION | cut -d'v' -f2 | cut -d'.' -f1)
            echo "âœ… Node.jså·²å®‰è£…: $NODE_VERSION"
            
            if [ "$NODE_MAJOR" -lt 20 ]; then
              echo "âš ï¸  Node.jsç‰ˆæœ¬è¿‡ä½ (éœ€è¦ >= 20)ï¼Œå°†é‡æ–°å®‰è£…..."
              
              if [ "$OS_TYPE" = "amzn" ]; then
                echo "ä½¿ç”¨NodeSourceä»“åº“å‡çº§åˆ°Node.js 20 (Amazon Linux 2)..."
                ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
                  'sudo yum remove -y nodejs npm nodesource-release 2>/dev/null || true && \
                  sudo rm -rf /etc/yum.repos.d/nodesource*.repo && \
                  sudo yum clean all && \
                  curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash - && \
                  sudo yum install -y nodejs && \
                  node --version && \
                  npm --version'
              else
                echo "ä½¿ç”¨NodeSourceä»“åº“å‡çº§åˆ°Node.js 20..."
                ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
                  'curl -fsSL https://deb.nodesource.com/setup_20.x | sudo bash - && \
                  sudo apt-get remove -y nodejs npm 2>/dev/null || true && \
                  sudo apt-get install -y nodejs && \
                  node --version && \
                  npm --version'
              fi
              
              echo "âœ… Node.jså‡çº§å®Œæˆ"
            fi
          else
            echo "ğŸ“¦ Node.jsæœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
            
            if [ "$OS_TYPE" = "amzn" ]; then
              echo "æ£€æµ‹åˆ°Amazon Linux 2ï¼Œå®‰è£…Node.js 20..."
              ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
                'sudo rm -rf /etc/yum.repos.d/nodesource*.repo && \
                sudo yum clean all && \
                curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash - && \
                sudo yum install -y nodejs && \
                node --version && \
                npm --version'
            else
              echo "æ£€æµ‹åˆ°Ubuntu/Debianï¼Œå®‰è£…Node.js 20..."
              ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
                'curl -fsSL https://deb.nodesource.com/setup_20.x | sudo bash - && \
                sudo apt-get install -y nodejs && \
                node --version && \
                npm --version'
            fi
            
            echo "âœ… Node.jså®‰è£…å®Œæˆ"
          fi
          echo ""
        
        # ========================================
        # 2. æ£€æŸ¥å¹¶å®‰è£… PM2
        # ========================================
        echo "-----------------------------------"
        echo "2ï¸âƒ£  æ£€æŸ¥ PM2..."
        echo "-----------------------------------"
        if ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "command -v pm2 &> /dev/null"; then
          PM2_VERSION=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "pm2 --version")
          echo "âœ… PM2å·²å®‰è£…: $PM2_VERSION"
        else
          echo "ğŸ“¦ PM2æœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
            'sudo npm install -g pm2 && pm2 --version'
          echo "âœ… PM2å®‰è£…å®Œæˆ"
        fi
        echo ""
        
        # ========================================
        # 3. æ£€æŸ¥å¹¶å®‰è£… MongoDB
        # ========================================
        echo "-----------------------------------"
        echo "3ï¸âƒ£  æ£€æŸ¥ MongoDB..."
        echo "-----------------------------------"
        if ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "command -v mongod &> /dev/null"; then
          MONGO_VERSION=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "mongod --version | head -1")
          echo "âœ… MongoDBå·²å®‰è£…: $MONGO_VERSION"
        else
          echo "ğŸ“¦ MongoDBæœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
          
          if [ "$OS_TYPE" = "amzn" ]; then
            echo "æ£€æµ‹åˆ°Amazon Linuxç³»ç»Ÿï¼Œä½¿ç”¨yumå®‰è£…..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
              'echo "[mongodb-org-6.0]" | sudo tee /etc/yum.repos.d/mongodb-org-6.0.repo && \
              echo "name=MongoDB Repository" | sudo tee -a /etc/yum.repos.d/mongodb-org-6.0.repo && \
              echo "baseurl=https://repo.mongodb.org/yum/amazon/2/mongodb-org/6.0/x86_64/" | sudo tee -a /etc/yum.repos.d/mongodb-org-6.0.repo && \
              echo "gpgcheck=1" | sudo tee -a /etc/yum.repos.d/mongodb-org-6.0.repo && \
              echo "enabled=1" | sudo tee -a /etc/yum.repos.d/mongodb-org-6.0.repo && \
              echo "gpgkey=https://www.mongodb.org/static/pgp/server-6.0.asc" | sudo tee -a /etc/yum.repos.d/mongodb-org-6.0.repo && \
              sudo yum install -y mongodb-org && \
              sudo systemctl start mongod && \
              sudo systemctl enable mongod && \
              mongod --version'
          elif [ "$OS_TYPE" = "ubuntu" ] || [ "$OS_TYPE" = "debian" ]; then
            # Ubuntu/Debian
            echo "æ£€æµ‹åˆ°Ubuntu/Debianç³»ç»Ÿï¼Œä½¿ç”¨aptå®‰è£…..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
              curl -fsSL https://www.mongodb.org/static/pgp/server-6.0.asc | sudo gpg --dearmor -o /usr/share/keyrings/mongodb-server-6.0.gpg
              echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
              sudo apt-get update
              sudo apt-get install -y mongodb-org
              sudo systemctl start mongod
              sudo systemctl enable mongod
              mongod --version
            '
          else
            echo "âš ï¸  æœªè¯†åˆ«çš„æ“ä½œç³»ç»Ÿç±»å‹: $OS_TYPE"
            echo "è¯·æ‰‹åŠ¨å®‰è£…MongoDB: https://docs.mongodb.com/manual/installation/"
            exit 1
          fi
          
          echo "âœ… MongoDBå®‰è£…å®Œæˆ"
        fi
        
        # ========================================
        # é…ç½®MongoDBä½¿ç”¨æ•°æ®ç›˜
        # ========================================
        echo "-----------------------------------"
        echo "é…ç½®MongoDBæ•°æ®ç›®å½•åˆ°æ•°æ®ç›˜..."
        echo "-----------------------------------"
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®ç›˜æŒ‚è½½åˆ°/data
          if [ -d /data ] && mountpoint -q /data; then
            echo "æ£€æµ‹åˆ°æ•°æ®ç›˜ /dataï¼Œé…ç½®MongoDBä½¿ç”¨æ•°æ®ç›˜..."
            
            # åœæ­¢MongoDBæœåŠ¡
            sudo systemctl stop mongod 2>/dev/null || true
            sleep 2
            
            # åˆ›å»ºMongoDBæ•°æ®ç›®å½•åœ¨æ•°æ®ç›˜
            sudo mkdir -p /data/mongodb
            sudo chown -R mongodb:mongodb /data/mongodb
            sudo chmod 755 /data/mongodb
            
            # å¤‡ä»½åŸé…ç½®æ–‡ä»¶
            if [ -f /etc/mongod.conf ] && [ ! -f /etc/mongod.conf.original ]; then
              sudo cp /etc/mongod.conf /etc/mongod.conf.original
            fi
            
            # ä¿®æ”¹é…ç½®æ–‡ä»¶æŒ‡å‘æ•°æ®ç›˜
            if grep -q "dbPath: /var/lib/mongodb" /etc/mongod.conf 2>/dev/null; then
              sudo sed -i "s|dbPath: /var/lib/mongodb|dbPath: /data/mongodb|g" /etc/mongod.conf
              echo "âœ… MongoDBé…ç½®å·²æ›´æ–°ä¸ºä½¿ç”¨æ•°æ®ç›˜"
              grep "dbPath" /etc/mongod.conf
            fi
            
            # è¿ç§»ç°æœ‰æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
            if [ -d /var/lib/mongodb ] && [ "$(ls -A /var/lib/mongodb 2>/dev/null)" ]; then
              echo "è¿ç§»ç°æœ‰MongoDBæ•°æ®åˆ°æ•°æ®ç›˜..."
              sudo rsync -a /var/lib/mongodb/ /data/mongodb/
              sudo mv /var/lib/mongodb /var/lib/mongodb.backup.$(date +%Y%m%d_%H%M%S)
              echo "âœ… ç°æœ‰æ•°æ®å·²è¿ç§»"
            fi
            
            echo "âœ… MongoDBæ•°æ®ç›®å½•é…ç½®å®Œæˆï¼š/data/mongodb"
          else
            echo "âš ï¸  æœªæ£€æµ‹åˆ°æ•°æ®ç›˜ /dataï¼ŒMongoDBå°†ä½¿ç”¨é»˜è®¤ä½ç½® /var/lib/mongodb"
          fi
        '
        echo ""
        
        # ç¡®ä¿MongoDBæœåŠ¡æ­£åœ¨è¿è¡Œ
        echo "æ£€æŸ¥MongoDBæœåŠ¡çŠ¶æ€..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          if ! sudo systemctl is-active --quiet mongod; then
            echo 'å¯åŠ¨MongoDBæœåŠ¡...'
            sudo systemctl start mongod
            sudo systemctl enable mongod
            sleep 3
          fi
          sudo systemctl status mongod | head -5
        "
        echo ""
        
        # ========================================
        # 3.1 åˆ›å»ºæˆ–æ›´æ–°MongoDBç”¨æˆ·ï¼ˆä½¿ç”¨GitHub Secretsä¸­çš„é¢„è®¾è´¦å·å¯†ç ï¼‰
        # ========================================
        echo "-----------------------------------"
        echo "3.1ï¸âƒ£  åˆ›å»ºæˆ–æ›´æ–°MongoDBç”¨æˆ·..."
        echo "-----------------------------------"
        
        # Create MongoDB user using GitHub Secrets
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} << 'MONGODB_USER_SCRIPT'
          if ! command -v mongosh &> /dev/null; then
            echo 'âš ï¸ mongosh not found. Please install MongoDB Shell. Cannot create/update user.'
            exit 1
          fi
          
          echo 'ä½¿ç”¨ mongosh åˆ›å»º/æ›´æ–°ç”¨æˆ·...'
          
          # åˆ›å»ºä¸´æ—¶JavaScriptæ–‡ä»¶
          cat > /tmp/create_mongo_user.js << 'JS_EOF'
          const username = process.env.MONGO_USERNAME;
          const password = process.env.MONGO_PASSWORD;
          const db = db.getSiblingDB('admin');
          const user = db.getUser(username);
          
          if (user == null) {
            print('User ' + username + ' not found. Creating...');
            db.createUser({ user: username, pwd: password, roles: [{ role: 'root', db: 'admin' }] });
            print('User ' + username + ' created successfully.');
          } else {
            print('User ' + username + ' already exists. Updating password...');
            db.updateUser(username, { pwd: password });
            print('Password for user ' + username + ' updated.');
          }
          JS_EOF
          
          # è®¾ç½®ç¯å¢ƒå˜é‡å¹¶æ‰§è¡Œ
          export MONGO_USERNAME='${{ secrets.MONGO_INITDB_ROOT_USERNAME }}'
          export MONGO_PASSWORD='${{ secrets.MONGO_INITDB_ROOT_PASSWORD }}'
          mongosh admin --file /tmp/create_mongo_user.js
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f /tmp/create_mongo_user.js
        MONGODB_USER_SCRIPT
        
        echo "âœ… MongoDBç”¨æˆ·é…ç½®å®Œæˆ"
        echo ""
        
        # ========================================
        # 4. æ£€æŸ¥å¹¶å®‰è£… Redis
        # ========================================
        echo "-----------------------------------"
        echo "4ï¸âƒ£  æ£€æŸ¥ Redis..."
        echo "-----------------------------------"
        if ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "command -v redis-server &> /dev/null"; then
          REDIS_VERSION=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "redis-server --version")
          echo "âœ… Rediså·²å®‰è£…: $REDIS_VERSION"
        else
          echo "ğŸ“¦ Redisæœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
          
          if [ "$OS_TYPE" = "amzn" ]; then
            # Amazon Linux
            echo "æ£€æµ‹åˆ°Amazon Linuxç³»ç»Ÿï¼Œä½¿ç”¨amazon-linux-extraså®‰è£…..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
              sudo amazon-linux-extras install redis6 -y
              sudo systemctl start redis
              sudo systemctl enable redis
              redis-server --version
            '
          elif [ "$OS_TYPE" = "ubuntu" ] || [ "$OS_TYPE" = "debian" ]; then
            # Ubuntu/Debian
            echo "æ£€æµ‹åˆ°Ubuntu/Debianç³»ç»Ÿï¼Œä½¿ç”¨aptå®‰è£…..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
              sudo apt-get update
              sudo apt-get install -y redis-server
              sudo systemctl start redis-server
              sudo systemctl enable redis-server
              redis-server --version
            '
          else
            echo "âš ï¸  æœªè¯†åˆ«çš„æ“ä½œç³»ç»Ÿç±»å‹: $OS_TYPE"
            echo "è¯·æ‰‹åŠ¨å®‰è£…Redis: https://redis.io/download"
            exit 1
          fi
          
          echo "âœ… Rediså®‰è£…å®Œæˆ"
        fi
        
        # ç¡®ä¿RedisæœåŠ¡æ­£åœ¨è¿è¡Œ
        echo "æ£€æŸ¥RedisæœåŠ¡çŠ¶æ€..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          REDIS_SERVICE='redis'
          if systemctl list-units --full -all | grep -q 'redis-server.service'; then
            REDIS_SERVICE='redis-server'
          fi
          
          if ! sudo systemctl is-active --quiet \$REDIS_SERVICE; then
            echo 'å¯åŠ¨RedisæœåŠ¡...'
            sudo systemctl start \$REDIS_SERVICE
            sudo systemctl enable \$REDIS_SERVICE
            sleep 2
          fi
          sudo systemctl status \$REDIS_SERVICE | head -5
        "
        echo ""
        
        # ========================================
        # 4.1 é…ç½®Rediså¯†ç ï¼ˆä½¿ç”¨GitHub Secretsä¸­çš„é¢„è®¾å¯†ç ï¼‰
        # ========================================
        echo "-----------------------------------"
        echo "4.1ï¸âƒ£  é…ç½®Rediså¯†ç ..."
        echo "-----------------------------------"
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} << 'REDIS_CONFIG_SCRIPT'
          # å…ˆå°è¯•ä»systemdæœåŠ¡æ–‡ä»¶ä¸­æ‰¾åˆ°é…ç½®æ–‡ä»¶è·¯å¾„
          echo "ğŸ” ä»systemdæœåŠ¡é…ç½®æŸ¥æ‰¾Redisé…ç½®æ–‡ä»¶..."
          REDIS_CONF_PATH=""
          
          # æ–¹æ³•1ï¼šæ£€æŸ¥systemdæœåŠ¡æ–‡ä»¶ï¼ˆåŸå…ˆå¯ç”¨çš„PCREæ–¹æ³•ï¼‰
          if [ -f /lib/systemd/system/redis-server.service ]; then
            echo "æ‰¾åˆ°redis-server.serviceï¼Œè§£æé…ç½®æ–‡ä»¶è·¯å¾„..."
            # ä¼˜å…ˆä½¿ç”¨PCREä»å•å…ƒæ–‡ä»¶ä¸­æå– conf è·¯å¾„
            if command -v grep >/dev/null 2>&1 && grep -P "test" </dev/null >/dev/null 2>&1; then
              REDIS_CONF_PATH=$(grep -oP "(?<=^ExecStart=.*redis-server\s).*\.conf" /lib/systemd/system/redis-server.service 2>/dev/null | head -n 1)
            fi
            # å¦‚PCREä¸å¯ç”¨ï¼Œé€€å›åˆ°POSIXï¼šè¯»å–ExecStartæ•´è¡Œå†ç”¨grep -Eæå–
            if [ -z "$REDIS_CONF_PATH" ]; then
              EXEC_LINE=$(awk -F= '/^ExecStart=/{print $2}' /lib/systemd/system/redis-server.service 2>/dev/null)
              if [ -n "$EXEC_LINE" ]; then
                REDIS_CONF_PATH=$(printf "%s" "$EXEC_LINE" | grep -Eo '/[^[:space:]]+\.conf' | head -n 1)
              fi
            fi
            if [ -n "$REDIS_CONF_PATH" ]; then
              echo "ä»æœåŠ¡æ–‡ä»¶æ‰¾åˆ°é…ç½®è·¯å¾„: $REDIS_CONF_PATH"
            fi
          fi
          
          # æ–¹æ³•2ï¼šå°è¯•æ ‡å‡†è·¯å¾„
          if [ -z "$REDIS_CONF_PATH" ]; then
            for path in /etc/redis/redis.conf /etc/redis.conf /usr/local/etc/redis.conf; do
              if [ -f "$path" ]; then
                REDIS_CONF_PATH="$path"
                echo "åœ¨æ ‡å‡†è·¯å¾„æ‰¾åˆ°: $REDIS_CONF_PATH"
                break
              fi
            done
          fi
          
          # æ–¹æ³•3ï¼šä½¿ç”¨findå‘½ä»¤é€’å½’æŸ¥æ‰¾
          if [ -z "$REDIS_CONF_PATH" ]; then
            echo "ä½¿ç”¨findå‘½ä»¤æŸ¥æ‰¾..."
            REDIS_CONF_PATH=$(find /etc -name "redis*.conf" 2>/dev/null | head -n 1)
            if [ -n "$REDIS_CONF_PATH" ]; then
              echo "é€šè¿‡findæ‰¾åˆ°: $REDIS_CONF_PATH"
            fi
          fi
          
          # æ–¹æ³•4ï¼šæ£€æŸ¥Redisè¿›ç¨‹å‚æ•°ï¼ˆå« /proc ä¸ ps ä¸¤ç§æ–¹å¼ï¼‰
          if [ -z "$REDIS_CONF_PATH" ]; then
            echo "æ£€æŸ¥Redisè¿›ç¨‹å‚æ•°..."
            # å°è¯• /proc æ–¹å¼ï¼ˆæ›´å¯é ï¼‰
            for pid in $(pgrep -x redis-server); do
              if [ -r "/proc/$pid/cmdline" ]; then
                CAND=$(tr '\0' ' ' < "/proc/$pid/cmdline" | grep -Eo '/[^[:space:]]+\.conf' | head -n 1)
                if [ -n "$CAND" ]; then
                  REDIS_CONF_PATH=$CAND
                  break
                fi
              fi
            done
            # å›é€€åˆ° ps è§£æ
            if [ -z "$REDIS_CONF_PATH" ]; then
              REDIS_CONF_PATH=$(ps -eo pid,cmd | grep '[r]edis-server' | sed -E 's/^[[:space:]]*[0-9]+[[:space:]]+//' | grep -Eo '/[^[:space:]]+\.conf' | head -n 1)
            fi
            if [ -n "$REDIS_CONF_PATH" ]; then
              echo "ä»è¿›ç¨‹å‚æ•°æ‰¾åˆ°: $REDIS_CONF_PATH"
            fi
          fi
          
          # å…œåº•ï¼šå¦‚æœä»æœªè§£æåˆ°é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤å°è¯• /etc/redis/redis.conf
          if [ -z "$REDIS_CONF_PATH" ]; then
            if [ -f /etc/redis/redis.conf ]; then
              REDIS_CONF_PATH="/etc/redis/redis.conf"
              echo "ä½¿ç”¨å…œåº•è·¯å¾„: $REDIS_CONF_PATH"
            fi
          fi

          # å¦‚æœæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥
          if [ -z "$REDIS_CONF_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ°redis.confæ–‡ä»¶"
            echo "å°è¯•çš„æ–¹æ³•ï¼š"
            echo "  1. systemdæœåŠ¡æ–‡ä»¶è§£æ"
            echo "  2. æ ‡å‡†è·¯å¾„æ£€æŸ¥: /etc/redis/redis.conf, /etc/redis.conf, /usr/local/etc/redis.conf"
            echo "  3. findå‘½ä»¤é€’å½’æŸ¥æ‰¾"
            echo "  4. Redisè¿›ç¨‹å‚æ•°æ£€æŸ¥"
            echo ""
            echo "ğŸ” è¯Šæ–­ä¿¡æ¯ï¼š"
            echo "systemdæœåŠ¡æ–‡ä»¶å†…å®¹ï¼š"
            cat /lib/systemd/system/redis-server.service 2>/dev/null || echo "  æ— æ³•è¯»å–"
            echo ""
            echo "Redisè¿›ç¨‹ä¿¡æ¯ï¼š"
            ps aux | grep redis-server | grep -v grep || echo "  æœªæ‰¾åˆ°è¿›ç¨‹"
            echo ""
            echo "âš ï¸  è·³è¿‡å¯†ç è®¾ç½®ï¼ŒRediså°†ä»¥æ— å¯†ç æ¨¡å¼è¿è¡Œ"
          else
            echo "âœ… æ‰¾åˆ°Redisé…ç½®æ–‡ä»¶: $REDIS_CONF_PATH"
            
            # ä½¿ç”¨ç¯å¢ƒå˜é‡é¿å…å¼•å·é—®é¢˜
            export REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD }}'
            
            # æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®requirepass
            if sudo grep -q "^requirepass" "$REDIS_CONF_PATH"; then
              echo "æ›´æ–°ç°æœ‰çš„requirepass..."
              sudo sed -i "s/^requirepass .*/requirepass $REDIS_PASSWORD/" "$REDIS_CONF_PATH"
            else
              echo "æ·»åŠ æ–°çš„requirepass..."
              echo "requirepass $REDIS_PASSWORD" | sudo tee -a "$REDIS_CONF_PATH"
            fi
            
            echo "é‡å¯RedisæœåŠ¡ä»¥åº”ç”¨æ›´æ”¹..."
            REDIS_SERVICE='redis'
            if systemctl list-units --full -all | grep -q 'redis-server.service'; then
              REDIS_SERVICE='redis-server'
            fi
            sudo systemctl restart $REDIS_SERVICE
            echo "âœ… Rediså¯†ç é…ç½®å®Œæˆå¹¶å·²é‡å¯æœåŠ¡"
          fi
        REDIS_CONFIG_SCRIPT
        echo ""
        
        # ========================================
        # 4.2 æ£€æŸ¥å¹¶å®‰è£…jq
        # ========================================
        echo "-----------------------------------"
        echo "4.2ï¸âƒ£  æ£€æŸ¥å¹¶å®‰è£…jq..."
        echo "-----------------------------------"
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          if ! command -v jq &> /dev/null; then
            echo "ğŸ“¦ jqæœªå®‰è£…ï¼Œå¼€å§‹è‡ªåŠ¨å®‰è£…..."
            if command -v apt-get &> /dev/null; then
              sudo apt-get update -y && sudo apt-get install -y jq
            elif command -v yum &> /dev/null; then
              sudo yum install -y jq
            else
              echo "âš ï¸ æ— æ³•è‡ªåŠ¨å®‰è£…jqï¼Œè¯·æ‰‹åŠ¨å®‰è£…"
              exit 1
            fi
            echo "âœ… jqå®‰è£…å®Œæˆ"
          else
            echo "âœ… jqå·²å®‰è£…"
          fi
        '
        echo ""
        
        # ========================================
        # 5. æœ€ç»ˆéªŒè¯
        # ========================================
        echo "==================================="
        echo "ğŸ“Š ç¯å¢ƒæœ€ç»ˆéªŒè¯"
        echo "==================================="
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          echo 'âœ… Node.jsç‰ˆæœ¬:'
          node --version
          
          echo 'âœ… npmç‰ˆæœ¬:'
          npm --version
          
          echo 'âœ… PM2ç‰ˆæœ¬:'
          pm2 --version
          
          echo 'âœ… MongoDBæœåŠ¡:'
          sudo systemctl is-active mongod && echo 'MongoDBè¿è¡Œä¸­' || echo 'MongoDBæœªè¿è¡Œ'
          
          echo 'âœ… RedisæœåŠ¡:'
          REDIS_SERVICE='redis'
          if systemctl list-units --full -all | grep -q 'redis-server.service'; then
            REDIS_SERVICE='redis-server'
          fi
          sudo systemctl is-active \$REDIS_SERVICE && echo 'Redisè¿è¡Œä¸­' || echo 'Redisæœªè¿è¡Œ'
        "
        
        echo ""
        echo "==================================="
        echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆï¼"
        echo "==================================="
    
    # ========================================
    # Nginxè‡ªåŠ¨é…ç½®æ­¥éª¤
    # ========================================
    
    - name: ğŸ”§ æ£€æŸ¥å¹¶å®‰è£…Nginx
      if: inputs.deploy_mode == 'all' || inputs.deploy_mode == 'frontend'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "æ£€æŸ¥å¹¶å®‰è£…Nginx..."
        echo "==================================="
        
        if ! ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "command -v nginx &> /dev/null"; then
          echo "ğŸ“¦ Nginxæœªå®‰è£…ï¼Œå¼€å§‹å®‰è£…..."
          
          OS_TYPE=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
            if [ -f /etc/os-release ]; then
              . /etc/os-release
              echo \$ID
            else
              echo 'unknown'
            fi
          ")
          
          if [ "$OS_TYPE" = "ubuntu" ] || [ "$OS_TYPE" = "debian" ]; then
            echo "ä½¿ç”¨aptå®‰è£…Nginx..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
              "sudo apt update && sudo apt install -y nginx"
          elif [ "$OS_TYPE" = "centos" ] || [ "$OS_TYPE" = "rhel" ] || [ "$OS_TYPE" = "amzn" ]; then
            echo "ä½¿ç”¨yumå®‰è£…Nginx..."
            ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
              "sudo yum install -y epel-release && sudo yum install -y nginx"
          else
            echo "âŒ ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: $OS_TYPE"
            echo "è¯·æ‰‹åŠ¨å®‰è£…Nginx: sudo apt install nginx æˆ– sudo yum install nginx"
            exit 1
          fi
          
          # å¯åŠ¨Nginx
          ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
            "sudo systemctl start nginx && sudo systemctl enable nginx"
          
          echo "âœ… Nginxå®‰è£…å®Œæˆ"
        else
          echo "âœ… Nginxå·²å®‰è£…"
          NGINX_VERSION=$(ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "nginx -v 2>&1")
          echo "   ç‰ˆæœ¬: $NGINX_VERSION"
        fi
        
        echo ""
    
    - name: ğŸ“ ç”ŸæˆNginxé…ç½®æ–‡ä»¶
      if: inputs.deploy_mode == 'all' || inputs.deploy_mode == 'frontend'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "ç”ŸæˆNginxé…ç½®æ–‡ä»¶..."
        echo "==================================="
        
        # è·å–éƒ¨ç½²ç¯å¢ƒé…ç½®
        DEPLOY_ENVIRONMENT="${{ vars.DEPLOY_ENVIRONMENT || secrets.DEPLOY_ENVIRONMENT || 'local' }}"
        PRIMARY_DOMAIN="${{ vars.PRIMARY_DOMAIN || secrets.PRIMARY_DOMAIN || 'localhost' }}"
        ADDITIONAL_DOMAINS="${{ vars.ADDITIONAL_DOMAINS || secrets.ADDITIONAL_DOMAINS || '' }}"
        USE_SSL="${{ vars.USE_SSL || secrets.USE_SSL || 'false' }}"
        SSL_EMAIL="${{ vars.SSL_EMAIL || secrets.SSL_EMAIL || '' }}"
        NGINX_PORT="${{ vars.NGINX_LOCAL_PORT || secrets.NGINX_LOCAL_PORT || '3333' }}"
        BEHIND_PROXY="${{ vars.BEHIND_PROXY || secrets.BEHIND_PROXY || 'true' }}"
        PROXY_IP="${{ vars.PROXY_REAL_IP_FROM || secrets.PROXY_REAL_IP_FROM || '192.168.0.0/16' }}"
        BACKEND_PORT="${{ vars.BACKEND_PORT || secrets.BACKEND_PORT || '5555' }}"
        DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
        
        echo "é…ç½®å‚æ•°:"
        echo "  éƒ¨ç½²ç¯å¢ƒ: $DEPLOY_ENVIRONMENT"
        echo "  ä¸»åŸŸå: $PRIMARY_DOMAIN"
        echo "  å¤‡ç”¨åŸŸå: $ADDITIONAL_DOMAINS"
        echo "  SSLå¯ç”¨: $USE_SSL"
        echo "  SSLé‚®ç®±: $SSL_EMAIL"
        echo "  Nginxç«¯å£: $NGINX_PORT"
        echo "  åç«¯ç«¯å£: $BACKEND_PORT"
        echo "  åå‘ä»£ç†: $BEHIND_PROXY"
        echo "  ä»£ç†IPæ®µ: $PROXY_IP"
        echo ""
        
        # æ ¹æ®éƒ¨ç½²ç¯å¢ƒç”Ÿæˆä¸åŒçš„é…ç½®
        if [ "$DEPLOY_ENVIRONMENT" = "production" ]; then
          echo "ç”Ÿæˆç”Ÿäº§ç¯å¢ƒNginxé…ç½®..."
          echo "# PlanovAI ç”Ÿäº§ç¯å¢ƒNginxé…ç½®" > nginx-auto.conf
          echo "# è‡ªåŠ¨ç”Ÿæˆ - è¯·å‹¿æ‰‹åŠ¨ç¼–è¾‘" >> nginx-auto.conf
          echo "" >> nginx-auto.conf
          
          # æ„å»ºserver_name
          SERVER_NAMES="$PRIMARY_DOMAIN"
          if [ -n "$ADDITIONAL_DOMAINS" ]; then
            SERVER_NAMES="$SERVER_NAMES $ADDITIONAL_DOMAINS"
          fi
          
          echo "server {" >> nginx-auto.conf
          
          # æ ¹æ®SSLè®¾ç½®å†³å®šç›‘å¬ç«¯å£
          if [ "$USE_SSL" = "true" ]; then
            echo "    # HTTPé‡å®šå‘åˆ°HTTPS" >> nginx-auto.conf
            echo "    listen 80;" >> nginx-auto.conf
            echo "    listen [::]:80;" >> nginx-auto.conf
            echo "    server_name $SERVER_NAMES;" >> nginx-auto.conf
            echo "    return 301 https://\$server_name\$request_uri;" >> nginx-auto.conf
            echo "}" >> nginx-auto.conf
            echo "" >> nginx-auto.conf
            echo "server {" >> nginx-auto.conf
            echo "    # HTTPSé…ç½®" >> nginx-auto.conf
            echo "    listen 443 ssl http2;" >> nginx-auto.conf
            echo "    listen [::]:443 ssl http2;" >> nginx-auto.conf
            echo "    server_name $SERVER_NAMES;" >> nginx-auto.conf
            echo "" >> nginx-auto.conf
            echo "    # SSLè¯ä¹¦é…ç½®" >> nginx-auto.conf
            echo "    ssl_certificate /etc/letsencrypt/live/$PRIMARY_DOMAIN/fullchain.pem;" >> nginx-auto.conf
            echo "    ssl_certificate_key /etc/letsencrypt/live/$PRIMARY_DOMAIN/privkey.pem;" >> nginx-auto.conf
            echo "    ssl_trusted_certificate /etc/letsencrypt/live/$PRIMARY_DOMAIN/chain.pem;" >> nginx-auto.conf
            echo "" >> nginx-auto.conf
            echo "    # SSLå®‰å…¨é…ç½®" >> nginx-auto.conf
            echo "    ssl_protocols TLSv1.2 TLSv1.3;" >> nginx-auto.conf
            echo "    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384;" >> nginx-auto.conf
            echo "    ssl_prefer_server_ciphers on;" >> nginx-auto.conf
            echo "    ssl_session_cache shared:SSL:10m;" >> nginx-auto.conf
            echo "    ssl_session_timeout 10m;" >> nginx-auto.conf
            echo "    ssl_stapling on;" >> nginx-auto.conf
            echo "    ssl_stapling_verify on;" >> nginx-auto.conf
            echo "" >> nginx-auto.conf
            echo "    # å®‰å…¨å¤´" >> nginx-auto.conf
            echo "    add_header Strict-Transport-Security \"max-age=31536000; includeSubDomains\" always;" >> nginx-auto.conf
            echo "    add_header X-Frame-Options DENY always;" >> nginx-auto.conf
            echo "    add_header X-Content-Type-Options nosniff always;" >> nginx-auto.conf
            echo "    add_header X-XSS-Protection \"1; mode=block\" always;" >> nginx-auto.conf
            echo "    add_header Referrer-Policy \"strict-origin-when-cross-origin\" always;" >> nginx-auto.conf
          else
            echo "    # HTTPé…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒä½†æœªå¯ç”¨SSLï¼‰" >> nginx-auto.conf
            echo "    listen 80;" >> nginx-auto.conf
            echo "    listen [::]:80;" >> nginx-auto.conf
            echo "    server_name $SERVER_NAMES;" >> nginx-auto.conf
          fi
        else
          echo "ç”Ÿæˆæœ¬åœ°ç¯å¢ƒNginxé…ç½®..."
          echo "# PlanovAI æœ¬åœ°ç¯å¢ƒNginxé…ç½®" > nginx-auto.conf
          echo "# è‡ªåŠ¨ç”Ÿæˆ - è¯·å‹¿æ‰‹åŠ¨ç¼–è¾‘" >> nginx-auto.conf
          echo "" >> nginx-auto.conf
          echo "server {" >> nginx-auto.conf
          echo "    listen ${NGINX_PORT};" >> nginx-auto.conf
          echo "    listen [::]:${NGINX_PORT};" >> nginx-auto.conf
          echo "    server_name localhost;" >> nginx-auto.conf
        fi
        echo "" >> nginx-auto.conf
        echo "    # è®¿é—®å’Œé”™è¯¯æ—¥å¿—" >> nginx-auto.conf
        if [ -d "${DEPLOY_PATH}/logs" ]; then
          echo "    access_log ${DEPLOY_PATH}/logs/nginx-access.log;" >> nginx-auto.conf
          echo "    error_log ${DEPLOY_PATH}/logs/nginx-error.log warn;" >> nginx-auto.conf
        else
          echo "    # éƒ¨ç½²ç›®å½•æœªå°±ç»ªæ—¶ä½¿ç”¨ç³»ç»Ÿé»˜è®¤æ—¥å¿—è·¯å¾„" >> nginx-auto.conf
          echo "    access_log /var/log/nginx/access.log;" >> nginx-auto.conf
          echo "    error_log /var/log/nginx/error.log warn;" >> nginx-auto.conf
        fi
        echo "" >> nginx-auto.conf
        
        # æ·»åŠ åå‘ä»£ç†çœŸå®IPå¤„ç†ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if [ "$BEHIND_PROXY" = "true" ]; then
          echo "    # åå‘ä»£ç†çœŸå®IPå¤„ç†ï¼ˆLuckyç­‰åå‘ä»£ç†ï¼‰" >> nginx-auto.conf
          echo "    set_real_ip_from ${PROXY_IP};" >> nginx-auto.conf
          echo "    real_ip_header X-Forwarded-For;" >> nginx-auto.conf
          echo "    real_ip_recursive on;" >> nginx-auto.conf
          echo "" >> nginx-auto.conf
        fi
        
        # ç»§ç»­æ·»åŠ ä¸»è¦é…ç½®
        echo "    # å‰ç«¯é™æ€æ–‡ä»¶æ ¹ç›®å½•" >> nginx-auto.conf
        echo "    root ${DEPLOY_PATH}/client/build;" >> nginx-auto.conf
        echo "    index index.html index.htm;" >> nginx-auto.conf
        echo "" >> nginx-auto.conf
        echo "    # Gzipå‹ç¼©" >> nginx-auto.conf
        echo "    gzip on;" >> nginx-auto.conf
        echo "    gzip_vary on;" >> nginx-auto.conf
        echo "    gzip_min_length 1024;" >> nginx-auto.conf
        echo "    gzip_comp_level 6;" >> nginx-auto.conf
        echo "    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/javascript application/xml+rss application/json image/svg+xml;" >> nginx-auto.conf
        echo "" >> nginx-auto.conf
        echo "    # APIä»£ç†é…ç½®" >> nginx-auto.conf
        echo "    location /api/ {" >> nginx-auto.conf
        echo "        proxy_pass http://localhost:${BACKEND_PORT}/;" >> nginx-auto.conf
        echo "        proxy_http_version 1.1;" >> nginx-auto.conf
        echo "        proxy_set_header Host \$host;" >> nginx-auto.conf
        echo "        proxy_set_header X-Real-IP \$remote_addr;" >> nginx-auto.conf
        echo "        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;" >> nginx-auto.conf
        echo "        proxy_set_header X-Forwarded-Proto \$scheme;" >> nginx-auto.conf
        echo "        proxy_connect_timeout 60s;" >> nginx-auto.conf
        echo "        proxy_send_timeout 60s;" >> nginx-auto.conf
        echo "        proxy_read_timeout 60s;" >> nginx-auto.conf
        echo "        proxy_buffering on;" >> nginx-auto.conf
        echo "        proxy_buffer_size 4k;" >> nginx-auto.conf
        echo "        proxy_buffers 8 4k;" >> nginx-auto.conf
        echo "    }" >> nginx-auto.conf
        echo "" >> nginx-auto.conf
        echo "    # WebSocketä»£ç†é…ç½® - Socket.IO" >> nginx-auto.conf
        echo "    location /socket.io/ {" >> nginx-auto.conf
        echo "        proxy_pass http://localhost:${BACKEND_PORT};" >> nginx-auto.conf
        echo "        proxy_http_version 1.1;" >> nginx-auto.conf
        echo "        proxy_set_header Upgrade \$http_upgrade;" >> nginx-auto.conf
        echo "        proxy_set_header Connection \"upgrade\";" >> nginx-auto.conf
        echo "        proxy_set_header Host \$host;" >> nginx-auto.conf
        echo "        proxy_set_header X-Real-IP \$remote_addr;" >> nginx-auto.conf
        echo "        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;" >> nginx-auto.conf
        echo "        proxy_set_header X-Forwarded-Proto \$scheme;" >> nginx-auto.conf
        echo "        proxy_cache_bypass \$http_upgrade;" >> nginx-auto.conf
        echo "        proxy_buffering off;" >> nginx-auto.conf
        echo "        proxy_read_timeout 86400s;" >> nginx-auto.conf
        echo "        proxy_send_timeout 86400s;" >> nginx-auto.conf
        echo "        proxy_set_header Sec-WebSocket-Extensions \$http_sec_websocket_extensions;" >> nginx-auto.conf
        echo "        proxy_set_header Sec-WebSocket-Key \$http_sec_websocket_key;" >> nginx-auto.conf
        echo "        proxy_set_header Sec-WebSocket-Version \$http_sec_websocket_version;" >> nginx-auto.conf
        echo "        proxy_set_header Sec-WebSocket-Protocol \$http_sec_websocket_protocol;" >> nginx-auto.conf
        echo "    }" >> nginx-auto.conf
        echo "" >> nginx-auto.conf
        echo "    # é™æ€èµ„æºç¼“å­˜" >> nginx-auto.conf
        echo "    location /static/ {" >> nginx-auto.conf
        echo "        expires 1y;" >> nginx-auto.conf
        echo "        add_header Cache-Control \"public, immutable\";" >> nginx-auto.conf
        echo "        access_log off;" >> nginx-auto.conf
        echo "    }" >> nginx-auto.conf
        echo "" >> nginx-auto.conf
        echo "    # SPAè·¯ç”±æ”¯æŒ" >> nginx-auto.conf
        echo "    location / {" >> nginx-auto.conf
        echo "        try_files \$uri \$uri/ /index.html;" >> nginx-auto.conf
        echo "        location ~* \\.html\$ {" >> nginx-auto.conf
        echo "            add_header Cache-Control \"no-cache, no-store, must-revalidate\";" >> nginx-auto.conf
        echo "            add_header Pragma \"no-cache\";" >> nginx-auto.conf
        echo "            add_header Expires 0;" >> nginx-auto.conf
        echo "        }" >> nginx-auto.conf
        echo "    }" >> nginx-auto.conf
        echo "" >> nginx-auto.conf
        echo "    # Faviconå’Œmanifest" >> nginx-auto.conf
        echo "    location ~* \\.(ico|png|svg|webp|json)\$ {" >> nginx-auto.conf
        echo "        expires 30d;" >> nginx-auto.conf
        echo "        add_header Cache-Control \"public, immutable\";" >> nginx-auto.conf
        echo "        access_log off;" >> nginx-auto.conf
        echo "    }" >> nginx-auto.conf
        echo "" >> nginx-auto.conf
        echo "    # ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶" >> nginx-auto.conf
        echo "    location ~ /\\. {" >> nginx-auto.conf
        echo "        deny all;" >> nginx-auto.conf
        echo "        access_log off;" >> nginx-auto.conf
        echo "        log_not_found off;" >> nginx-auto.conf
        echo "    }" >> nginx-auto.conf
        echo "}" >> nginx-auto.conf
        
        echo "âœ… Nginxé…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
        echo ""
        echo "é…ç½®é¢„è§ˆï¼ˆå‰25è¡Œï¼‰:"
        echo "----------------------------------------"
        head -n 25 nginx-auto.conf
        echo "..."
        echo "----------------------------------------"
        echo ""
    
    - name: ğŸš€ éƒ¨ç½²Nginxé…ç½®
      if: inputs.deploy_mode == 'all' || inputs.deploy_mode == 'frontend'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "éƒ¨ç½²Nginxé…ç½®..."
        echo "==================================="
        
        # ä¸Šä¼ é…ç½®æ–‡ä»¶åˆ°æœåŠ¡å™¨
        scp -o StrictHostKeyChecking=no -P ${{ env.SSH_PORT }} nginx-auto.conf \
          ${{ env.SSH_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/nginx-auto.conf
        
        # éƒ¨ç½²åˆ°Nginxç›®å½•
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
          set -e
          
          DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
          
          # è·å–ç¯å¢ƒå˜é‡ï¼ˆä»GitHub Actionsä¼ é€’ï¼‰
          DEPLOY_ENVIRONMENT="${{ vars.DEPLOY_ENVIRONMENT || secrets.DEPLOY_ENVIRONMENT || 'local' }}"
          PRIMARY_DOMAIN="${{ vars.PRIMARY_DOMAIN || secrets.PRIMARY_DOMAIN || 'localhost' }}"
          USE_SSL="${{ vars.USE_SSL || secrets.USE_SSL || 'false' }}"
          SSL_EMAIL="${{ vars.SSL_EMAIL || secrets.SSL_EMAIL || '' }}"
          
          # å¤‡ä»½ç°æœ‰é…ç½®
          if [ -f /etc/nginx/sites-available/planovai ]; then
            echo "å¤‡ä»½ç°æœ‰Nginxé…ç½®..."
            sudo cp /etc/nginx/sites-available/planovai /etc/nginx/sites-available/planovai.backup.$(date +%Y%m%d%H%M%S)
          fi
          
          # å¤åˆ¶æ–°é…ç½®
          echo "éƒ¨ç½²æ–°Nginxé…ç½®..."
          sudo cp $DEPLOY_PATH/nginx-auto.conf /etc/nginx/sites-available/planovai
          
          # åˆ›å»ºç¬¦å·é“¾æ¥
          sudo ln -sf /etc/nginx/sites-available/planovai /etc/nginx/sites-enabled/planovai
          
          # åˆ é™¤é»˜è®¤ç«™ç‚¹ï¼ˆé¿å…å†²çªï¼‰
          if [ -f /etc/nginx/sites-enabled/default ]; then
            echo "åˆ é™¤é»˜è®¤Nginxç«™ç‚¹..."
            sudo rm -f /etc/nginx/sites-enabled/default
          fi
          
          # ç”Ÿäº§ç¯å¢ƒSSLè¯ä¹¦å¤„ç†
          if [ "$DEPLOY_ENVIRONMENT" = "production" ] && [ "$USE_SSL" = "true" ] && [ -n "$SSL_EMAIL" ]; then
            echo "å¤„ç†ç”Ÿäº§ç¯å¢ƒSSLè¯ä¹¦..."
            
            # æ£€æŸ¥certbotæ˜¯å¦å·²å®‰è£…
            if ! command -v certbot &> /dev/null; then
              echo "å®‰è£…certbot..."
              if command -v apt-get &> /dev/null; then
                sudo apt-get update
                sudo apt-get install -y certbot python3-certbot-nginx
              elif command -v yum &> /dev/null; then
                sudo yum install -y certbot python3-certbot-nginx
              else
                echo "âš ï¸ æ— æ³•è‡ªåŠ¨å®‰è£…certbotï¼Œè¯·æ‰‹åŠ¨å®‰è£…"
              fi
            fi
            
            # æ£€æŸ¥è¯ä¹¦æ˜¯å¦å­˜åœ¨
            if [ ! -f "/etc/letsencrypt/live/$PRIMARY_DOMAIN/fullchain.pem" ]; then
              echo "ç”³è¯·SSLè¯ä¹¦..."
              
              # å…ˆå¯åŠ¨Nginxï¼ˆHTTPæ¨¡å¼ï¼‰
              echo "å¯åŠ¨Nginxï¼ˆHTTPæ¨¡å¼ï¼‰..."
              sudo systemctl start nginx
              sudo systemctl enable nginx
              
              # ç”³è¯·è¯ä¹¦
              sudo certbot --nginx -d $PRIMARY_DOMAIN --email $SSL_EMAIL --agree-tos --non-interactive --redirect
              
              echo "âœ… SSLè¯ä¹¦ç”³è¯·å®Œæˆ"
            else
              echo "SSLè¯ä¹¦å·²å­˜åœ¨ï¼Œæ£€æŸ¥ç»­æœŸ..."
              sudo certbot renew --dry-run
            fi
          fi
          
          # æµ‹è¯•é…ç½®
          echo "æµ‹è¯•Nginxé…ç½®..."
          sudo nginx -t
          
          # é‡è½½Nginx
          echo "é‡è½½NginxæœåŠ¡..."
          if sudo systemctl is-active --quiet nginx; then
            sudo systemctl reload nginx
          else
            sudo systemctl start nginx
          fi
          
          # ç¡®ä¿Nginxå¼€æœºè‡ªå¯
          sudo systemctl enable nginx
          
          echo "âœ… Nginxé…ç½®éƒ¨ç½²å®Œæˆ"
        ENDSSH
        
        echo ""
        echo "âœ… Nginxéƒ¨ç½²æˆåŠŸ"
        echo ""
    
    - name: å¤‡ä»½å½“å‰ç‰ˆæœ¬
      if: inputs.deploy_mode != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
        echo "==================================="
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          BACKUP_DIR=${{ env.DEPLOY_PATH }}_backup_\$(date +%Y%m%d_%H%M%S)
          
          if [ -d ${{ env.DEPLOY_PATH }} ]; then
            echo 'ğŸ“¦ åˆ›å»ºå¤‡ä»½: '\$BACKUP_DIR
            
            # ç¡®ä¿å¤‡ä»½ç›®å½•çš„çˆ¶ç›®å½•å­˜åœ¨ä¸”æœ‰æ­£ç¡®æƒé™
            BACKUP_PARENT=\$(dirname \$BACKUP_DIR)
            if [ ! -d \$BACKUP_PARENT ]; then
              echo 'ğŸ“ åˆ›å»ºå¤‡ä»½çˆ¶ç›®å½•: '\$BACKUP_PARENT
              mkdir -p \$BACKUP_PARENT
            fi
            
            # æ£€æŸ¥å¤‡ä»½ç›®å½•æƒé™
            if [ ! -w \$BACKUP_PARENT ]; then
              echo 'ğŸ”§ ä¿®å¤å¤‡ä»½ç›®å½•æƒé™...'
              sudo chown -R \$USER:\$USER \$BACKUP_PARENT 2>/dev/null || true
              sudo chmod -R 755 \$BACKUP_PARENT 2>/dev/null || true
            fi
            
            # ä½¿ç”¨ rsync è¿›è¡Œå¤‡ä»½ï¼Œæ›´å¥½åœ°å¤„ç†ç¬¦å·é“¾æ¥å’Œæƒé™
            # -a: å½’æ¡£æ¨¡å¼ï¼ˆä¿ç•™æƒé™ã€æ—¶é—´æˆ³ç­‰ï¼‰
            # -L: è·Ÿéšç¬¦å·é“¾æ¥ï¼Œå¤åˆ¶å®é™…å†…å®¹è€Œä¸æ˜¯é“¾æ¥æœ¬èº«
            # --exclude: æ’é™¤ä¸éœ€è¦å¤‡ä»½çš„å¤§æ–‡ä»¶ç›®å½•
            echo 'ğŸ”„ å¼€å§‹å¤‡ä»½...'
            if rsync -aL \
              --exclude 'node_modules' \
              --exclude 'client/node_modules' \
              --exclude 'server/node_modules' \
              --exclude 'client/build' \
              --exclude '.git' \
              --exclude 'logs' \
              --exclude '*.log' \
              ${{ env.DEPLOY_PATH }}/ \$BACKUP_DIR/ 2>/dev/null; then
              echo 'âœ… rsync å¤‡ä»½æˆåŠŸ'
            else
              echo 'âš ï¸  rsync å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ cp -rL'
              if cp -rL ${{ env.DEPLOY_PATH }} \$BACKUP_DIR 2>/dev/null; then
                echo 'âœ… cp å¤‡ä»½æˆåŠŸ'
              else
                echo 'âŒ å¤‡ä»½å¤±è´¥ï¼'
                echo 'ğŸ” æ£€æŸ¥æƒé™å’Œç£ç›˜ç©ºé—´...'
                ls -la \$(dirname \$BACKUP_DIR) | head -5
                df -h \$(dirname \$BACKUP_DIR) | head -2
                exit 1
              fi
            fi
            
            # éªŒè¯å¤‡ä»½æ˜¯å¦æˆåŠŸ
            if [ -d \$BACKUP_DIR ] && [ \"\$(ls -A \$BACKUP_DIR 2>/dev/null)\" ]; then
              echo 'âœ… å¤‡ä»½éªŒè¯æˆåŠŸ'
              
              # ä¿ç•™æœ€è¿‘3ä¸ªå¤‡ä»½
              cd \$(dirname ${{ env.DEPLOY_PATH }})
              ls -dt ${{ env.DEPLOY_PATH }}_backup_* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true
              
              # è®°å½•å¤‡ä»½è·¯å¾„ä¾›å›æ»šä½¿ç”¨
              echo \$BACKUP_DIR > /tmp/planovai_last_backup
              echo 'âœ… å¤‡ä»½å®Œæˆ'
            else
              echo 'âŒ å¤‡ä»½éªŒè¯å¤±è´¥ï¼'
              exit 1
            fi
          else
            echo 'âš ï¸  é¦–æ¬¡éƒ¨ç½²ï¼Œæ— éœ€å¤‡ä»½'
          fi
        "
    
    - name: åœæ­¢ç°æœ‰æœåŠ¡å¹¶å½»åº•æ¸…ç†
      if: inputs.deploy_mode != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "åœæ­¢ç°æœ‰æœåŠ¡å¹¶å½»åº•æ¸…ç†ç¯å¢ƒ..."
        
        # åœæ­¢PM2ç®¡ç†çš„æœåŠ¡å¹¶æ¸…ç†æŒä¹…åŒ–é…ç½®
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          if [ -d ${{ env.DEPLOY_PATH }} ]; then
            cd ${{ env.DEPLOY_PATH }}
            echo '1ï¸âƒ£  åœæ­¢æ‰€æœ‰PM2è¿›ç¨‹...'
            pm2 stop all 2>/dev/null || true
            pm2 delete all 2>/dev/null || true
            pm2 kill 2>/dev/null || true
            
            echo '2ï¸âƒ£  æ¸…ç†PM2æŒä¹…åŒ–é…ç½®ï¼ˆé˜²æ­¢æ—§ç¯å¢ƒå˜é‡æ®‹ç•™ï¼‰...'
            rm -f ~/.pm2/dump.pm2
            rm -rf ~/.pm2/logs/*
            rm -rf ~/.pm2/pids/*
            echo '   âœ… PM2é…ç½®å·²æ¸…ç†'
            
            echo '3ï¸âƒ£  å½»åº•æ¸…ç†æ‰€æœ‰ç¯å¢ƒå˜é‡æ–‡ä»¶...'
            # æ¸…ç†æ ¹ç›®å½•
            rm -f .env .env.* 2>/dev/null || true
            # æ¸…ç†serverç›®å½•
            rm -f server/.env server/.env.* 2>/dev/null || true
            # æ¸…ç†clientç›®å½•
            rm -f client/.env.local client/.env.development 2>/dev/null || true
            # æ¸…ç†ecosystemé…ç½®
            rm -f ecosystem.config.js server/ecosystem.config.js 2>/dev/null || true
            echo '   âœ… ç¯å¢ƒæ–‡ä»¶å·²æ¸…ç†'
          fi
        "
    
    - name: åˆ›å»ºéƒ¨ç½²ç›®å½•
      if: inputs.deploy_mode != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "åˆ›å»ºéƒ¨ç½²ç›®å½•..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          sudo mkdir -p ${{ env.DEPLOY_PATH }}
          sudo chown -R ${{ env.SSH_USER }}:${{ env.SSH_USER }} ${{ env.DEPLOY_PATH }}
          mkdir -p ${{ env.DEPLOY_PATH }}/logs
        "
    
    - name: ä¼ è¾“ä»£ç åˆ°æœåŠ¡å™¨
      if: inputs.deploy_mode != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "ä¼ è¾“ä»£ç åˆ°æœåŠ¡å™¨..."
        echo "==================================="
        
        # ä½¿ç”¨rsyncä¼ è¾“ä»£ç ï¼ˆä»…ä¼ è¾“ç”Ÿäº§ç¯å¢ƒå¿…éœ€çš„æ–‡ä»¶ï¼‰
        rsync -avz --delete \
          -e "ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }}" \
          --exclude 'node_modules' \
          --exclude '.git' \
          --exclude '.github' \
          --exclude 'client/build' \
          --exclude 'client/node_modules' \
          --exclude 'server/node_modules' \
          --exclude 'logs' \
          --exclude '/scripts/' \
          --exclude 'plan report' \
          --exclude 'progress report' \
          --exclude 'Audit report' \
          --exclude 'update log' \
          --exclude 'readme' \
          --exclude 'docs' \
          --exclude 'DOC' \
          --exclude 'test' \
          --exclude 'backups' \
          --exclude 'backup' \
          --exclude 'examples' \
          --exclude 'quarantine' \
          --exclude 'TEMP' \
          --exclude 'downloads' \
          --exclude 'uploads' \
          --exclude 'data/test-storage' \
          --exclude '*.pdf' \
          --exclude '*.docx' \
          --exclude '*.xlsx' \
          --exclude '.DS_Store' \
          --exclude 'Thumbs.db' \
          --exclude '*.log' \
          --exclude 'dump.rdb' \
          --exclude 'cookies.txt' \
          --exclude '.env' \
          --exclude '.env*' \
          --exclude '.env.local' \
          --exclude '.env.development' \
          --exclude '**/.env' \
          --exclude '**/.env*' \
          --exclude 'server/.env*' \
          --exclude 'client/.env*' \
          --exclude 'ecosystem.config.js' \
          --exclude 'dev.sh' \
          --exclude 'README.md' \
          --exclude 'PROJECT_MEMORY.md' \
          --exclude 'PMP*.md' \
          --exclude 'SECURITY.md' \
          ./ ${{ env.SSH_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/
        
        echo ""
        echo "âœ… ä»£ç ä¼ è¾“å®Œæˆ"
        echo ""
        echo "ğŸ“Š ä¼ è¾“ç»Ÿè®¡:"
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
          "du -sh ${{ env.DEPLOY_PATH }} && \
           echo 'æ–‡ä»¶æ•°é‡:' && \
           find ${{ env.DEPLOY_PATH }} -type f | wc -l"
    
    - name: åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
      if: inputs.deploy_mode != 'check'
      run: |
        echo "åˆ›å»ºå®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼ˆä»GitHub Secretsè¯»å–ï¼‰..."
        
        # åœ¨æœåŠ¡å™¨ä¸Šé€è¡Œå†™å…¥ç¯å¢ƒé…ç½®ï¼ˆç¡®ä¿GitHub Actionså˜é‡æ­£ç¡®æ›¿æ¢ï¼‰
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          echo \"# =================== ç¯å¢ƒæ ‡è¯† ===================\" > ${{ env.DEPLOY_PATH }}/.env
          echo \"NODE_ENV=${{ vars.NODE_ENV || secrets.NODE_ENV || 'production' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"TZ=${{ vars.TZ || secrets.TZ || 'Asia/Shanghai' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"PRODUCTION_DEPLOYMENT=true\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# ğŸš¨ ä»¥ä¸‹å¼€å‘ç¯å¢ƒå˜é‡å¿…é¡»ä¿æŒæœªè®¾ç½®çŠ¶æ€\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# ENABLE_DEV_MODE - å¿…é¡»ä¸å­˜åœ¨\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# DEV_AUTH_BYPASS - å¿…é¡»ä¸å­˜åœ¨\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# DEV_PERMISSIONS_BYPASS - å¿…é¡»ä¸å­˜åœ¨\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# DEV_AUTH_BYPASS_KEY - å¿…é¡»ä¸å­˜åœ¨\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# INIT_TEST_DATA - å¿…é¡»ä¸å­˜åœ¨\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# DEV_TOKEN - å¿…é¡»ä¸å­˜åœ¨\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# DEV_ALLOW_AUTH_BYPASS_WITH_KEY - å¿…é¡»ä¸å­˜åœ¨\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== APIé…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"BACKEND_PORT=${{ vars.BACKEND_PORT || secrets.BACKEND_PORT || '5555' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"FRONTEND_PORT=${{ vars.FRONTEND_PORT || '3333' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_API_URL=${{ vars.REACT_APP_API_URL || secrets.REACT_APP_API_URL }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"APP_URL=${{ vars.APP_URL || secrets.APP_URL || secrets.CLIENT_URL }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== JWTé…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"JWT_SECRET=${{ secrets.JWT_SECRET }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"ACCESS_TOKEN_EXPIRE=${{ vars.ACCESS_TOKEN_EXPIRE || secrets.ACCESS_TOKEN_EXPIRE || '30m' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REFRESH_TOKEN_EXPIRE=${{ vars.REFRESH_TOKEN_EXPIRE || secrets.REFRESH_TOKEN_EXPIRE || '7d' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"JWT_COOKIE_EXPIRE=${{ vars.JWT_COOKIE_EXPIRE || secrets.JWT_COOKIE_EXPIRE || '30' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"JWT_EXPIRE=${{ vars.JWT_EXPIRE || secrets.JWT_EXPIRE || '30d' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"JWT_KEY_ROTATION_INTERVAL=${{ vars.JWT_KEY_ROTATION_INTERVAL || secrets.JWT_KEY_ROTATION_INTERVAL || '168' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== æ•°æ®åº“é…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"MONGO_INITDB_ROOT_USERNAME=${{ secrets.MONGO_INITDB_ROOT_USERNAME }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"MONGO_INITDB_ROOT_PASSWORD=${{ secrets.MONGO_INITDB_ROOT_PASSWORD }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"MONGO_URI=${{ secrets.MONGO_URI }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REDIS_URI=${{ secrets.REDIS_URI }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REDIS_HOST=${{ vars.REDIS_HOST || secrets.REDIS_HOST || '127.0.0.1' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REDIS_PORT=${{ vars.REDIS_PORT || secrets.REDIS_PORT || '6379' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== AI APIé…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"SILICONFLOW_API_KEY=${{ secrets.SILICONFLOW_API_KEY }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== é‚®ä»¶æœåŠ¡é…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"MAIL_ENABLED=${{ vars.MAIL_ENABLED || secrets.MAIL_ENABLED || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"SMTP_HOST=${{ secrets.SMTP_HOST }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"SMTP_PORT=${{ vars.SMTP_PORT || secrets.SMTP_PORT || '587' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"SMTP_USER=${{ secrets.SMTP_USER }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"SMTP_SECURE=${{ vars.SMTP_SECURE || secrets.SMTP_SECURE || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"FROM_NAME=${{ vars.FROM_NAME || secrets.FROM_NAME || 'PlanovAI' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"FROM_EMAIL=${{ secrets.FROM_EMAIL }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== ç®¡ç†å‘˜é…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"ADMIN_NAME=${{ vars.ADMIN_NAME || secrets.ADMIN_NAME }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== å®¢æˆ·ç«¯é…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"CLIENT_URL=${{ vars.CLIENT_URL || secrets.CLIENT_URL }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== å®‰å…¨é…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"RATE_LIMIT_ENABLED_IN_DEV=${{ vars.RATE_LIMIT_ENABLED_IN_DEV || secrets.RATE_LIMIT_ENABLED_IN_DEV || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"CSRF_PROTECTION_ENABLED_IN_DEV=${{ vars.CSRF_PROTECTION_ENABLED_IN_DEV || secrets.CSRF_PROTECTION_ENABLED_IN_DEV || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"CONFIG_ENCRYPTION_KEY=${{ secrets.CONFIG_ENCRYPTION_KEY }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY || secrets.CONFIG_ENCRYPTION_KEY }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"SIGNATURE_SECRET=${{ secrets.SIGNATURE_SECRET || secrets.REFRESH_TOKEN_SECRET }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== æ’ä»¶ç³»ç»Ÿé…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"USE_PLUGIN_AUTH=${{ vars.USE_PLUGIN_AUTH || secrets.USE_PLUGIN_AUTH || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"USE_PLUGIN_RATE_LIMIT=${{ vars.USE_PLUGIN_RATE_LIMIT || secrets.USE_PLUGIN_RATE_LIMIT || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"PLUGIN_SYSTEM_STAGE=${{ vars.PLUGIN_SYSTEM_STAGE || secrets.PLUGIN_SYSTEM_STAGE || 'production' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"ENABLE_TRADITIONAL_FALLBACK=${{ vars.ENABLE_TRADITIONAL_FALLBACK || secrets.ENABLE_TRADITIONAL_FALLBACK || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"FORCE_PLUGIN_MODE=${{ vars.FORCE_PLUGIN_MODE || secrets.FORCE_PLUGIN_MODE || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"ENABLE_MIDDLEWARE_BRIDGE=${{ vars.ENABLE_MIDDLEWARE_BRIDGE || secrets.ENABLE_MIDDLEWARE_BRIDGE || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"BRIDGE_INTEGRATION_MODE=${{ vars.BRIDGE_INTEGRATION_MODE || secrets.BRIDGE_INTEGRATION_MODE || 'auto' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"BRIDGE_MONITORING_ENABLED=${{ vars.BRIDGE_MONITORING_ENABLED || secrets.BRIDGE_MONITORING_ENABLED || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"BRIDGE_FALLBACK_ENABLED=${{ vars.BRIDGE_FALLBACK_ENABLED || secrets.BRIDGE_FALLBACK_ENABLED || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"CLIENT_SECURITY_PLUGIN_ENABLED=${{ vars.CLIENT_SECURITY_PLUGIN_ENABLED || secrets.CLIENT_SECURITY_PLUGIN_ENABLED || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"CLIENT_RATE_LIMIT_ENABLED=${{ vars.CLIENT_RATE_LIMIT_ENABLED || secrets.CLIENT_RATE_LIMIT_ENABLED || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"CLIENT_PLUGIN_DEBUG=${{ vars.CLIENT_PLUGIN_DEBUG || secrets.CLIENT_PLUGIN_DEBUG || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"CLIENT_PLUGIN_VERBOSE_LOGGING=${{ vars.CLIENT_PLUGIN_VERBOSE_LOGGING || secrets.CLIENT_PLUGIN_VERBOSE_LOGGING || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== æ–‡ä»¶ä¸Šä¼ é…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"UPLOAD_PATH=${{ vars.UPLOAD_PATH || secrets.UPLOAD_PATH || 'uploads' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"MAX_FILE_SIZE=${{ vars.MAX_FILE_SIZE || secrets.MAX_FILE_SIZE || '52428800' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== æ—¥å¿—é…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"DEBUG=${{ vars.DEBUG || secrets.DEBUG || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"LOG_LEVEL=${{ vars.LOG_LEVEL || secrets.LOG_LEVEL || 'info' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== ä¼šè¯é…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"MAX_SESSIONS_PER_USER=${{ vars.MAX_SESSIONS_PER_USER || secrets.MAX_SESSIONS_PER_USER || '5' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== AIé…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"AI_AGENT_DEBUG=${{ vars.AI_AGENT_DEBUG || secrets.AI_AGENT_DEBUG || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"EMBEDDING_PROVIDER=${{ vars.EMBEDDING_PROVIDER || secrets.EMBEDDING_PROVIDER || 'openai' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"EMBEDDING_MODEL=${{ vars.EMBEDDING_MODEL || secrets.EMBEDDING_MODEL || 'text-embedding-3-small' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          
          echo \"# =================== æµ‹è¯•ç”¨æˆ·é…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"TEST_USER_EMAIL=${{ vars.TEST_USER_EMAIL || secrets.TEST_USER_EMAIL || 'test@planovai.com' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"TEST_USER_PASSWORD=${{ secrets.TEST_USER_PASSWORD }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== SSL/TLSé…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"USE_HTTPS=${{ vars.USE_HTTPS || secrets.USE_HTTPS || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== CORSé…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"CORS_ORIGIN=${{ vars.CORS_ORIGIN || secrets.CORS_ORIGIN }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== Socket.IOé…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"SOCKET_CORS_ORIGINS=${{ vars.SOCKET_CORS_ORIGINS || secrets.SOCKET_CORS_ORIGINS }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== å‰ç«¯é…ç½® ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_VERSION=${{ vars.REACT_APP_VERSION || secrets.REACT_APP_VERSION || '1.0.0' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_WS_URL=${{ vars.REACT_APP_WS_URL || secrets.REACT_APP_WS_URL }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_MCP_DOC_URL=${{ vars.REACT_APP_MCP_DOC_URL || secrets.REACT_APP_MCP_DOC_URL }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_SIGNATURE_KEY=${{ secrets.REACT_APP_SIGNATURE_KEY || secrets.SIGNATURE_SECRET }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_ENABLE_THREE_LAYER_ENCRYPTION=${{ vars.REACT_APP_ENABLE_THREE_LAYER_ENCRYPTION || secrets.REACT_APP_ENABLE_THREE_LAYER_ENCRYPTION || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_ENABLE_BASE_OBFUSCATION=${{ vars.REACT_APP_ENABLE_BASE_OBFUSCATION || secrets.REACT_APP_ENABLE_BASE_OBFUSCATION || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_ENABLE_BASE_ENCRYPTION=${{ vars.REACT_APP_ENABLE_BASE_ENCRYPTION || secrets.REACT_APP_ENABLE_BASE_ENCRYPTION || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_ENABLE_E2E_ENCRYPTION=${{ vars.REACT_APP_ENABLE_E2E_ENCRYPTION || secrets.REACT_APP_ENABLE_E2E_ENCRYPTION || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_CONSOLE_LOGS=${{ vars.REACT_APP_CONSOLE_LOGS || secrets.REACT_APP_CONSOLE_LOGS || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_CONSOLE_DEBUG=${{ vars.REACT_APP_CONSOLE_DEBUG || secrets.REACT_APP_CONSOLE_DEBUG || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_CONSOLE_INFO=${{ vars.REACT_APP_CONSOLE_INFO || secrets.REACT_APP_CONSOLE_INFO || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_CONSOLE_WARN=${{ vars.REACT_APP_CONSOLE_WARN || secrets.REACT_APP_CONSOLE_WARN || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_CONSOLE_ERROR=${{ vars.REACT_APP_CONSOLE_ERROR || secrets.REACT_APP_CONSOLE_ERROR || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_CONSOLE_PLUGINS=${{ vars.REACT_APP_CONSOLE_PLUGINS || secrets.REACT_APP_CONSOLE_PLUGINS || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_CONSOLE_API=${{ vars.REACT_APP_CONSOLE_API || secrets.REACT_APP_CONSOLE_API || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_CONSOLE_COMPONENTS=${{ vars.REACT_APP_CONSOLE_COMPONENTS || secrets.REACT_APP_CONSOLE_COMPONENTS || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_CONSOLE_COLLABORATION=${{ vars.REACT_APP_CONSOLE_COLLABORATION || secrets.REACT_APP_CONSOLE_COLLABORATION || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_CONSOLE_SILENT=${{ vars.REACT_APP_CONSOLE_SILENT || secrets.REACT_APP_CONSOLE_SILENT || 'true' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_CONSOLE_DEBUG_MODE=${{ vars.REACT_APP_CONSOLE_DEBUG_MODE || secrets.REACT_APP_CONSOLE_DEBUG_MODE || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"REACT_APP_DEBUG_MODE=${{ vars.REACT_APP_DEBUG_MODE || secrets.REACT_APP_DEBUG_MODE || 'false' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"# =================== ç›‘æ§å’Œæ—¥å¿— ===================\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"AUDIT_LOG_PATH=${{ vars.AUDIT_LOG_PATH || secrets.AUDIT_LOG_PATH || './logs/security-audit.log' }}\" >> ${{ env.DEPLOY_PATH }}/.env
          echo \"GEOIP_ENDPOINT=${{ vars.GEOIP_ENDPOINT || secrets.GEOIP_ENDPOINT || 'https://ipapi.co' }}\" >> ${{ env.DEPLOY_PATH }}/.env
        "
        
        echo "âœ… ç¯å¢ƒé…ç½®æ–‡ä»¶å·²åˆ›å»ºï¼ˆä»GitHub Secretsè¯»å–å®Œæ•´é…ç½®ï¼‰"
        
        # éªŒè¯.envæ–‡ä»¶æ˜¯å¦çœŸçš„åˆ›å»ºæˆåŠŸ
        echo ""
        echo "ğŸ” éªŒè¯.envæ–‡ä»¶åˆ›å»º..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          if [ -f ${{ env.DEPLOY_PATH }}/.env ]; then
            echo 'âœ… .envæ–‡ä»¶å­˜åœ¨'
            echo 'ğŸ“ æ–‡ä»¶è·¯å¾„: ${{ env.DEPLOY_PATH }}/.env'
            echo 'ğŸ“Š æ–‡ä»¶å¤§å°: '\$(ls -lh ${{ env.DEPLOY_PATH }}/.env | awk '{print \$5}')
            echo 'ğŸ“ å‰10è¡Œå†…å®¹:'
            head -10 ${{ env.DEPLOY_PATH }}/.env
            echo ''
            echo 'âœ… NODE_ENVè®¾ç½®:'
            grep '^NODE_ENV=' ${{ env.DEPLOY_PATH }}/.env || echo 'âŒ NODE_ENVæœªæ‰¾åˆ°'
          else
            echo 'âŒ .envæ–‡ä»¶ä¸å­˜åœ¨ï¼'
            exit 1
          fi
        "
        
        echo ""
        echo "ğŸ“Š é…ç½®ç»Ÿè®¡ï¼š"
        echo "  - æ€»å˜é‡æ•°: 86ä¸ª"
        echo "  - æ’ä»¶ç³»ç»Ÿé…ç½®: 13ä¸ªï¼ˆæ–°å¢ï¼‰"
        echo "  - ç«¯å£å’ŒRedisé…ç½®: 3ä¸ªï¼ˆæ–°å¢ï¼‰"
        echo "  - å®‰å…¨å˜é‡: ENCRYPTION_KEY, SIGNATURE_SECRET"
        echo "  - å‰ç«¯å˜é‡: 21ä¸ª"
    
    - name: éªŒè¯ç¯å¢ƒé…ç½®
      if: inputs.deploy_mode != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "ğŸ” éªŒè¯ç¯å¢ƒé…ç½®..."
        echo "==================================="
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          cd ${{ env.DEPLOY_PATH }}
          
          # æ£€æŸ¥ç¦æ­¢çš„ç¯å¢ƒå˜é‡
          echo "1ï¸âƒ£  æ£€æŸ¥ç¦æ­¢çš„å¼€å‘ç¯å¢ƒå˜é‡..."
          FORBIDDEN_VARS=("ENABLE_DEV_MODE" "DEV_AUTH_BYPASS" "DEV_PERMISSIONS_BYPASS" "DEV_AUTH_BYPASS_KEY" "DEV_TOKEN")
          FOUND_FORBIDDEN=0
          
          for var in "${FORBIDDEN_VARS[@]}"; do
            # æ£€æŸ¥.envæ–‡ä»¶
            if [ -f .env ] && grep -q "^$var=true" .env 2>/dev/null; then
              echo "âŒ é”™è¯¯: .envä¸­å‘ç° $var=true"
              FOUND_FORBIDDEN=1
            fi
            
            # æ£€æŸ¥server/.envæ–‡ä»¶
            if [ -f server/.env ] && grep -q "^$var=true" server/.env 2>/dev/null; then
              echo "âŒ é”™è¯¯: server/.envä¸­å‘ç° $var=true"
              FOUND_FORBIDDEN=1
            fi
          done
          
          if [ $FOUND_FORBIDDEN -eq 1 ]; then
            echo ""
            echo "ğŸš¨ ç¯å¢ƒé…ç½®éªŒè¯å¤±è´¥ï¼å‘ç°ç¦æ­¢çš„å¼€å‘å˜é‡"
            exit 1
          fi
          
          echo "âœ… æœªå‘ç°ç¦æ­¢çš„å˜é‡"
          
          # æ£€æŸ¥å¿…éœ€çš„ç”Ÿäº§ç¯å¢ƒå˜é‡
          echo "2ï¸âƒ£  æ£€æŸ¥å¿…éœ€çš„ç”Ÿäº§ç¯å¢ƒå˜é‡..."
          if ! grep -q "^NODE_ENV=production" .env 2>/dev/null; then
            echo "âŒ é”™è¯¯: NODE_ENVä¸æ˜¯production"
            exit 1
          fi
          echo "âœ… NODE_ENV=production"
          
          if ! grep -q "^PRODUCTION_DEPLOYMENT=true" .env 2>/dev/null; then
            echo "âŒ é”™è¯¯: PRODUCTION_DEPLOYMENTæœªè®¾ç½®"
            exit 1
          fi
          echo "âœ… PRODUCTION_DEPLOYMENT=true"
          
          # æ£€æŸ¥å…³é”®ç¯å¢ƒå˜é‡æ˜¯å¦æœ‰å€¼
          echo "2ï¸âƒ£.1 æ£€æŸ¥å…³é”®ç¯å¢ƒå˜é‡..."
          REQUIRED_VARS=("MONGO_URI" "JWT_SECRET")
          MISSING_VARS=0
          
          for var in "${REQUIRED_VARS[@]}"; do
            if ! grep -q "^$var=" .env 2>/dev/null; then
              echo "âŒ é”™è¯¯: $var æœªåœ¨ .env ä¸­å®šä¹‰"
              MISSING_VARS=1
            elif grep -q "^$var=$" .env 2>/dev/null || grep -q "^$var=''$" .env 2>/dev/null || grep -q "^$var=\"\"$" .env 2>/dev/null; then
              echo "âŒ é”™è¯¯: $var çš„å€¼ä¸ºç©º"
              MISSING_VARS=1
            else
              echo "âœ… $var å·²è®¾ç½®"
              
              # ç‰¹æ®Šæ£€æŸ¥ï¼šJWT_SECRET çš„å®‰å…¨è¦æ±‚
              if [ "$var" = "JWT_SECRET" ]; then
                JWT_VALUE=$(grep "^JWT_SECRET=" .env | cut -d= -f2)
                JWT_LENGTH=${#JWT_VALUE}
                
                if [ $JWT_LENGTH -lt 64 ]; then
                  echo "âŒ é”™è¯¯: JWT_SECRET é•¿åº¦ä¸è¶³ (å½“å‰: $JWT_LENGTH, è¦æ±‚: 64+)"
                  echo "   JWT_SECRET å¿…é¡»è‡³å°‘64ä¸ªå­—ç¬¦"
                  MISSING_VARS=1
                else
                  echo "   âœ… JWT_SECRET é•¿åº¦: $JWT_LENGTH å­—ç¬¦"
                  
                  # æ£€æŸ¥å¤æ‚åº¦ï¼ˆä½¿ç”¨æ›´ç®€å•çš„æ–¹æ³•é¿å…shellè½¬ä¹‰é—®é¢˜ï¼‰
                  HAS_LOWER=0
                  HAS_UPPER=0
                  HAS_NUMBER=0
                  HAS_SPECIAL=0
                  
                  echo "$JWT_VALUE" | grep -q "[a-z]" && HAS_LOWER=1
                  echo "$JWT_VALUE" | grep -q "[A-Z]" && HAS_UPPER=1
                  echo "$JWT_VALUE" | grep -q "[0-9]" && HAS_NUMBER=1
                  echo "$JWT_VALUE" | grep -q "[^a-zA-Z0-9]" && HAS_SPECIAL=1
                  
                  COMPLEXITY=$((HAS_LOWER + HAS_UPPER + HAS_NUMBER + HAS_SPECIAL))
                  
                  if [ $COMPLEXITY -lt 3 ]; then
                    echo "âŒ é”™è¯¯: JWT_SECRET å¤æ‚åº¦ä¸è¶³ (å½“å‰: $COMPLEXITY/4, è¦æ±‚: 3+)"
                    echo "   å¿…é¡»åŒ…å«è‡³å°‘3ç§å­—ç¬¦ç±»å‹ï¼š"
                    [ $HAS_LOWER -eq 0 ] && echo "   âŒ ç¼ºå°‘å°å†™å­—æ¯ (a-z)"
                    [ $HAS_UPPER -eq 0 ] && echo "   âŒ ç¼ºå°‘å¤§å†™å­—æ¯ (A-Z)"
                    [ $HAS_NUMBER -eq 0 ] && echo "   âŒ ç¼ºå°‘æ•°å­— (0-9)"
                    [ $HAS_SPECIAL -eq 0 ] && echo "   âŒ ç¼ºå°‘ç‰¹æ®Šå­—ç¬¦ (_-ç­‰)"
                    MISSING_VARS=1
                  else
                    echo "   âœ… JWT_SECRET å¤æ‚åº¦: $COMPLEXITY/4 ç§å­—ç¬¦ç±»å‹"
                  fi
                fi
              fi
            fi
          done
          
          if [ $MISSING_VARS -eq 1 ]; then
            echo ""
            echo "ğŸš¨ ç¯å¢ƒé…ç½®éªŒè¯å¤±è´¥ï¼å…³é”®ç¯å¢ƒå˜é‡ç¼ºå¤±æˆ–ä¸ºç©º"
            echo "è¯·æ£€æŸ¥ GitHub Secrets ä¸­æ˜¯å¦æ­£ç¡®è®¾ç½®äº† MONGO_URI å’Œ JWT_SECRET"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ®‹ç•™çš„å¼€å‘ç¯å¢ƒæ–‡ä»¶
          echo "3ï¸âƒ£  æ£€æŸ¥æ®‹ç•™çš„å¼€å‘ç¯å¢ƒæ–‡ä»¶..."
          DEV_FILES=0
          for envfile in .env.local .env.development server/.env.local server/.env.development; do
            if [ -f "$envfile" ]; then
              echo "âš ï¸  è­¦å‘Š: å‘ç°æ®‹ç•™æ–‡ä»¶ $envfile"
              rm -f "$envfile"
              DEV_FILES=1
            fi
          done
          
          if [ $DEV_FILES -eq 0 ]; then
            echo "âœ… æœªå‘ç°æ®‹ç•™çš„å¼€å‘ç¯å¢ƒæ–‡ä»¶"
          else
            echo "âœ… å·²æ¸…ç†æ®‹ç•™çš„å¼€å‘ç¯å¢ƒæ–‡ä»¶"
          fi
          
          echo ""
          echo "4ï¸âƒ£  éªŒè¯WebSocketé…ç½®..."
          if grep -q "^SOCKET_CORS_ORIGINS=" .env 2>/dev/null; then
            SOCKET_ORIGINS=$(grep "^SOCKET_CORS_ORIGINS=" .env | cut -d= -f2-)
            echo "âœ… SOCKET_CORS_ORIGINSå·²è®¾ç½®: $SOCKET_ORIGINS"
          else
            echo "âŒ é”™è¯¯: SOCKET_CORS_ORIGINSæœªè®¾ç½®"
            exit 1
          fi
          
          if grep -q "^REACT_APP_WS_URL=" .env 2>/dev/null; then
            WS_URL=$(grep "^REACT_APP_WS_URL=" .env | cut -d= -f2-)
            echo "âœ… REACT_APP_WS_URLå·²è®¾ç½®: $WS_URL"
          else
            echo "âŒ é”™è¯¯: REACT_APP_WS_URLæœªè®¾ç½®"
            exit 1
          fi
          
          echo ""
          echo "==================================="
          echo "âœ… ç¯å¢ƒé…ç½®éªŒè¯é€šè¿‡ï¼"
          echo "==================================="
        '
    
    - name: éªŒè¯å…³é”®æ–‡ä»¶å¹¶æ¸…ç†æ—§ä¾èµ–
      if: inputs.deploy_mode == 'all' || inputs.deploy_mode == 'backend'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "éªŒè¯å…³é”®æ–‡ä»¶å¹¶æ¸…ç†æ—§ä¾èµ–..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          cd ${{ env.DEPLOY_PATH }}/server
          
          # 1. éªŒè¯package.jsonå­˜åœ¨ä¸”åŒ…å«å…³é”®ä¾èµ–
          echo "ğŸ“¦ éªŒè¯package.json..."
          if [ ! -f package.json ]; then
            echo "âŒ é”™è¯¯ï¼špackage.jsonä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          # æ£€æŸ¥å…³é”®ä¾èµ–æ˜¯å¦åœ¨package.jsonä¸­
          for pkg in cookie-parser express mongoose socket.io; do
            if ! grep -q "$pkg" package.json; then
              echo "âŒ é”™è¯¯ï¼šå…³é”®ä¾èµ– $pkg ä¸åœ¨package.jsonä¸­ï¼"
              exit 1
            fi
          done
          echo "âœ… package.jsonéªŒè¯é€šè¿‡"
          
          # 2. æ˜¾ç¤ºpackage.jsonæ›´æ–°æ—¶é—´
          echo "ğŸ“… package.jsonæ›´æ–°æ—¶é—´:"
          ls -lh package.json
          
          # 3. æ¸…ç†æ—§çš„node_moduleså’Œpackage-lock.json
          echo "ğŸ§¹ æ¸…ç†æ—§çš„ä¾èµ–..."
          rm -rf node_modules
          rm -f package-lock.json
          echo "âœ… æ—§ä¾èµ–æ¸…ç†å®Œæˆ"
        '
    
    - name: å®‰è£…åç«¯ä¾èµ–
      if: inputs.deploy_mode == 'all' || inputs.deploy_mode == 'backend'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      timeout-minutes: 15
      run: |
        echo "å®‰è£…åç«¯ä¾èµ–..."
        echo "â±ï¸  æ³¨æ„ï¼šä¾èµ–å®‰è£…å¯èƒ½éœ€è¦5-10åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…..."
        echo ""
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} << 'EOF_BACKEND_INSTALL'
          cd ${{ env.DEPLOY_PATH }}/server
          
          echo "ğŸ“¥ å¼€å§‹å®‰è£…ä¾èµ–..."
          echo "ğŸ’¾ å½“å‰ç£ç›˜ç©ºé—´ï¼š"
          df -h /opt | grep -v Filesystem
          echo ""
          
          # æ˜¾ç¤ºpackage.jsonä¸­çš„ä¾èµ–æ•°é‡
          DEP_COUNT=$(cat package.json | grep -c '"dependencies":' || echo 0)
          if [ $DEP_COUNT -gt 0 ]; then
            TOTAL_DEPS=$(cat package.json | sed -n '/"dependencies"/,/}/p' | grep -c ":" || echo "æœªçŸ¥")
            echo "ğŸ“¦ å°†å®‰è£…çº¦ $TOTAL_DEPS ä¸ªç”Ÿäº§ä¾èµ–åŒ…"
            echo ""
          fi
          
          # ä½¿ç”¨npmæ–°è¯­æ³•å®‰è£…ç”Ÿäº§ä¾èµ–ï¼Œå¹¶æ˜¾ç¤ºè¿›åº¦
          echo "ğŸ”„ æ­£åœ¨å®‰è£…... (npm deprecationè­¦å‘Šæ˜¯æ­£å¸¸çš„ï¼Œå¯ä»¥å¿½ç•¥)"
          npm install --omit=dev --progress=true --loglevel=info
          
          INSTALL_EXIT_CODE=$?
          echo ""
          
          if [ $INSTALL_EXIT_CODE -ne 0 ]; then
            echo "âŒ npm installå¤±è´¥ï¼é€€å‡ºç : $INSTALL_EXIT_CODE"
            echo "ğŸ’¾ å®‰è£…åç£ç›˜ç©ºé—´ï¼š"
            df -h /opt | grep -v Filesystem
            exit 1
          fi
          
          # æ˜¾ç¤ºå®‰è£…ç»“æœ
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
          if [ -d node_modules ]; then
            NODE_MODULES_SIZE=$(du -sh node_modules | cut -f1)
            echo "ğŸ“¦ node_moduleså¤§å°: $NODE_MODULES_SIZE"
          fi
          
          # éªŒè¯Socket.IOæ˜¯å¦æ­£ç¡®å®‰è£…
          echo ""
          echo "ğŸ” éªŒè¯Socket.IOå®‰è£…..."
          if [ -d "node_modules/socket.io" ]; then
            echo "âœ… Socket.IOæ¨¡å—å·²å®‰è£…"
            SOCKET_VERSION=$(cat node_modules/socket.io/package.json | grep '"version"' | cut -d'"' -f4)
            echo "ğŸ“¦ Socket.IOç‰ˆæœ¬: $SOCKET_VERSION"
          else
            echo "âŒ Socket.IOæ¨¡å—æœªå®‰è£…ï¼"
            echo "ğŸ”„ å°è¯•é‡æ–°å®‰è£…Socket.IO..."
            npm install socket.io --save
          fi
          
          # éªŒè¯Socket.IOæœåŠ¡å™¨æ¨¡å—
          if [ -d "node_modules/socket.io" ]; then
            echo "âœ… Socket.IOæœåŠ¡å™¨æ¨¡å—éªŒè¯é€šè¿‡"
          else
            echo "âŒ Socket.IOæœåŠ¡å™¨æ¨¡å—éªŒè¯å¤±è´¥ï¼"
            exit 1
          fi
          
          echo "ğŸ’¾ å®‰è£…åç£ç›˜ç©ºé—´ï¼š"
          df -h /opt | grep -v Filesystem
        EOF_BACKEND_INSTALL
    
    - name: éªŒè¯å…³é”®ä¾èµ–å®‰è£…
      if: inputs.deploy_mode == 'all' || inputs.deploy_mode == 'backend'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "éªŒè¯å…³é”®ä¾èµ–æ˜¯å¦å®‰è£…..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          cd ${{ env.DEPLOY_PATH }}/server
          
          echo "ğŸ” éªŒè¯å…³é”®ä¾èµ–..."
          missing_packages=()
          
          # æ£€æŸ¥å…³é”®ä¾èµ–ï¼ˆåŒ…æ‹¬Socket.IOï¼‰
          for pkg in cookie-parser archiver docx glob node-cron node-schedule speakeasy validator socket.io; do
            if [ ! -d "node_modules/$pkg" ]; then
              missing_packages+=("$pkg")
              echo "âŒ ç¼ºå¤±: $pkg"
            else
              echo "âœ… å·²å®‰è£…: $pkg"
            fi
          done
          
          # å¦‚æœæœ‰ç¼ºå¤±çš„åŒ…ï¼ŒæŠ¥é”™å¹¶é€€å‡º
          if [ ${#missing_packages[@]} -gt 0 ]; then
            echo ""
            echo "âŒ é”™è¯¯ï¼šä»¥ä¸‹å…³é”®ä¾èµ–æœªå®‰è£…:"
            printf "%s\n" "${missing_packages[@]}"
            echo ""
            echo "å°è¯•æ‰‹åŠ¨å®‰è£…è¿™äº›åŒ…..."
            npm install ${missing_packages[@]} --production
            
            # å†æ¬¡éªŒè¯
            for pkg in "${missing_packages[@]}"; do
              if [ ! -d "node_modules/$pkg" ]; then
                echo "âŒ ä»ç„¶ç¼ºå¤±: $pkg"
                exit 1
              fi
            done
          fi
          
          echo ""
          echo "âœ… æ‰€æœ‰å…³é”®ä¾èµ–éªŒè¯é€šè¿‡ï¼"
          echo ""
          echo "ğŸ“Š node_modulesç»Ÿè®¡:"
          echo "æ€»åŒ…æ•°: $(ls node_modules | wc -l)"
          echo "æ€»å¤§å°: $(du -sh node_modules | cut -f1)"
        '
    
    - name: æ¸…ç†å‰ç«¯æ—§ä¾èµ–
      if: inputs.deploy_mode == 'all' || inputs.deploy_mode == 'frontend'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "æ¸…ç†å‰ç«¯æ—§ä¾èµ–..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.DEPLOY_PATH }}/client
          
          echo 'ğŸ§¹ æ¸…ç†æ—§çš„node_moduleså’Œbuild...'
          rm -rf node_modules
          rm -rf build
          rm -f package-lock.json
          echo 'âœ… å‰ç«¯æ—§ä¾èµ–æ¸…ç†å®Œæˆ'
        "
    
    - name: å®‰è£…å‰ç«¯ä¾èµ–å¹¶æ„å»º
      if: inputs.deploy_mode == 'all' || inputs.deploy_mode == 'frontend'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      timeout-minutes: 20
      run: |
        echo "å®‰è£…å‰ç«¯ä¾èµ–å¹¶æ„å»º..."
        echo "â±ï¸  æ³¨æ„ï¼šå‰ç«¯ä¾èµ–å®‰è£…å’Œæ„å»ºå¯èƒ½éœ€è¦10-15åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…..."
        echo ""
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          cd ${{ env.DEPLOY_PATH }}/client
          
          echo "ğŸ“¥ å®‰è£…å‰ç«¯ä¾èµ–..."
          echo "ğŸ’¾ å½“å‰ç£ç›˜ç©ºé—´ï¼š"
          df -h /opt | grep -v Filesystem
          echo ""
          
          npm install --progress=true --loglevel=info
          
          if [ $? -ne 0 ]; then
            echo "âŒ å‰ç«¯ä¾èµ–å®‰è£…å¤±è´¥ï¼"
            df -h /opt | grep -v Filesystem
            exit 1
          fi
          
          echo ""
          echo "ğŸ”§ é…ç½®å‰ç«¯æ„å»ºç¯å¢ƒå˜é‡..."
          
          # ä»æ ¹ç›®å½•çš„.envæ–‡ä»¶è¯»å–ç¯å¢ƒå˜é‡
          if [ -f ${{ env.DEPLOY_PATH }}/.env ]; then
            echo "ä».envæ–‡ä»¶è¯»å–ç¯å¢ƒå˜é‡..."
            
            # æå–å‰ç«¯ç›¸å…³çš„ç¯å¢ƒå˜é‡
            REACT_APP_API_URL=$(grep "^REACT_APP_API_URL=" ${{ env.DEPLOY_PATH }}/.env | cut -d= -f2- | tr -d "\"")
            REACT_APP_WS_URL=$(grep "^REACT_APP_WS_URL=" ${{ env.DEPLOY_PATH }}/.env | cut -d= -f2- | tr -d "\"")
            REACT_APP_VERSION=$(grep "^REACT_APP_VERSION=" ${{ env.DEPLOY_PATH }}/.env | cut -d= -f2- | tr -d "\"")
            REACT_APP_MCP_DOC_URL=$(grep "^REACT_APP_MCP_DOC_URL=" ${{ env.DEPLOY_PATH }}/.env | cut -d= -f2- | tr -d "\"")
            REACT_APP_SIGNATURE_KEY=$(grep "^REACT_APP_SIGNATURE_KEY=" ${{ env.DEPLOY_PATH }}/.env | cut -d= -f2- | tr -d "\"")
            
            # åˆ›å»ºå‰ç«¯æ„å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
            echo "REACT_APP_API_URL=${REACT_APP_API_URL}" > .env.production
            echo "REACT_APP_WS_URL=${REACT_APP_WS_URL:-auto}" >> .env.production
            echo "REACT_APP_VERSION=${REACT_APP_VERSION}" >> .env.production
            echo "REACT_APP_MCP_DOC_URL=${REACT_APP_MCP_DOC_URL}" >> .env.production
            echo "REACT_APP_SIGNATURE_KEY=${REACT_APP_SIGNATURE_KEY}" >> .env.production
            echo "REACT_APP_ENABLE_THREE_LAYER_ENCRYPTION=true" >> .env.production
            echo "REACT_APP_ENABLE_BASE_OBFUSCATION=true" >> .env.production
            echo "REACT_APP_ENABLE_BASE_ENCRYPTION=true" >> .env.production
            echo "REACT_APP_ENABLE_E2E_ENCRYPTION=true" >> .env.production
            echo "REACT_APP_CONSOLE_LOGS=false" >> .env.production
            echo "REACT_APP_CONSOLE_DEBUG=false" >> .env.production
            echo "REACT_APP_CONSOLE_INFO=false" >> .env.production
            echo "REACT_APP_CONSOLE_WARN=true" >> .env.production
            echo "REACT_APP_CONSOLE_ERROR=true" >> .env.production
            echo "REACT_APP_CONSOLE_PLUGINS=false" >> .env.production
            echo "REACT_APP_CONSOLE_API=false" >> .env.production
            echo "REACT_APP_CONSOLE_COMPONENTS=false" >> .env.production
            echo "REACT_APP_CONSOLE_COLLABORATION=false" >> .env.production
            echo "REACT_APP_CONSOLE_SILENT=true" >> .env.production
            echo "REACT_APP_CONSOLE_DEBUG_MODE=false" >> .env.production
            echo "REACT_APP_DEBUG_MODE=false" >> .env.production
            
            echo "âœ… å‰ç«¯ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ"
            echo "ğŸ“‹ é…ç½®çš„ç¯å¢ƒå˜é‡:"
            echo "  REACT_APP_API_URL: ${REACT_APP_API_URL}"
            echo "  REACT_APP_WS_URL: ${REACT_APP_WS_URL}"
            echo "  REACT_APP_VERSION: ${REACT_APP_VERSION}"
          else
            echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°.envæ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
          fi
          
          echo ""
          echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
          npm run build
          
          if [ $? -ne 0 ]; then
            echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥ï¼"
            exit 1
          fi
          
          echo ""
          echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
          echo "ğŸ“¦ æ„å»ºäº§ç‰©å¤§å°:"
          du -sh build
          echo "ğŸ’¾ æ„å»ºåç£ç›˜ç©ºé—´ï¼š"
          df -h /opt | grep -v Filesystem
          
          echo ""
          echo "ğŸ” éªŒè¯å‰ç«¯ç¯å¢ƒå˜é‡é…ç½®..."
          if [ -f .env.production ]; then
            echo "âœ… .env.productionæ–‡ä»¶å·²åˆ›å»º"
            echo "ğŸ“‹ å…³é”®ç¯å¢ƒå˜é‡:"
            grep "REACT_APP_API_URL\|REACT_APP_WS_URL" .env.production || echo "âš ï¸ å…³é”®å˜é‡æœªæ‰¾åˆ°"
          else
            echo "âŒ è­¦å‘Š: .env.productionæ–‡ä»¶æœªåˆ›å»º"
          fi
        '
    
    - name: åœæ­¢æ—§çš„PM2è¿›ç¨‹
      if: inputs.deploy_mode == 'all' || inputs.deploy_mode == 'backend'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "åœæ­¢æ—§çš„PM2è¿›ç¨‹..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          # åœæ­¢å¹¶åˆ é™¤æ—§çš„åç«¯è¿›ç¨‹
          if pm2 describe planovai-backend > /dev/null 2>&1; then
            echo 'ğŸ›‘ åœæ­¢æ—§çš„planovai-backendè¿›ç¨‹...'
            pm2 stop planovai-backend
            pm2 delete planovai-backend
            echo 'âœ… æ—§è¿›ç¨‹å·²æ¸…ç†'
          else
            echo 'âœ… æœªå‘ç°æ—§çš„planovai-backendè¿›ç¨‹'
          fi
          
          # æ¸…ç†PM2ç¼“å­˜
          pm2 flush
        "
    
    - name: æ¸…ç†æ—§çš„PM2æ—¥å¿—
      if: inputs.deploy_mode == 'all' || inputs.deploy_mode == 'backend'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "æ¸…ç†æ—§çš„PM2æ—¥å¿—æ–‡ä»¶..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          # å¤‡ä»½æ—§æ—¥å¿—ï¼ˆå¯é€‰ï¼Œä¿ç•™æœ€è¿‘ä¸€æ¬¡ï¼‰
          if [ -f ${{ env.DEPLOY_PATH }}/logs/planovai-combined.log ]; then
            echo 'ğŸ“¦ å¤‡ä»½æ—§æ—¥å¿—åˆ° planovai-combined.log.old'
            mv ${{ env.DEPLOY_PATH }}/logs/planovai-combined.log \
               ${{ env.DEPLOY_PATH }}/logs/planovai-combined.log.old 2>/dev/null || true
          fi
          
          if [ -f ${{ env.DEPLOY_PATH }}/logs/planovai-error.log ]; then
            echo 'ğŸ“¦ å¤‡ä»½æ—§æ—¥å¿—åˆ° planovai-error.log.old'
            mv ${{ env.DEPLOY_PATH }}/logs/planovai-error.log \
               ${{ env.DEPLOY_PATH }}/logs/planovai-error.log.old 2>/dev/null || true
          fi
          
          # åˆ é™¤æ›´æ—©çš„å¤‡ä»½ï¼ˆåªä¿ç•™ä¸€æ¬¡å¤‡ä»½ï¼‰
          rm -f ${{ env.DEPLOY_PATH }}/logs/*.log.old.* 2>/dev/null || true
          
          echo 'âœ… æ—¥å¿—æ¸…ç†å®Œæˆï¼Œå‡†å¤‡å¼€å§‹æ–°çš„éƒ¨ç½²æ—¥å¿—'
        "
    
    - name: å¯åŠ¨åç«¯æœåŠ¡
      if: inputs.deploy_mode == 'all' || inputs.deploy_mode == 'backend'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "å¯åŠ¨åç«¯æœåŠ¡..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          cd ${{ env.DEPLOY_PATH }}/server
          
          # è°ƒè¯•ï¼šæ£€æŸ¥.envæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo 'ğŸ” å¯åŠ¨å‰ç¯å¢ƒæ£€æŸ¥:'
          echo 'å½“å‰ç›®å½•: '\$(pwd)
          echo 'é¡¹ç›®æ ¹ç›®å½•.env: '\$(ls -la ${{ env.DEPLOY_PATH }}/.env 2>/dev/null || echo 'ä¸å­˜åœ¨')
          echo ''
          
          # ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—æ–‡ä»¶
          pm2 start index.js --name planovai-backend \
            --log ${{ env.DEPLOY_PATH }}/logs/planovai-combined.log \
            --error ${{ env.DEPLOY_PATH }}/logs/planovai-error.log \
            --time \
            --merge-logs
          
          pm2 save
          
          # å°è¯•è®¾ç½®å¼€æœºè‡ªå¯ï¼ˆå¦‚æœå¤±è´¥ä¹Ÿä¸å½±å“éƒ¨ç½²ï¼‰
          pm2 startup || echo 'âš ï¸  pm2 startupéœ€è¦æ‰‹åŠ¨é…ç½®sudoæƒé™ï¼ŒæœåŠ¡å·²æ­£å¸¸å¯åŠ¨'
        "
    
    - name: éªŒè¯åç«¯æœåŠ¡å¥åº·
      if: inputs.deploy_mode == 'all' || inputs.deploy_mode == 'backend'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "éªŒè¯åç«¯æœåŠ¡å¥åº·..."
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆæœ€å¤š30ç§’ï¼‰..."
          sleep 5
          
          # æ£€æŸ¥PM2çŠ¶æ€
          echo "ğŸ” æ£€æŸ¥PM2çŠ¶æ€..."
          pm2 describe planovai-backend > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "âŒ é”™è¯¯ï¼šplanovai-backendè¿›ç¨‹ä¸å­˜åœ¨ï¼"
            pm2 list
            exit 1
          fi
          
          # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
          status=$(pm2 jlist | jq -r ".[] | select(.name==\"planovai-backend\") | .pm2_env.status")
          if [ "$status" != "online" ]; then
            echo "âŒ é”™è¯¯ï¼šæœåŠ¡çŠ¶æ€å¼‚å¸¸: $status"
            echo ""
            echo "æœ€å50è¡Œé”™è¯¯æ—¥å¿—:"
            pm2 logs planovai-backend --err --lines 50 --nostream
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å¯åŠ¨é”™è¯¯
          echo "ğŸ” æ£€æŸ¥å¯åŠ¨æ—¥å¿—..."
          if grep -i "error" ${{ env.DEPLOY_PATH }}/logs/planovai-error.log | tail -20; then
            echo ""
            echo "âš ï¸  è­¦å‘Šï¼šå‘ç°é”™è¯¯æ—¥å¿—ï¼Œè¯·æ£€æŸ¥"
            echo ""
            echo "æœ€å20è¡Œé”™è¯¯:"
            tail -20 ${{ env.DEPLOY_PATH }}/logs/planovai-error.log
            echo ""
            echo "æ˜¯å¦ç»§ç»­ï¼Ÿæ£€æŸ¥è¿™äº›é”™è¯¯æ˜¯å¦è‡´å‘½..."
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å…³é”®é”™è¯¯ï¼ˆå¦‚æ¨¡å—ç¼ºå¤±ï¼‰
            if grep -i "cannot find module" ${{ env.DEPLOY_PATH }}/logs/planovai-error.log; then
              echo "âŒ è‡´å‘½é”™è¯¯ï¼šå‘ç°æ¨¡å—ç¼ºå¤±ï¼"
              exit 1
            fi
          else
            echo "âœ… æœªå‘ç°å¯åŠ¨é”™è¯¯"
          fi
          
          # å°è¯•å¥åº·æ£€æŸ¥APIï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          echo "ğŸ” æµ‹è¯•APIè¿é€šæ€§..."
          max_attempts=6
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "å°è¯• $attempt/$max_attempts..."
            
            if curl -f -s http://localhost:5555/api/health > /dev/null 2>&1 || \
               curl -f -s http://localhost:5555/ > /dev/null 2>&1; then
              echo "âœ… APIå“åº”æ­£å¸¸"
              break
            fi
            
            if [ $attempt -eq $max_attempts ]; then
              echo "âš ï¸  è­¦å‘Šï¼šAPIæœªå“åº”ï¼Œä½†è¿›ç¨‹è¿è¡Œæ­£å¸¸"
              echo "è¿™å¯èƒ½éœ€è¦æ‰‹åŠ¨æ£€æŸ¥"
            fi
            
            sleep 5
            attempt=$((attempt + 1))
          done
          
          echo ""
          echo "ğŸ“Š æœ€ç»ˆçŠ¶æ€:"
          pm2 list
          echo ""
          echo "âœ… åç«¯æœåŠ¡éªŒè¯å®Œæˆ"
        '
    
    # å‰ç«¯æœåŠ¡é…ç½®å·²ç”±Nginxè‡ªåŠ¨é…ç½®æ­¥éª¤å¤„ç†ï¼ˆè§ä¸Šæ–¹"ğŸš€ éƒ¨ç½²Nginxé…ç½®"æ­¥éª¤ï¼‰
    
    - name: éªŒè¯éƒ¨ç½²
      if: inputs.deploy_mode != 'check'
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "éªŒè¯éƒ¨ç½²..."
        echo "==================================="
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 5
        
        # æ£€æŸ¥PM2çŠ¶æ€
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "
          echo '1. PM2æœåŠ¡çŠ¶æ€:'
          pm2 status
          
          echo ''
          echo '2. æ£€æŸ¥åç«¯ç«¯å£:'
          sudo ss -tlnp | grep :5555 || echo 'åç«¯ç«¯å£5555æœªç›‘å¬'
          
          echo ''
          echo '3. æ£€æŸ¥å‰ç«¯ç«¯å£:'
          sudo ss -tlnp | grep :3333 || echo 'å‰ç«¯ç«¯å£3333æœªç›‘å¬'
          
          echo ''
          echo '4. æ£€æŸ¥MongoDB:'
          sudo systemctl status mongod | head -5
          
          echo ''
          echo '5. æ£€æŸ¥Redis:'
          REDIS_SERVICE='redis'
          if systemctl list-units --full -all | grep -q 'redis-server.service'; then
            REDIS_SERVICE='redis-server'
          fi
          sudo systemctl status \$REDIS_SERVICE | head -5
          
          echo ''
          echo '6. æµ‹è¯•WebSocketè¿æ¥:'
          # æµ‹è¯•åç«¯Socket.IOç«¯ç‚¹
          if curl -f -s http://localhost:5555/socket.io/ > /dev/null 2>&1; then
            echo 'âœ… åç«¯Socket.IOç«¯ç‚¹å¯è®¿é—®'
          else
            echo 'âš ï¸  åç«¯Socket.IOç«¯ç‚¹ä¸å¯è®¿é—®'
          fi
          
          # æµ‹è¯•Socket.IOæ¡æ‰‹
          echo '7. æµ‹è¯•Socket.IOæ¡æ‰‹:'
          SOCKETIO_RESPONSE=$(curl -s "http://localhost:5555/socket.io/?EIO=4&transport=polling" 2>/dev/null)
          if [ $? -eq 0 ] && [ -n "$SOCKETIO_RESPONSE" ]; then
            echo 'âœ… Socket.IOæ¡æ‰‹æˆåŠŸ'
            echo "å“åº”: $SOCKETIO_RESPONSE"
          else
            echo 'âŒ Socket.IOæ¡æ‰‹å¤±è´¥'
          fi
          
          # æ£€æŸ¥å‰ç«¯æ„å»ºäº§ç‰©ä¸­çš„WebSocketé…ç½®
          if [ -f ${{ env.DEPLOY_PATH }}/client/.env.production ]; then
            echo 'âœ… å‰ç«¯WebSocketç¯å¢ƒå˜é‡å·²é…ç½®:'
            grep "REACT_APP_WS_URL" ${{ env.DEPLOY_PATH }}/client/.env.production || echo 'âš ï¸  REACT_APP_WS_URLæœªæ‰¾åˆ°'
          else
            echo 'âš ï¸  å‰ç«¯.env.productionæ–‡ä»¶ä¸å­˜åœ¨'
          fi
        "
        
        echo ""
        echo "==================================="
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        echo "==================================="
        echo "å‰ç«¯åœ°å€: http://${{ env.SERVER_HOST }}:3333"
        echo "åç«¯API: http://${{ env.SERVER_HOST }}:5555"
        echo ""
        echo "æŸ¥çœ‹æ—¥å¿—:"
        echo "  åç«¯: pm2 logs planovai-backend"
        if ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} "[ -d '${{ env.DEPLOY_PATH }}/logs' ]"; then
          echo "  å‰ç«¯(Nginx): tail -f ${{ env.DEPLOY_PATH }}/logs/nginx-access.log"
          echo "  Nginxé”™è¯¯: tail -f ${{ env.DEPLOY_PATH }}/logs/nginx-error.log"
        else
          echo "  å‰ç«¯(Nginx): sudo tail -f /var/log/nginx/access.log"
          echo "  Nginxé”™è¯¯: sudo tail -f /var/log/nginx/error.log"
        fi
    
    - name: æ¸…ç†å’Œå›æ»šï¼ˆå¤±è´¥æ—¶ï¼‰
      if: ${{ failure() && inputs.deploy_mode != 'check' }}
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        echo "==================================="
        echo "âš ï¸  éƒ¨ç½²å¤±è´¥ï¼Œæ‰§è¡Œæ¸…ç†å’Œå›æ»š..."
        echo "==================================="
        
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} '
          # 1. åœæ­¢å¤±è´¥çš„æœåŠ¡
          echo "1ï¸âƒ£  åœæ­¢å¤±è´¥çš„æœåŠ¡..."
          pm2 stop all 2>/dev/null || true
          pm2 delete all 2>/dev/null || true
          
          # 2. æ£€æŸ¥æ˜¯å¦æœ‰å¤‡ä»½
          if [ -f /tmp/planovai_last_backup ]; then
            BACKUP_DIR=$(cat /tmp/planovai_last_backup)
            
            if [ -d "$BACKUP_DIR" ]; then
              echo "2ï¸âƒ£  å‘ç°å¤‡ä»½: $BACKUP_DIR"
              echo "æ­£åœ¨å›æ»š..."
              
              # åˆ é™¤å¤±è´¥çš„éƒ¨ç½²
              rm -rf ${{ env.DEPLOY_PATH }}
              
              # æ¢å¤å¤‡ä»½
              mv $BACKUP_DIR ${{ env.DEPLOY_PATH }}
              
              echo "âœ… å›æ»šå®Œæˆ"
              
              # å°è¯•é‡å¯æ—§ç‰ˆæœ¬æœåŠ¡
              echo "3ï¸âƒ£  å°è¯•é‡å¯æ—§ç‰ˆæœ¬æœåŠ¡..."
              cd ${{ env.DEPLOY_PATH }}/server
              pm2 start index.js --name planovai-backend \
                --log ${{ env.DEPLOY_PATH }}/logs/planovai-combined.log \
                --error ${{ env.DEPLOY_PATH }}/logs/planovai-error.log \
                --time \
                --merge-logs 2>/dev/null || echo "âš ï¸  åç«¯å¯åŠ¨å¤±è´¥"
              
              pm2 save || true
              
              # æ¢å¤Nginxé…ç½®
              if [ -f ${{ env.DEPLOY_PATH }}/client/nginx-local.conf ]; then
                sudo cp ${{ env.DEPLOY_PATH }}/client/nginx-local.conf /etc/nginx/sites-available/planovai-local
                sudo ln -sf /etc/nginx/sites-available/planovai-local /etc/nginx/sites-enabled/planovai-local
                sudo nginx -t && sudo systemctl reload nginx 2>/dev/null || echo "âš ï¸  Nginxé‡è½½å¤±è´¥"
              else
                echo "âš ï¸  æœªæ‰¾åˆ°Nginxé…ç½®æ–‡ä»¶"
              fi
              
              pm2 save
              
              echo ""
              echo "==================================="
              echo "âœ… å·²å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬"
              echo "==================================="
              echo ""
              echo "PM2çŠ¶æ€:"
              pm2 status
            else
              echo "âš ï¸  å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: $BACKUP_DIR"
            fi
          else
            echo "âš ï¸  æœªæ‰¾åˆ°å¤‡ä»½ä¿¡æ¯"
          fi
          
          # 3. æ¸…ç†å¤±è´¥çš„æ„å»ºäº§ç‰©
          echo ""
          echo "4ï¸âƒ£  æ¸…ç†å¤±è´¥çš„æ„å»ºäº§ç‰©..."
          cd ${{ env.DEPLOY_PATH }}
          
          # æ¸…ç†node_modulesï¼ˆå¯èƒ½éƒ¨åˆ†å®‰è£…ï¼‰
          rm -rf server/node_modules/.staging 2>/dev/null || true
          rm -rf client/node_modules/.staging 2>/dev/null || true
          
          # æ¸…ç†å‰ç«¯æ„å»ºäº§ç‰©
          rm -rf client/build 2>/dev/null || true
          rm -rf client/.cache 2>/dev/null || true
          
          echo "âœ… æ¸…ç†å®Œæˆ"
          echo ""
          echo "==================================="
          echo "ğŸ“‹ å¤±è´¥åŸå› åˆ†æå»ºè®®"
          echo "==================================="
          echo "1. æŸ¥çœ‹GitHub Actionså®Œæ•´æ—¥å¿—"
          echo "2. æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—: tail -f ${{ env.DEPLOY_PATH }}/logs/planovai-error.log"
          echo "3. æ£€æŸ¥ç£ç›˜ç©ºé—´: df -h"
          echo "4. æ£€æŸ¥å†…å­˜ä½¿ç”¨: free -h"
          echo "5. æ£€æŸ¥æœåŠ¡çŠ¶æ€: pm2 status"
        '
    
    - name: åˆ é™¤ä¸´æ—¶å¤‡ä»½æ ‡è®°ï¼ˆæˆåŠŸæ—¶ï¼‰
      if: ${{ success() && inputs.deploy_mode != 'check' }}
      env:
        SSH_AUTH_SOCK: ${{ github.workspace }}/ssh-auth.sock
      run: |
        # éƒ¨ç½²æˆåŠŸï¼Œåˆ é™¤å¤‡ä»½æ ‡è®°ï¼ˆä¿ç•™å¤‡ä»½æ–‡ä»¶ä»¥ä¾¿æ‰‹åŠ¨å›æ»šï¼‰
        ssh -o StrictHostKeyChecking=no -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SERVER_HOST }} \
          "rm -f /tmp/planovai_last_backup"

