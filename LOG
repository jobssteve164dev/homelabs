# 部署日志

## 2025-10-20 部署问题修复历程

### 问题1: Nginx配置上传失败 ✅
- ❌ 错误: `scp: dest open "/opt/homelabs/nginx-auto.conf": No such file or directory`
- 🔧 原因: 目录创建在文件上传之后
- ✅ 修复: 在上传前先创建部署目录

### 问题2: 备份目录创建失败 ✅
- ❌ 错误: `rsync: mkdir "/opt/homelabs_backup_20251020_033728" failed: Permission denied (13)`
- 🔧 原因: `/opt/` 目录需要sudo权限才能创建子目录
- ✅ 修复: 使用sudo创建备份目录并chown给SSH用户

### 问题3: Bash语法错误 ✅
- ❌ 错误: `syntax error near unexpected token '('`
- 🔧 原因: 清理旧备份的echo语句中嵌套了过于复杂的命令替换和引号转义
- ✅ 修复: 先将计数存入变量再输出

### 问题4: PostgreSQL配置SQL语法错误 ✅
- ❌ 错误: `ERROR: syntax error at or near "$"`
- 🔧 原因: Heredoc嵌套中使用单引号导致变量无法展开
- ✅ 修复: 改用 `psql -c` 直接执行SQL命令

### 问题5: PostgreSQL目录权限警告 ✅
- ⚠️ 警告: `could not change directory to "/home/***": Permission denied`
- 🔧 原因: 
  * `sudo -u postgres psql` 继承当前工作目录（SSH用户的home）
  * postgres用户没有权限访问SSH用户的home目录
  * 虽然不影响功能，但产生噪音警告
- ✅ 修复: 
  * 在执行psql命令前先 `cd /tmp`
  * /tmp目录所有用户都有权限访问
  * 完全消除权限警告

---

# 后续部署日志将记录在此
