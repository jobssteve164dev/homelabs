【2025-10-20 12:30】修正Next.js环境变量加载理解错误

问题诊断:
✅ Next.js在生产环境也会读取.env文件（之前理解错误）
✅ .env文件配置正确: PORT=3001
✅ Nginx配置正确: 代理到3001
❌ Next.js启动在3000端口（默认端口）
❌ 环境配置文件检测不存在

根本原因:
PM2启动npm脚本时，环境变量传递可能不可靠

修复方案:
1. 保留.env文件（让Next.js标准加载）
2. PM2启动时显式传递PORT变量
   PORT=3001 pm2 start npm -- start

双重保障:
✅ .env文件: Next.js标准读取
✅ PM2环境变量: 显式传递确保生效

Commit: 1707cb9
下一步: 重新部署验证

---

szlk@szlk:/tmp$ ./troubleshooting_check.sh
==========================================
🔍 HOMELABS 应用状态检查
==========================================

1️⃣  检查PM2进程状态:
-----------------------------------
┌────┬────────────────────┬─────────────┬─────────┬─────────┬──────────┬────────┬──────┬───────────┬──────────┬──────────┬──────────┬──────────┐
│ id │ name               │ namespace   │ version │ mode    │ pid      │ uptime │ ↺    │ status    │ cpu      │ mem      │ user     │ watching │
├────┼────────────────────┼─────────────┼─────────┼─────────┼──────────┼────────┼──────┼───────────┼──────────┼──────────┼──────────┼──────────┤
│ 0  │ homelabs-portal    │ default     │ N/A     │ fork    │ 149868   │ 69s    │ 0    │ online    │ 0%       │ 56.1mb   │ szlk     │ disabled │
└────┴────────────────────┴─────────────┴─────────┴─────────┴──────────┴────────┴──────┴───────────┴──────────┴──────────┴──────────┴──────────┘

[TAILING] Tailing last 30 lines for [homelabs-portal] process (change the value with --lines option)
/opt/homelabs/logs/pm2-error.log last 30 lines:
/home/szlk/.pm2/logs/homelabs-portal-out.log last 30 lines:
0|homelabs | 2025-10-20T04:24:34: 
0|homelabs | 2025-10-20T04:24:34: > homelabs-portal@1.0.0 start
0|homelabs | 2025-10-20T04:24:34: > next start
0|homelabs | 2025-10-20T04:24:34: 
0|homelabs | 2025-10-20T04:24:34:    ▲ Next.js 15.5.5
0|homelabs | 2025-10-20T04:24:34:    - Local:        http://localhost:3000
0|homelabs | 2025-10-20T04:24:34:    - Network:      http://192.168.2.85:3000
0|homelabs | 2025-10-20T04:24:34: 
0|homelabs | 2025-10-20T04:24:34:  ✓ Starting...
0|homelabs | 2025-10-20T04:24:34:  ✓ Ready in 549ms


2️⃣  检查端口监听情况:
-----------------------------------
应用端口 3001:
⚠️  端口3001未监听

Nginx端口 3333:
LISTEN 0      511          0.0.0.0:3333      0.0.0.0:*    users:(("nginx",pid=148814,fd=15),("nginx",pid=148813,fd=15),("nginx",pid=140935,fd=15))
LISTEN 0      511             [::]:3333         [::]:*    users:(("nginx",pid=148814,fd=16),("nginx",pid=148813,fd=16),("nginx",pid=140935,fd=16))

3️⃣  检查Nginx状态和配置:
-----------------------------------
● nginx.service - A high performance web server and a reverse proxy server
     Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
     Active: active (running) since Mon 2025-10-20 03:30:09 UTC; 55min ago
       Docs: man:nginx(8)
   Main PID: 140935 (nginx)
      Tasks: 3 (limit: 2236)
     Memory: 5.5M
        CPU: 73ms
     CGroup: /system.slice/nginx.service
             ├─140935 "nginx: master process /usr/sbin/nginx -g daemon on; master_process on;"

Nginx配置测试:
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful

4️⃣  检查Nginx配置内容:
-----------------------------------
找到Nginx配置文件:
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
--
        proxy_pass http://localhost:3001;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        proxy_pass http://localhost:3001;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 日志配置

5️⃣  测试本地访问:
-----------------------------------
测试应用端口 3001:
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
curl: (7) Failed to connect to localhost port 3001 after 0 ms: Connection refused

测试Nginx端口 3333:
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0   166    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
HTTP/1.1 502 Bad Gateway
Server: nginx/1.18.0 (Ubuntu)
Date: Mon, 20 Oct 2025 04:25:43 GMT
Content-Type: text/html
Content-Length: 166
Connection: keep-alive


6️⃣  检查应用日志 (最近30行):
-----------------------------------
=== PM2日志 ===

=== 应用错误日志 ===

=== 最近的综合日志 ===

7️⃣  检查环境变量配置:
-----------------------------------
⚠️  环境配置文件不存在

8️⃣  检查PostgreSQL数据库连接:
-----------------------------------
     datname     
-----------------
 homelabs_portal
(1 row)


9️⃣  检查进程详情:
-----------------------------------
szlk      149897  0.0  0.0   2892   972 ?        S    04:24   0:00 sh -c next start
szlk      149898  1.5  8.6 13359972 175548 ?     Sl   04:24   0:01 next-server (v15.5.5)

==========================================
✅ 检查完成
==========================================

💡 快速修复建议:
  - 如果PM2显示stopped: pm2 restart homelabs-portal
  - 如果端口未监听: 检查应用日志中的错误
  - 如果Nginx未运行: sudo systemctl start nginx
  - 查看实时日志: pm2 logs homelabs-portal