# 部署日志

## 2025-10-20 部署问题修复历程

### 问题1: Nginx配置上传失败 ✅
- ❌ 错误: `scp: dest open "/opt/homelabs/nginx-auto.conf": No such file or directory`
- 🔧 原因: 目录创建在文件上传之后
- ✅ 修复: 在上传前先创建部署目录

### 问题2: 备份目录创建失败 ✅
- ❌ 错误: `rsync: mkdir "/opt/homelabs_backup_20251020_033728" failed: Permission denied (13)`
- 🔧 原因: `/opt/` 目录需要sudo权限才能创建子目录
- ✅ 修复: 使用sudo创建备份目录并chown给SSH用户

### 问题3: Bash语法错误 ✅
- ❌ 错误: `syntax error near unexpected token '('`
- 🔧 原因: 清理旧备份的echo语句中嵌套了过于复杂的命令替换和引号转义
- ✅ 修复: 先将计数存入变量再输出

### 问题4: PostgreSQL配置SQL语法错误 ✅
- ❌ 错误: `ERROR: syntax error at or near "$"`
- 🔧 原因: 
  * 外层heredoc使用单引号 `<< 'POSTGRES_SETUP'` 阻止变量替换
  * 内层heredoc也使用单引号 `<<'EOSQL'` 阻止变量替换
  * 导致 `$DB_NAME`、`$DB_USER` 等变量作为字面量传给SQL
- 🐛 问题代码: 
  ```bash
  ssh ... << 'POSTGRES_SETUP'  # ❌ 单引号阻止变量展开
    sudo psql <<'EOSQL'         # ❌ 单引号阻止变量展开
      ... $DB_NAME ...          # 变量无法展开
  ```
- ✅ 修复方案:
  * 改用 `psql -c` 直接执行SQL命令，避免heredoc嵌套
  * 使用单引号包裹SSH命令块，让变量在远程服务器展开
  * 分步执行：创建用户 → 创建数据库 → 授予权限
  * 使用 `'"'"'` 技巧在单引号字符串中插入单引号
  * 添加容错机制和状态检查

---

# 后续部署日志将记录在此
